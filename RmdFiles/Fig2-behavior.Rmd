---
title: "Figure 2: Behavior Data Analysis"
author: "Rayna M Harris"
date: "January 14, 2017"
output:
  md_document:
    variant: markdown_github

---
This R Markdown document will create the behavioral analysis figures

```{r setup, message=F}
## load libraries 
library(magrittr) ## to use the weird pipe
library(ggplot2) ## for awesome plots!
library(gplots) ##for making awesome plots
library(cowplot) ## for some easy to use themes
library(tidyr) ## for respahing data
library(plyr) ## for renmaing factors
library(dplyr) ## for filtering and selecting rows
library(reshape2) ## for melting dataframe
library(pheatmap) ## for pretty heat maps
library(car) ## for statistics
library(relaimpo) ## for linear model predictions

## load functions 
source("functions_behavior.R")

## set output file for figures 
knitr::opts_chunk$set(fig.path = '../figures/Fig2/')
```

```{r data, message=F}
## read intermediate data (raw data from video tracker program analyzed in matlab)
behavior <- read.csv("../data/01_behaviordata.csv", header = T)

## relevel factors
behavior$APA <- factor(behavior$APA, levels = c("Yoked", "Same", "Conflict"))
behavior$APA2 <- factor(behavior$APA2, levels = c("YokedSame", "YokedConflict","Same", "Conflict"))

## create a log transformed time for first entrance
behavior$Time1stEntrLog <- log(behavior$Time1stEntr)

## subset to view just the data from the retention session
retention <- behavior %>% filter(TrainSessionCombo == "Retention") %>%  droplevels() 
```

```{r summary stats}
behaviorsummary <- summarise(group_by(behavior, APA), m = mean(Time1stEntr), se = sd(Time1stEntr)/sqrt(length(Time1stEntr)))
A <- ggplot(behaviorsummary, aes(x=APA, y=m, color=APA)) + 
    geom_errorbar(aes(ymin=m-se, ymax=m+se, color=APA), width=.1) +
    geom_point(size = 2) +
    scale_y_continuous(name="Time to First Entrance (s)") +
    scale_x_discrete(name=NULL) +
  theme_cowplot(font_size = 16, line_size = 1) +
  background_grid(major = "xy", minor = "none") +
  scale_color_manual(values = colorvalAPA) +
  theme(legend.position="none") 

behaviorsummary <- summarise(group_by(behavior, APA), m = mean(NumEntrances), se = sd(NumEntrances)/sqrt(length(NumEntrances)))

B <- ggplot(behaviorsummary, aes(x=APA, y=m, color=APA)) + 
    geom_errorbar(aes(ymin=m-se, ymax=m+se), width=.1) +
    geom_point(size = 2) +
    scale_y_continuous(name="Number of Entrances") +
    scale_x_discrete(name=NULL) +
  theme_cowplot(font_size = 16, line_size = 1) +
  background_grid(major = "xy", minor = "none") +
  scale_color_manual(values = colorvalAPA) +
  theme(legend.position="none")

plot_grid(A,B, nrow=1, labels=c("A", "B"))
meansem <- plot_grid(A,B, nrow=1, labels=c("A", "B"))

pdf(file="../figures/Fig1/meansem.pdf", width=6, height=3)
plot(meansem)
dev.off()

```

## Behavior Data Visualization 

### Box Plots
The next three plots show that spatially trained show increased latency to enter the shock zone (A) and avoid the shock zone (B) on the retention session when compared to yoked aniamals that were not spatially trained. A closer inspection of the behavior of each individual shows that trained mice spend most of their time opposite of the shock zone (C), with the exception of the conflict trained mice on conflict session 1 the the shock zone is rotated 180C.

```{r avoidancebehavior}
A <- myboxplotnolegend(data = behavior,xcol = "TrainSessionCombo", 
                ycol = "Time1stEntr", colorcode = "APA", session ="Retention",
                yaxislabel="\n Time to 1st Entrance (s)")

B <- myboxplot(data = behavior, xcol = "TrainSessionCombo", 
                ycol = "NumEntrances", colorcode = "APA", 
                session ="Retention",
                yaxislabel="\n Number of Entrances") 

plot_grid(A,B, nrow=1, rel_widths=c(0.45, 0.55), labels=c("A", "B"))
boxplot <- plot_grid(A,B, nrow=1, rel_widths=c(0.45, 0.55), labels=c("A", "B"))

pdf(file="../figures/Fig1/boxplot.pdf", width=6, height=3)
plot(boxplot)
dev.off()


C <- onebehavior(data=behavior, xcol="TrainSessionComboNum", ycol="pTimeOPP",
                  yaxislabel=" Proportion of time spent\n opposite the shock zone",
                  colorcode="APA")

pdf(file="../figures/Fig1/onebehavior.pdf", width=6, height=4)
plot(C)
dev.off()

```

### Heatmap
The next image shows how all the behaviors measured change over time. Here, the data are normalized to a z-score with more positive values shown in red and negative values show in blue. Each row contains value for each behavioral measurement. Each column is the average value for a group of animals as specific by APA group (purple, orange, brown) and training session (from white to black according to increasing time spend in the active place avoidance group). 

```{r heatmap,  message=FALSE, results='hide'}
## see the makesessionheatmap documentataion for data tidying and plot specifications
makesessionheatmap(behavior)
```


### Principle component analysis (PCA)
Given the correlational structure of the data, I next reduced the dimentionality with a PCA anlaysis. You can see that PC1 speparates trained and untraned animals (D,E) but neither PC2 (D) nor PC3 (E) separate same and conflict aniamls. Elipses show 95% confidence interval.

```{r PCA}
source("functions_behavior.R")

scoresdf <- makepcadf(behavior) #create the 
makepcaplot(data=scoresdf,xcol="PC1",ycol="PC2",colorcode="APA")
makepcaplot(data=scoresdf,xcol="PC1",ycol="PC3",colorcode="APA")
makepcaplot(data=scoresdf,xcol="PC2",ycol="PC3",colorcode="APA")

loadings <- makepcaloadingsdf(behavior)
```


### stats
```{r statistics}
##  Leven Test
## is variance signficant? Yes. Not conna be able to use anova
leveneTest(Time1stEntr~APA, data=retention)
## group  2  5.3551 0.01005 *  ==> significant, need to transform
leveneTest(Time1stEntrLog~APA, data=retention)
## group  2    0.23 0.7959  ==>  yeah, no longer signfifcant. can do anova
leveneTest(NumEntrances~APA, data=retention)
## group  2  0.8582 0.4337  ==> not significant, can do anova

##  one way anova on retention
avoTime <- aov(retention$Time1stEntrLog ~ retention$APA)
summary(avoTime)
TukeyHSD(avoTime)

avoNum <- aov(retention$NumEntrances ~ retention$APA)
summary(avoNum)
TukeyHSD(avoNum)

### liear model
mymodel <- lm(behavior$Time1stEntrLog ~ behavior$APA * behavior$TrainSessionCombo)
qqnorm(mymodel$residuals)
qqline(mymodel$residuals,col='red')
plot(mymodel$fitted.values,mymodel$residuals)
abline(h=0, col='red')
summary(mymodel)

mymodel2 <- lm(behavior$NumEntrances ~ behavior$APA * behavior$TrainSessionCombo)
qqnorm(mymodel2$residuals)
qqline(mymodel2$residuals,col='red')
plot(mymodel2$fitted.values,mymodel2$residuals)
abline(h=0, col='red')
summary(mymodel2)

## predictions
(m1relaimpo <- calc.relimp(mymodel, type = "lmg", rela = TRUE))
```