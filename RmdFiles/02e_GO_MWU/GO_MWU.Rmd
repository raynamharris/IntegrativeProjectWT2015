---
title: "GO_MWU.Rmd"
author: "Rayna M Harris"
date: August 27, 2017
output: md_document
---

## Summary 

#### From Mikhail V. Matz https://github.com/z0on/GO_MWU

GO_MWU uses continuous measure of significance (-log(p-value)) to identify GO categories that are significantly enriches with either up- or down-regulated genes. The advantage - no need to impose arbitrary significance cutoff.

On the plot, different fonts are used to indicate significance and color indicates enrichment according to treatment group. The tree on the plot is hierarchical clustering of GO categories based on shared genes. Categories with no branch length between them are subsets of each other. The fraction next to GO category name indicates the fracton of "good" genes in it; "good" genes being the ones exceeding the arbitrary absValue cutoff (option in results <- gomwuPlot). For Fisher's based test, specify absValue=0.5. This value does not affect statistics and is used for plotting only.

If the measure is binary (0 or 1) the script will perform a typical "GO enrichment" analysis based Fisher's exact test: it will show GO categories over-represented among the genes that have 1 as their measure. No colors are shown for binary measure analysis.

NOTES: This program drains memory and creates some very large intermediate files, especially for the biological process catagory. First, I run the stats from the command line to make sure its working. Once I've generated the temp files, I comment out then stats portions and recreate the plots by kniting the rmd file. 

```{r setup}
library(ape) # For GO analysis
source("gomwu.functions.R")
library(reshape2) # for splitting column

# set output file for figures 
knitr::opts_chunk$set(fig.path = '../../figures/02e_RNAseq_GO/')
```


## DG consistent vs. yoked

```{r DGconsistentyoked, warning=F, message=F, echo=F}
# input files
input="DGconsistentyoked.csv" 
goAnnotations="goAnnotations.tab" 
goDatabase="go.obo" 
goDivision="MF" # either MF, or BP, or CC

# Calculating stats
#gomwuStats(input, goDatabase, goAnnotations, goDivision,
#  perlPath="perl", 
#	largest=0.1,  
#	smallest=5,   
#	clusterCutHeight=0.25)  

# Data viz
results <- results <- gomwuPlot(input,goAnnotations,goDivision,
  absValue=1,
	level1=0.05, 
	level2=0.05, 
	level3=0.000000000000000000000000001, 
	txtsize=2,    
	treeHeight=0.5, 
  colors=c("#404040","#ca0020","#404040","#ca0020") 
)

results$rownames <- row.names(results)
y <- colsplit(results$rownames," ",c("goodgenes","GOterm"))
results <- cbind(results, y)
results$rownames <- NULL
results$Punch <- "DG"

write.csv(results, file = "GO_DGconsistentyoked.csv", row.names = T)
```


## CA3 consistent yoked

```{r CA3confictconsistent, warning=F, message=F, echo=F}
# input files
input="CA3conflictconsistent.csv" 
goAnnotations="goAnnotations.tab" 
goDatabase="go.obo" 
goDivision="MF" # either MF, or BP, or CC

# Calculating stats
#gomwuStats(input, goDatabase, goAnnotations, goDivision,
#  perlPath="perl", 
#	largest=0.1,  
#	smallest=5,   
#	clusterCutHeight=0.25)  

# Data viz
results <- gomwuPlot(input,goAnnotations,goDivision,
	absValue=1, 
	level1=0.05, 
	level2=0.05, 
	level3=0.0000000000000000000001, 
	txtsize=2,    
	treeHeight=0.5, 
  colors=c("#ca0020","#f4a582","#ca0020","#f4a582") 
)

results$rownames <- row.names(results)
y <- colsplit(results$rownames," ",c("goodgenes","GOterm"))
results <- cbind(results, y)
results$rownames <- NULL
results$Punch <- "CA3"

write.csv(results, file = "GO_CA3conflictconsistent.csv.csv", row.names = TRUE)
```



## CA1 consistent yoked

```{r CA1consistentyoked, warning=F, message=F, echo=F}
# input files
input="CA1consistentyoked.csv" 
goAnnotations="goAnnotations.tab" 
goDatabase="go.obo" 
goDivision="MF" # either MF, or BP, or CC

# Calculating stats
#gomwuStats(input, goDatabase, goAnnotations, goDivision,
#  perlPath="perl", 
#	largest=0.1,  
#	smallest=5,   
#	clusterCutHeight=0.25)  

# Data viz
results <- results <- gomwuPlot(input,goAnnotations,goDivision,
	absValue=1, 
	level1=0.01, 
	level2=0.01, 
	level3=0.00000000000000000000000001, 
	txtsize=2,    
	treeHeight=0.5, 
  colors=c("grey20","red","grey20","red") 
)

results$rownames <- row.names(results)
y <- colsplit(results$rownames," ",c("goodgenes","GOterm"))
results <- cbind(results, y)
results$rownames <- NULL
results$Punch <- "CA1"

write.csv(results, file = "GO_CA1consistentyoked.csv", row.names = TRUE)

```




## DG conflict vs consistent 

```{r DGconflictconsistent, warning=F, message=F, echo=F}
# input files
input="DGconflictconsistent.csv" 
goAnnotations="goAnnotations.tab" 
goDatabase="go.obo" 
goDivision="MF" # either MF, or BP, or CC

# Calculating stats
#gomwuStats(input, goDatabase, goAnnotations, goDivision,
#  perlPath="perl", 
#	largest=0.1,  
#	smallest=5,   
#	clusterCutHeight=0.25) 

# Data viz
results <- results <- gomwuPlot(input,goAnnotations,goDivision,
	absValue=1, 
	level1=0.1, 
	level2=0.01, 
	level3=0.01, 
	txtsize=2,    
	treeHeight=0.5, 
  colors=c("red","lightsalmon","red","lightsalmon")
)

results$rownames <- row.names(results)
y <- colsplit(results$rownames," ",c("goodgenes","GOterm"))
results <- cbind(results, y)
results$rownames <- NULL
results$Punch <- "DG"

write.csv(results, file = "GO_DGconflictconsistent.csv", row.names = TRUE)
```


## CA3 conflict consistent 

```{r CA3conflictconsistent, warning=F, message=F, echo=F}
input="CA3conflictconsistent.csv" 
goAnnotations="goAnnotations.tab" 
goDatabase="go.obo" 
goDivision="MF" # either MF, or BP, or CC

# Calculating stats
#gomwuStats(input, goDatabase, goAnnotations, goDivision,
# perlPath="perl", 
# largest=0.1,  
# smallest=5,   
# clusterCutHeight=0.25)  


# Data viz
results <- results <- gomwuPlot(input,goAnnotations,goDivision,
	absValue=1, 
	level1=0.05, 
	level2=0.05, 
	level3=0.0000000000000000000000001, 
	txtsize=2,    
	treeHeight=0.5, 
  colors=c("#ca0020","#f4a582","#ca0020","#f4a582")
)

results$rownames <- row.names(results)
y <- colsplit(results$rownames," ",c("goodgenes","GOterm"))
results <- cbind(results, y)
results$rownames <- NULL
results$Punch <- "CA3"

write.csv(results, file = "GO_CA3conflictconsistent.csv", row.names = TRUE)
```



## CA1 consistent yoked

```{r CA1consistentyoked, warning=F, message=F, echo=F}
# input files
input="CA1consistentyoked.csv" 
goAnnotations="goAnnotations.tab" 
goDatabase="go.obo" 
goDivision="MF" # either MF, or BP, or CC


# Calculating stats
#gomwuStats(input, goDatabase, goAnnotations, goDivision,
#  perlPath="perl", 
#	largest=0.1,  
#	smallest=5,   
#	clusterCutHeight=0.25) 

# Data viz
results <- results <- gomwuPlot(input,goAnnotations,goDivision,
	absValue=1, 
	level1=0.01, 
	level2=0.01, 
	level3=0.0000000000000000000000000000000000001,  
	txtsize=2,    
	treeHeight=0.5, 
  colors=c("#404040","#ca0020","#404040","#ca0020")
)

results$rownames <- row.names(results)
y <- colsplit(results$rownames," ",c("goodgenes","GOterm"))
results <- cbind(results, y)
results$rownames <- NULL
results$Punch <- "CA1"

write.csv(results, file = "GO_CA1conflictconsistent.csv", row.names = TRUE)
```


## DG yoked vs. yoked

```{r DGyokedyoked, warning=F, message=F, echo=F}
# input files
input="DGyokedyoked.csv" 
goAnnotations="goAnnotations.tab" 
goDatabase="go.obo" 
goDivision="MF" # either MF, or BP, or CC

# Calculating stats
#gomwuStats(input, goDatabase, goAnnotations, goDivision,
#  perlPath="perl", 
#	largest=0.1,  
#	smallest=5,   
#	clusterCutHeight=0.25) 

# Data viz
results <- gomwuPlot(input,goAnnotations,goDivision,
	absValue=1, 
	level1=0.1, 
	level2=0.01, 
	level3=0.01,  
	txtsize=2,    
	treeHeight=0.5, 
  colors=c("grey20","grey60","grey20","grey60")
)

results$rownames <- row.names(results)
y <- colsplit(results$rownames," ",c("goodgenes","GOterm"))
results <- cbind(results, y)
results$rownames <- NULL
results$Punch <- "DG"

write.csv(results, file = "GO_DGyokedyoked.csv", row.names = TRUE)
```


## CA3 yoked vs. yoked

```{r CA3yokedyoked, warning=F, message=F, echo=F}
# input files
input="CA3yokedyoked.csv" 
goAnnotations="goAnnotations.tab" 
goDatabase="go.obo" 
goDivision="MF" # either MF, or BP, or CC

# Calculating stats
#gomwuStats(input, goDatabase, goAnnotations, goDivision,
#  perlPath="perl", 
#	largest=0.1,  
#	smallest=5,   
#	clusterCutHeight=0.25) 

# Data viz
results <- gomwuPlot(input,goAnnotations,goDivision,
	absValue=1, 
	level1=0.01, 
	level2=0.01, 
	level3=0.00000000000001,  
	txtsize=2,    
	treeHeight=0.5, 
  colors=c("grey20","grey60","grey20","grey60")
)

results$rownames <- row.names(results)
y <- colsplit(results$rownames," ",c("goodgenes","GOterm"))
results <- cbind(results, y)
results$rownames <- NULL
results$Punch <- "CA3"
write.csv(results, file = "GO_CA3yokedyoked.csv", row.names = TRUE)

```



## CA1 yoked vs. yoked

```{r CA1yokedyoked, warning=F, message=F, echo=F}
# input files
input="CA1yokedyoked.csv" 
goAnnotations="goAnnotations.tab" 
goDatabase="go.obo" 
goDivision="MF" # either MF, or BP, or CC

# Calculating stats
#gomwuStats(input, goDatabase, goAnnotations, goDivision,
#  perlPath="perl", 
#	largest=0.1,  
#	smallest=5,   
#	clusterCutHeight=0.25) 

# Data viz
results <- gomwuPlot(input,goAnnotations,goDivision,
	absValue=1, 
	level1=0.01, 
	level2=0.01, 
	level3=0.00000000000000000000000000000000000001, 
	txtsize=2,    
	treeHeight=0.5, 
  colors=c("grey20","grey60","grey20","grey60")
)


results$rownames <- row.names(results)
y <- colsplit(results$rownames," ",c("goodgenes","GOterm"))
results <- cbind(results, y)
results$rownames <- NULL
results$Punch <- "CA1"

write.csv(results, file = "GO_CA1yokedyoked.csv", row.names = TRUE)

```



##  GO summary

Bash comands to combine files

~~~
head -1 GO_DGyokedyoked.csv > GO_analysis.csv  #create new analysis by copying the header of a single file`
cat GO_*.csv | grep -v 'pval' >> GO_analysis.csv # send the contents of each file through grep to remove the header and into the analysis file`
~~~

This will print the number of times a GO term appeared in any of the 9 two-way comparaisons. 
```{r G0summary}
library(reshape2)
GOterms <- read.csv('GO_analysis.csv', colClasses=c("NULL", NA, "NULL",NA, "NULL",NA, NA))
GOterms$GOterm <- as.character(GOterms$GOterm)
GOterms$group <- as.factor(paste(GOterms$Punch,GOterms$color,sep="_"))
GOterms$Punch <- NULL  
GOterms$color <- NULL
GOtermsWide <- dcast(GOterms, GOterm ~ group , value.var = "pval")
GOtermsWide$rowsums <- rowSums(GOtermsWide[, -1])
GOtermsWide <- GOtermsWide[c(1,13,2:12)]
GOtermsWide <- GOtermsWide[order(-GOtermsWide$rowsums),] 
rownames(GOtermsWide) <- c() #omit rownames
GOtermsWide[c(1,2)]
```