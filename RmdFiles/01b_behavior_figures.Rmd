---
title: "Behavior Data Analysis"
author: "Rayna M Harris"
date: "January 14, 2017"
output:
  md_document:
    variant: markdown_github
---

```{r setup, message=F}
library(ggplot2) ## for awesome plots!
library(cowplot) ## for some easy to use themes
library(dplyr) ## for filtering and selecting rows
library(factoextra)  ##pca with vectors
library(car) ## stats

## load functions 
source("functions_behavior.R")
source("figureoptions.R")

## set output file for figures 
knitr::opts_chunk$set(fig.path = '../figures/01_behavior/')
```


```{r data, message=F}
behavior <- read.csv("../data/01a_behavior.csv", header = T)
retention <- read.csv("../data/01a_retention.csv", header = T) 
behaviorsummaryTime <- read.csv("../data/01a_behaviorsummaryTime.csv", header = T)
behaviorsummaryNum <- read.csv("../data/01a_behaviorsummaryNum.csv", header = T)
scaledaveragedata <- read.csv("../data/01a_scaledaveragedata.csv", header = T, row.names = 1)
columnannotations <- read.csv("../data/01a_columnannotations.csv", header = T, row.names = 1)
scoresdf <- read.csv("../data/01a_scoresdf.csv", header = T)
rotationdf <- read.csv("../data/01a_rotationdf.csv", header = T, row.names = 1)
behaviormatrix <- read.csv("../data/01a_behaviormatrix.csv", header = T, row.names = 1)
```

```{r setfactorlevels}
behavior$APA <- factor(behavior$APA, levels = c("control", "consistent", "conflict"))
behaviorsummaryTime$APA <- factor(behaviorsummaryTime$APA, levels = c("control", "consistent", "conflict"))
behaviorsummaryNum$APA <- factor(behaviorsummaryNum$APA, levels = c("control", "consistent", "conflict"))
scoresdf$APA <- factor(scoresdf$APA, levels = c("control", "consistent", "conflict"))
```

```{r avoidancebehavior}
A <- ggplot(behaviorsummaryTime, aes(x=APA, y=m, color=APA)) + 
    geom_errorbar(aes(ymin=m-se, ymax=m+se, color=APA), width=.1) +
    geom_point(size = 2) +
    scale_y_continuous(name="Time to First Entrance (s)") +
    scale_x_discrete(name=NULL) +
  theme_cowplot(font_size = 14, line_size = 1) +
  background_grid(major = "xy", minor = "none") +
  scale_color_manual(values = colorvalAPA) +
theme(legend.justification=c(1,0), legend.position=c(1,0), legend.title = element_blank()) + 
theme(axis.ticks = element_blank(), axis.text.x = element_blank())

B <- ggplot(behaviorsummaryNum, aes(x=APA, y=m, color=APA)) + 
    geom_errorbar(aes(ymin=m-se, ymax=m+se), width=.1) +
    geom_point(size = 2) + 
    scale_y_continuous(name="Number of Entrances") +
    scale_x_discrete(name=NULL) +
  theme_cowplot(font_size = 14, line_size = 1) +
  background_grid(major = "xy", minor = "none") +
  scale_color_manual(values = colorvalAPA) +
theme(legend.justification=c(1,1), legend.position=c(1,1), legend.title = element_blank()) + theme(axis.ticks = element_blank(), axis.text.x = element_blank())


plot_grid(A,B, nrow=1, labels=c("A", "B"), rel_widths = c(1, 1))
meansem <- plot_grid(A,B, nrow=1, labels=c("A", "B"), rel_widths = c(1, 1))


pdf(file="../figures/01_behavior/avoidancebehavior-1.pdf", width=6, height=3)
plot(meansem)
dev.off()


A <- myboxplotlegendtop(data = behavior,xcol = "TrainSessionCombo", 
                ycol = "Time1stEntr", colorcode = "APA", session ="Retention",
                yaxislabel="\n Time to 1st Entrance (s)")

B <- myboxplotlegendbottom(data = behavior, xcol = "TrainSessionCombo", 
                ycol = "NumEntrances", colorcode = "APA", 
                session ="Retention",
                yaxislabel="\n Number of Entrances") 

plot_grid(A,B, nrow=1,  labels=c("A", "B"))
boxplot <- plot_grid(A,B, nrow=1, labels=c("A", "B"))

pdf(file="../figures/01_behavior/avoidancebehavior-2.pdf", width=8.5, height=3)
plot(boxplot)
dev.off()

onebehavior(data=behavior, xcol="TrainSessionComboNum", ycol="pTimeOPP",
                  yaxislabel=" Proportion of time spent\n opposite the shock zone",
                  colorcode="APA")

timeopp <- onebehavior(data=behavior, xcol="TrainSessionComboNum", ycol="pTimeOPP",
                  yaxislabel=" Proportion of time spent\n opposite the shock zone",
                  colorcode="APA")

pdf(file="../figures/01_behavior/avoidancebehavior-3.pdf", width=6, height=4)
plot(timeopp)
dev.off()

## hab to retest
habtoretest <- behavior %>% 
  filter(TrainSessionCombo %in% c("Hab", "Retest", "T1", "T3", "T2")) %>% droplevels()
onebehaviorhabtoretest(data=habtoretest, xcol="TrainSessionComboNum", ycol="pTimeOPP",
                  yaxislabel=" Proportion of time spent\n opposite the shock zone",
                  colorcode="APA")
## c4 to rentetion
c4toretention <- behavior %>% 
  filter(TrainSessionCombo %in% c("Retention", "T4_C1", "T5_C2", "T6_C3")) %>% droplevels()
onebehaviorc4toRentention(data=c4toretention, xcol="TrainSessionComboNum", ycol="pTimeOPP",
                  yaxislabel=" Proportion of time spent\n opposite the shock zone",
                  colorcode="APA")


levels(behavior$TrainSessionCombo)
```

### Heatmap
The next image shows how all the behaviors measured change over time. Here, the data are normalized to a z-score with more positive values shown in red and negative values show in blue. Each row contains value for each behavioral measurement. Each column is the average value for a group of animals as specific by APA group (purple, orange, brown) and training session (from white to black according to increasing time spend in the active place avoidance group). 

```{r heatmap,  message=FALSE, results='hide'}
library(superheat)

superheat(scaledaveragedata,
          # change the size of the labels
          left.label.size = 0.3, 
          bottom.label.size = 0.4,
          bottom.label.text.angle = 90, 
          # cluster rows and add dendrogram
          pretty.order.cols = TRUE,
          n.clusters.rows = 3,
          left.label = 'variable',
          # change color
          heat.pal = c("Deep Sky Blue 3", "white", "red"),
          # These two lines help you darken the color
          heat.lim = c(-1.5, 1.5), 
          extreme.values.na = FALSE)



scaledaveragedatatranposed <- t(scaledaveragedata)

superheat(scaledaveragedatatranposed,
          # change the size of the labels
          left.label.size = 0.25, 
          bottom.label.size = 0.45,
          bottom.label.text.angle = 90, 
          # cluster rows and add dendrogram
          pretty.order.cols = TRUE,
          n.clusters.rows = 4,
          left.label = 'variable',
          # change color
          heat.pal = c("Deep Sky Blue 3", "white", "red"),
          # These two lines darken the color
          heat.lim = c(-1.5, 1.5), 
          extreme.values.na = FALSE)

superheat(scaledaveragedatatranposed,
          # change the size of the labels
          left.label.size = 0.25, 
          bottom.label.size = 0.45,
          bottom.label.text.angle = 90, 
          # cluster rows and add dendrogram
          pretty.order.cols = TRUE,
          n.clusters.rows = 3,
          left.label = 'variable',
          # change color
          #heat.pal = c("Deep Sky Blue 3", "white", "red"),
          # These two lines darken the color
          heat.lim = c(-1.5, 1.5), 
          extreme.values.na = FALSE)

```


### Principle component analysis (PCA)
Given the correlational structure of the data, I next reduced the dimentionality with a PCA anlaysis. You can see that PC1 speparates trained and untraned animals (D,E) but neither PC2 (D) nor PC3 (E) separate same and conflict aniamls. Elipses show 95% confidence interval.

```{r PCA}
## pca anlysis
behaviormatrix %>% 
  scale() %>%                 # scale to 0 mean and unit variance
  prcomp() ->                 # do PCA
  pca                         # store result as `pca`
percent <- 100*pca$sdev^2/sum(pca$sdev^2)
perc_data <- data.frame(percent=percent, PC=1:length(percent))
ggplot(perc_data, aes(x=PC, y=percent)) + 
  geom_bar(stat="identity") + 
  geom_text(aes(label=round(percent, 2)), size=4, vjust=-.5) + 
  xlim(0, 10)


makepcaplot(data=scoresdf,xcol="PC1",ycol="PC2",colorcode="APA")

## statistics
aov1 <- aov(PC1 ~ APA, data=scoresdf)
summary(aov1) # p = 2.53e-14
TukeyHSD(aov1, which = "APA") # p<< 0.001 for both control comparisions

aov2 <- aov(PC2 ~ APA, data=scoresdf)
summary(aov2) # p = 0.0906
TukeyHSD(aov2, which = "APA") # p = 0.0852578 for conflict

aov3 <- aov(PC3 ~ APA, data=scoresdf)
summary(aov3) # p = 0.0633
TukeyHSD(aov3, which = "APA") # p = 0.0557503 for conflict

aov6 <- aov(PC6 ~ APA, data=scoresdf)
summary(aov6) # p = 0.0226
TukeyHSD(aov6, which = "APA") # p = 0.0175577 for conflict


lm1 <- lm(PC1~APA, data=scoresdf)
summary(lm1)

lm16 <- lm(PC1+PC6~APA, data=scoresdf)
summary(lm16)

makepcaplot(data=scoresdf,xcol="PC1",ycol="PC3",colorcode="APA")
makepcaplot(data=scoresdf,xcol="PC1",ycol="PC4",colorcode="APA")
makepcaplot(data=scoresdf,xcol="PC2",ycol="PC4",colorcode="APA")


makepcaplot(data=scoresdf,xcol="PC1",ycol="PC6",colorcode="APA")
## statistics
aov6 <- aov(PC6 ~ APA, data=scoresdf)
summary(aov6) # p = 0.0584 
TukeyHSD(aov6, which = "APA") # consistent-conflict p= 0.0175577




```

```{r fviz_pca}
res.pca <- prcomp(behaviormatrix,  scale = TRUE)
fviz_pca_var(res.pca, select.var = list(contrib = 8), axes = c(1, 2))
fviz_pca_var(res.pca, select.var = list(contrib = 8), axes = c(1, 6))
fviz_pca_var(res.pca, select.var = list(contrib = 8), axes = c(1, 9))
```

```{r otherpca}
library(ggfortify)
df <- behaviormatrix
autoplot(prcomp(df))
autoplot(prcomp(df), data = behavior, colour = 'APA', loadings = TRUE, loadings.label = TRUE, loadings.label.size = 5, scale = 0)

library(cluster)
autoplot(clara(behaviormatrix, 3))
autoplot(fanny(behaviormatrix, 2), frame = TRUE)
```

```{r wilkepca}
# capture the rotation matrix in a data frame
rotation_data <- rotationdf
# define a pleasing arrow style
arrow_style <- arrow(length = unit(0.05, "inches"),
                     type = "closed")
# now plot, using geom_segment() for arrows and geom_text for labels
ggplot(rotation_data) + 
  geom_segment(aes(xend=PC1, yend=PC2), x=0, y=0, arrow=arrow_style) + 
  geom_text(aes(x=PC1, y=PC2, label=variable), hjust=0, size=3, color='red')
```