---
title: "Search favorite gene Analysis"
output: md_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.path = '../figures/06_favegenes/', cache = T, cache.lazy = F)
```

```{r packages}
library(tidyverse)
library(cowplot)
library(corrr) # for easy correlations
library(Hmisc) # for correlations with pvalue

source("./figureoptions.R")
source("./functions_RNAseq.R")
```

## Sample information and PC1

```{r vsds}
# meta data
colData <- read_csv("../data/00_colData.csv")

geneids <- read_csv("../data/00_geneids.csv") %>% distinct(gene) %>% mutate(gene = toupper(gene))

# pca data
pca.Rn <- read_csv("../data/01_pca.all.csv") %>% 
  filter(trialNum == 9) %>%  
  select(ID:PC2) %>%
  left_join(colData) %>% drop_na() %>% select(ID, treatment, training, trialNum, Day, RNAseqID, subfield, PC1, PC2)
head(pca.Rn)

prepvsdforjoin <- function(pathtovsd, mysubfield){
  #read all count data
  vsd <- read_csv(pathtovsd) 
  vsd$gene <- vsd$X1
  vsd$gene <- toupper(vsd$gene)
  vsd <- vsd %>% arrange(gene) %>%  select(gene,everything())
  vsd <- as.data.frame(vsd)
  vsd$X1 <- NULL
  row.names(vsd) <- vsd$gene
  vsd$gene <- NULL
  vsd <- as.data.frame(t(vsd))

  vsd$RNAseqID <- row.names(vsd)
  vsd <- vsd %>%  select(RNAseqID, everything())
  vsd <- left_join(pca.Rn, vsd)  %>% drop_na()

  vsd$subfield <- factor(vsd$subfield, levels = levelssubfield)
  vsd$treatment <- factor(vsd$treatment, levels = levelstreatment)
  return(vsd)
}

vsdDG <- prepvsdforjoin("../data/03_DG_vsdtraining.csv")
vsdCA3 <- prepvsdforjoin("../data/03_CA3_vsdtraining.csv")
vsdCA1 <- prepvsdforjoin("../data/03_CA1_vsdtraining.csv")
```



```{r ARC}
printcortests <- function(mysubfield, df){
  print(mysubfield)
  print(cor.test(df$PC1, df$ARC, method = c("pearson")))
  print(cor.test(df$PC2, df$ARC, method = c("pearson")))
}

printcortests("DG", vsdDG)
printcortests("CA3", vsdCA3)
printcortests("CA1", vsdCA1)

plotcorrelation <- function(df, favegene, myPC){
  p <- ggplot(df, aes(x = favegene, y = myPC)) +
   geom_point(aes( color = treatment)) + 
   geom_smooth(method = "lm", color = "grey") +
   scale_color_manual(values = treatmentcolors) +
  theme_ms() +
   theme(legend.position = "none") +
    facet_wrap(~subfield) +
    labs(y = NULL, x = NULL)
  return(p)
}


p1 <- plotcorrelation(vsdDG, vsdDG$ARC, vsdDG$PC1) + labs(y = "PC1")
p2 <- plotcorrelation(vsdDG, vsdDG$ARC, vsdDG$PC2) + labs(y = "PC2")  + labs(x =  " ")
p3 <- plotcorrelation(vsdCA3, vsdCA3$ARC, vsdCA3$PC1) 
p4 <- plotcorrelation(vsdCA3, vsdCA3$ARC, vsdCA3$PC2)  + labs(x = "ARC expression")
p5 <- plotcorrelation(vsdCA1, vsdCA1$ARC, vsdCA1$PC1)
p6 <- plotcorrelation(vsdCA1, vsdCA1$ARC, vsdCA1$PC2)  + labs(x =  " ")

plot_grid(p1,p3,p5,p2,p4,p6, nrow = 2, labels = c("a","b", "c", " ", " ", " "), 
                  label_size = 8, rel_heights = c(0.45,0.575))

```

```{r PKCs, fig.height=9}

plotcorrelation2 <- function(df, favegene, myPC){
  p <- ggplot(df, aes(x = favegene, y = myPC)) +
   geom_point(aes( color = treatment)) + 
   geom_smooth(method = "lm", color = "grey") +
   scale_color_manual(values = treatmentcolors) +
  theme_ms() +
   theme(legend.position = "none",
         strip.text = element_blank()) +
    facet_wrap(~subfield) +
    labs(y = NULL, x = NULL)
  return(p)
}

printcortests1 <- function(mysubfield, df){
  print(mysubfield)
  print(cor.test(df$PRKCZ, df$PRKCI, method = c("pearson")))
  print(cor.test(df$PRKCZ, df$PRKCB, method = c("pearson")))
}

printcortests1("DG", vsdDG)
printcortests1("CA3", vsdCA3)
printcortests1("CA1", vsdCA1)


printcortests2 <- function(mysubfield, df){
  print(mysubfield)
  #print(cor.test(df$WWC1, df$PRKCI, method = c("pearson")))
  #print(cor.test(df$WWC1, df$PRKCB, method = c("pearson")))
  print(cor.test(df$WWC1, df$PRKCZ, method = c("pearson")))
}

printcortests2("DG", vsdDG)
printcortests2("CA3", vsdCA3)
printcortests2("CA1", vsdCA1)


p1 <- plotcorrelation2(vsdDG, vsdDG$PRKCZ, vsdDG$PRKCI) + labs(x = " ", y =  "PRKCI",
                                                             subtitle = "p = 0.12", title = "DG")
p2 <- plotcorrelation2(vsdDG,  vsdDG$PRKCZ, vsdDG$PRKCB) + labs(x = " ", y =  "PRKCB",
                                                             subtitle = "p = 0.75")

p3 <- plotcorrelation2(vsdCA3,  vsdCA3$PRKCZ, vsdCA3$PRKCI) + labs(x = "PRKCZ", y =  " ",
                                                             subtitle = "p = 0.51", title = "CA3")
p4 <- plotcorrelation2(vsdCA3,  vsdCA3$PRKCZ, vsdCA3$PRKCB) + labs(x = "PRKCZ", y =  " ",
                                                             subtitle = "p = 0.16")

p5 <- plotcorrelation2(vsdCA1,  vsdCA1$PRKCZ, vsdCA1$PRKCI) + labs(x = " ", y =  " ",
                                                             subtitle = "p = 0.53", title = "CA1")
p6 <- plotcorrelation2(vsdCA1,  vsdCA1$PRKCZ, vsdCA1$PRKCB) + labs(x = " ", y =  " ",
                                                             subtitle = "p = 0.52")

p11 <- plotcorrelation2(vsdDG, vsdDG$WWC1, vsdDG$PRKCI) + labs(x = " ", y =  "PRKCI",
                                                             subtitle = "p = 0.403")
p12 <- plotcorrelation2(vsdDG,  vsdDG$WWC1, vsdDG$PRKCB) + labs(x = " ", y =  "PRKCB",
                                                             subtitle = "p = 0.085")

p13 <- plotcorrelation2(vsdCA3,  vsdCA3$WWC1, vsdCA3$PRKCI) + labs(x = "WWC1", y =  " ",
                                                             subtitle = "p = 0.058")
p14 <- plotcorrelation2(vsdCA3,  vsdCA3$WWC1, vsdCA3$PRKCB) + labs(x = "WWC1", y =  " ",
                                                             subtitle = "p = 0.001" )
p15 <- plotcorrelation2(vsdCA1,  vsdCA1$WWC1, vsdCA1$PRKCI) + labs(x = " ", y =  " ",
                                                             subtitle = "p = 0.004")
p16 <- plotcorrelation2(vsdCA1,  vsdCA1$WWC1, vsdCA1$PRKCB) + labs(x = " ", y =  " ",
                                                             subtitle = "p = 0.385")



p24 <- plotcorrelation2(vsdDG,  vsdDG$WWC1, vsdDG$PRKCZ) + labs(x = " ", y =  "PRKCZ",
                                                             subtitle = "p = 0.380" )
p25 <- plotcorrelation2(vsdCA3,  vsdCA3$WWC1, vsdCA3$PRKCZ) + labs(x = "WWC1", y =  " ",
                                                             subtitle = "p = 0.176")
p26 <- plotcorrelation2(vsdCA1,  vsdCA1$WWC1, vsdCA1$PRKCZ) + labs(x = " ", y =  " ",
                                                             subtitle = "p = 0.4288")

plot_grid(p1,p3,p5,p2,p4,p6,
          p11,p13,p15,p12,p14,p16,
          p24,p25,p26,
          nrow = 5, rel_heights = c(1.1,1,1,1,1))
```


## Correlate ALL genes with PC1 and PC2

```{r makecorrrmat}
# Use `tail(names(vsd),10)` to see that last genes is "ZZZ3"
tail(names(vsdDG),10)

makecorrrmatrix <- function(df){
  forcorall <-  df %>% select(PC1:ZZZ3)
  corrrmat <- correlate(forcorall) 
  return(corrrmat)
}
```

```{r makecorrrmat1}
corrrDG <- makecorrrmatrix(vsdDG) 
```

```{r makecorrrmat2}
corrrCA3 <- makecorrrmatrix(vsdCA3) 
```

```{r makecorrrmat3}
corrrCA1 <- makecorrrmatrix(vsdCA1) 
```


## Top correlations with PC1 and their relationship with PC2

```{r corrr}
plotcorrrs <- function(df, mysubtitle){
  
 corrsTop <- df %>% 
  focus(PC1)  %>% 
  arrange(desc(PC1)) %>% 
  top_n(20)
  
  topcorrrs <- corrsTop$rowname

  p1 <- df %>% 
    focus(PC1, PC2, topcorrrs,  mirror = TRUE) %>% 
    focus(PC1, PC2) %>%
    mutate(rowname = reorder(rowname, PC1)) %>%
    ggplot(aes(rowname, PC1, fill = PC1)) +
     geom_col() + coord_flip() +
    scale_fill_gradient2(low = "#67a9cf",  high = "#ef8a62", midpoint = 0) +
    theme_ms() +
    theme(legend.position = "none") +
    #ylim(-1,1) +
    labs(x = NULL, y = "Correlation to PC1") +
    labs(subtitle = mysubtitle)
  
  p2 <- df %>% 
    focus(PC1, PC2, topcorrrs,  mirror = TRUE) %>% 
    focus(PC1, PC2) %>%
    mutate(rowname = reorder(rowname, PC1)) %>%
    ggplot(aes(rowname, PC2, fill = PC2)) +
     geom_col() + coord_flip() +
    scale_fill_gradient2(low = "#67a9cf",  high = "#ef8a62", midpoint = 0) +
    theme_ms() +
    theme(legend.position = "none") +
    #ylim(-1,1) +
    labs(x = NULL, y = "Correlation to PC2") +
    labs(subtitle = " ")

  p3 <- df %>% 
    focus(PC1, PC2, topcorrrs,  mirror = TRUE) %>% 
    replace(., is.na(.), 1) %>% 
    network_plot.cor_df(colors = c("#67a9cf", "white", "#ef8a62"),
               min_cor = .7, curved = F, legend = T,
               repel = TRUE) + 
    theme(legend.position = "right") +
    labs(subtitle = " ")
  
  p4 <- df %>% 
    focus(PC1, PC2, topcorrrs,  mirror = TRUE) %>% 
    replace(., is.na(.), 0) %>% 
    rearrange() %>% 
    rplot()
  
  p12 <- plot_grid(p1,p2,  nrow = 1)
  p34 <- plot_grid(p3,p4,  nrow = 1)
  p1234 <- plot_grid(p12,p34,  nrow = 2)
  
  
  return(p1234)
}

plotcorrrs(corrrDG, "DG")
plotcorrrs(corrrCA3, "CA3")
plotcorrrs(corrrCA1, "CA1")
```

```{r candidategenes}
classicmemgenes <- c("PRKCZ", "WWC1", "PRKCI", "PRKCB",
                "NSF", "GRIA2", "PIN1", "IGF2", "CAMK2A")

ACTINngenes <- c( "LAMA1", "LAMB1", "LAMC1", "TNC", "TNXB", "TNR",
                "GABRA1", "PTPRS", "PNN", "EGFR")

stabilizationgenes <- c("LIMK1","CFL1", "ROCK2")

astrocyticgenes <- c("ALDH1A1", "ALDH1L1", "ALDH1L2", 
                     "SLC1A2", "GFAP", "GJB6", "FGFR3", "AQP4", "ALDOC")

allcandidates <- c(classicmemgenes, ACTINngenes, stabilizationgenes, astrocyticgenes)

```




```{r corrr2, fig.height=6}

plotcorrrs2 <- function(df, whichsubfield){
  
  favgenes <- allcandidates
  
  df <- df %>% 
    focus(PC1, PC2, favgenes,  mirror = TRUE)  %>% 
    arrange(desc(PC1))

  p1 <- df %>% 
    focus(PC1, PC2) %>%
    mutate(rowname = reorder(rowname, PC1)) %>%
    ggplot(aes(rowname, PC1, fill = PC1)) +
     geom_col() + coord_flip() +
    scale_fill_gradient2(low = "#67a9cf",  high = "#ef8a62", midpoint = 0) +
    theme_ms() +
    theme(legend.position = "none") +
    #ylim(-1,1) +
    labs(x = NULL, y = "Correlation to PC1") +
    labs(subtitle = whichsubfield)
  
  p2 <- df %>% 
    focus(PC1, PC2) %>%
    mutate(rowname = reorder(rowname, PC1)) %>%
    ggplot(aes(rowname, PC2, fill = PC2)) +
    geom_col() + coord_flip() +
    scale_fill_gradient2(low = "#67a9cf",  high = "#ef8a62", midpoint = 0) +
    theme_ms() +
    theme(legend.position = "none",
          axis.text.y = element_blank()) +
    #ylim(-1,1) +
    labs(x = NULL, y = "Correlation to PC2") +
    labs(subtitle = " ") 

  p3 <- df %>% 
    replace(., is.na(.), 1) %>% 
    network_plot.cor_df(colors = c("#67a9cf", "white", "#ef8a62"),
               min_cor = 0.0, curved = F, legend = T,
               repel = TRUE) + 
    theme(legend.position = "right") +
    labs(subtitle = " ")
  
  p4 <- df %>% 
    focus(PC1, PC2, favgenes,  mirror = TRUE) %>% 
    replace(., is.na(.), 0) %>% 
    rearrange() %>% 
    rplot(colours = c("#67a9cf", "white", "#ef8a62")) + 
    theme(axis.text.x = element_text(angle = 45, hjust = 1)) 
    
  p34 <- plot_grid(p3,p4,  nrow = 1)
  p12 <- plot_grid(p1,p2,  nrow = 1, rel_widths = c(1.1,1))
  p1234 <- plot_grid(p12,p34,  nrow = 2)
  
  filename <- paste("../data/06_", whichsubfield, "_candidatecorrelations.csv", sep = "")
  
  write.csv(df, filename)

  return(p1234)
  
}

plotcorrrs2(corrrDG, "DG")
plotcorrrs2(corrrCA3, "CA3")
plotcorrrs2(corrrCA1, "CA1")
```

## 3 hypotheses

```{r corrr3, fig.height=6, fig.width=6}
plotcorrrs3 <- function(favgenes, mytitle){
  
  plotfavgenes <- function(favgenes, df, whichsubfield){
  
    df <- df %>% focus(PC1, PC2, favgenes,  mirror = TRUE) 
    
    p1 <- df %>% 
      focus(PC1, PC2) %>%
      mutate(rowname = reorder(rowname, PC1)) %>%
      ggplot(aes(rowname, PC1, fill = PC1)) +
      geom_col() + coord_flip() +
      scale_fill_gradient2(low = "#67a9cf",  high = "#ef8a62", midpoint = 0) +
      theme_ms() +
      ylim(-1,1) +
      theme(legend.position = "none") +
      labs(x = NULL, y = "Correlation to PC1") +
      labs(subtitle = whichsubfield)
  
    p2 <- df %>% 
      replace(., is.na(.), 0) %>% 
      network_plot.cor_df(colors = c("#67a9cf", "white", "#ef8a62"),
               min_cor = 0.0, curved = F, legend = T,
               repel = TRUE) + 
      theme(legend.position = "none") 
    
    p3 <- df %>% 
    focus(PC1, PC2, favgenes,  mirror = TRUE) %>% 
    #rearrange() %>% 
    replace(., is.na(.), 0) %>%   
    rplot(colours = c("#67a9cf", "white", "#ef8a62")) + 
    theme(axis.text.x = element_text(angle = 45, hjust = 1))  + 
      theme(legend.position = "none") 

    p12 <- plot_grid(p1, p2, p3, nrow = 1, rel_widths = c(1,1,1))

    return(p12)
  }
  
  a <- plotfavgenes(favgenes, corrrDG, "DG")
  b <- plotfavgenes(favgenes, corrrCA3, "CA3")
  c <- plotfavgenes(favgenes, corrrCA1, "CA1")
  
  title <- ggdraw() + 
    draw_label(mytitle, fontface = 'bold', x = 0, hjust = 0) +
    theme(plot.margin = margin(0, 0, 0, 7))
  
  plot_grid(title, a,b,c, nrow = 4, rel_heights = c(0.1, 1, 1, 1))
  
}

plotcorrrs3(classicmemgenes, "candidate memory genes")
plotcorrrs3(ACTINngenes, "actin remodeling")
plotcorrrs3(stabilizationgenes, "PNN stabilization genes")
plotcorrrs3(astrocyticgenes, "astrocytic involvement")
```

## correlations with p-values


vsdDG <- prepvsdforjoin("../data/03_DG_vsdtraining.csv")
vsdCA3 <- prepvsdforjoin("../data/03_CA3_vsdtraining.csv")
vsdCA1 <- prepvsdforjoin("../data/03_CA1_vsdtraining.csv")


```{r Hmisc}
getcandidategenecorrelations <- function(df, candidategenes, whichsubfield){
  
  x <- df %>%
    select(ID, PC1, PC2, candidategenes)
  x <- as.data.frame(x)
  row.names(x) <- x$ID
  x$ID <- NULL
  res <- rcorr(as.matrix(x))
  
  cormat <- res$r
  pmat <- res$P
  
  ut <- upper.tri(cormat)
  
  newdf <- data.frame(
    row = rownames(cormat)[row(cormat)[ut]],
    column = rownames(cormat)[col(cormat)[ut]],
    cor  =(cormat)[ut],
    p = pmat[ut]
    )
  
  newdf <- newdf %>% arrange(p) %>%
    mutate(padj = p.adjust(p, method = "fdr", n = length(p)))
  
  filename <- paste("../data/06_", whichsubfield, "_corrswithpvalue.csv", sep = "")
  write.csv(newdf, filename)
  
  print(head(newdf, 10))
  return(newdf)
  
}

DGcorrswithpvalue <- getcandidategenecorrelations(vsdDG, allcandidates, "DG")
CA3corrswithpvalue <- getcandidategenecorrelations(vsdCA3, allcandidates, "CA3")
CA1corrswithpvalue <- getcandidategenecorrelations(vsdCA1, allcandidates, "CA1")
```

