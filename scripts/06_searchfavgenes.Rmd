---
title: "Search favorite gene Analysis"
output: md_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.path = '../figures/favegenes/', cache = T, cache.lazy = F)
```

```{r packages}
library(tidyverse)
library(corrr)
library(cowplot)

source("./figureoptions.R")
source("./functions_RNAseq.R")
```

## Sample information and PC1

```{r vsds}
# meta data
colData <- read_csv("../data/00_colData.csv")

geneids <- read_csv("../data/00_geneids.csv") %>% distinct(gene) %>% mutate(gene = toupper(gene))

# pca data
pca.Rn <- read_csv("../data/01_pca.all.csv") %>% 
  filter(trialNum == 9) %>%  
  select(ID:PC2) %>%
  left_join(colData) %>% drop_na() %>% select(ID, treatment, training, trialNum, Day, RNAseqID, subfield, PC1, PC2)
head(pca.Rn)

prepvsdforjoin <- function(pathtovsd, mysubfield){
  #read all count data
  vsd <- read_csv(pathtovsd) 
  vsd$gene <- vsd$X1
  vsd$gene <- toupper(vsd$gene)
  vsd <- vsd %>% arrange(gene) %>%  select(gene,everything())
  vsd <- as.data.frame(vsd)
  vsd$X1 <- NULL
  row.names(vsd) <- vsd$gene
  vsd$gene <- NULL
  vsd <- as.data.frame(t(vsd))

  vsd$RNAseqID <- row.names(vsd)
  vsd <- vsd %>%  select(RNAseqID, everything())
  vsd <- left_join(pca.Rn, vsd)  %>% drop_na()

  vsd$subfield <- factor(vsd$subfield, levels = levelssubfield)
  vsd$treatment <- factor(vsd$treatment, levels = levelstreatment)
  return(vsd)
}

vsdDG <- prepvsdforjoin("../data/03_DG_vsdtraining.csv")
vsdCA3 <- prepvsdforjoin("../data/03_CA3_vsdtraining.csv")
vsdCA1 <- prepvsdforjoin("../data/03_CA1_vsdtraining.csv")
```



```{r ARC}
printcortests <- function(mysubfield, df){
  print(mysubfield)
  print(cor.test(df$PC1, df$ARC, method = c("pearson")))
  print(cor.test(df$PC2, df$ARC, method = c("pearson")))
}

printcortests("DG", vsdDG)
printcortests("CA3", vsdCA3)
printcortests("CA1", vsdCA1)

plotcorrelation <- function(df, favegene, myPC){
  p <- ggplot(df, aes(x = favegene, y = myPC)) +
   geom_point(aes( color = treatment)) + 
   geom_smooth(method = "lm", color = "grey") +
   scale_color_manual(values = treatmentcolors) +
  theme_ms() +
   theme(legend.position = "none") +
    facet_wrap(~subfield) +
    labs(y = NULL, x = NULL)
  return(p)
}


p1 <- plotcorrelation(vsdDG, vsdDG$ARC, vsdDG$PC1) + labs(y = "PC1")
p2 <- plotcorrelation(vsdDG, vsdDG$ARC, vsdDG$PC2) + labs(y = "PC2")  + labs(x =  " ")
p3 <- plotcorrelation(vsdCA3, vsdCA3$ARC, vsdCA3$PC1) 
p4 <- plotcorrelation(vsdCA3, vsdCA3$ARC, vsdCA3$PC2)  + labs(x = "ARC expression")
p5 <- plotcorrelation(vsdCA1, vsdCA1$ARC, vsdCA1$PC1)
p6 <- plotcorrelation(vsdCA1, vsdCA1$ARC, vsdCA1$PC2)  + labs(x =  " ")

left <- plot_grid(p1,p3,p5,p2,p4,p6, nrow = 2, labels = c("a","b", "c", " ", " ", " "), 
                  label_size = 8, rel_heights = c(0.45,0.575))
left
```


## Correlate ALL genes with PC1 and PC2

```{r makecorrrmat}
# Use `tail(names(vsd),10)` to see that last genes is "ZZZ3"
tail(names(vsdDG),10)

makecorrrmatrix <- function(df){
  forcorall <-  df %>% select(PC1:ZZZ3)
  corrrmat <- correlate(forcorall, diagonal = 1) 
  return(corrrmat)
}
```

```{r makecorrrmat1}
corrrDG <- makecorrrmatrix(vsdDG)
```

```{r makecorrrmat2}
corrrCA3 <- makecorrrmatrix(vsdCA3)
```

```{r makecorrrmat3}
corrrCA1 <- makecorrrmatrix(vsdCA1)
```


## Top correlations with PC1 and their relationship with PC2

```{r corrr}

plotcorrrs <- function(df, mysubtitle){
  
 corrsTop <- df %>% 
  focus(PC1)  %>% 
  arrange(desc(PC1)) %>% 
  top_n(20)
  
  topcorrrs <- corrsTop$rowname

  p1 <- df %>% 
    focus(PC1, PC2, topcorrrs,  mirror = TRUE) %>% 
    focus(PC1, PC2) %>%
    mutate(rowname = reorder(rowname, PC1)) %>%
    ggplot(aes(rowname, PC1, fill = PC1)) +
     geom_col() + coord_flip() +
    scale_fill_gradient2(low = "#67a9cf",  high = "#ef8a62", midpoint = 0) +
    theme_ms() +
    theme(legend.position = "none") +
    #ylim(-1,1) +
    labs(x = NULL, y = "Correlation to PC1") +
    labs(subtitle = mysubtitle)
  
  p2 <- df %>% 
    focus(PC1, PC2, topcorrrs,  mirror = TRUE) %>% 
    focus(PC1, PC2) %>%
    mutate(rowname = reorder(rowname, PC1)) %>%
    ggplot(aes(rowname, PC2, fill = PC2)) +
     geom_col() + coord_flip() +
    scale_fill_gradient2(low = "#67a9cf",  high = "#ef8a62", midpoint = 0) +
    theme_ms() +
    theme(legend.position = "none") +
    #ylim(-1,1) +
    labs(x = NULL, y = "Correlation to PC2") +
    labs(subtitle = " ")

  p3 <- df %>% 
    focus(PC1, PC2, topcorrrs,  mirror = TRUE) %>% 
    rearrange() %>% 
    network_plot.cor_df(colors = c("#67a9cf", "white", "#ef8a62"),
               min_cor = .7, curved = F, legend = T,
               repel = TRUE) + 
    theme(legend.position = "right") +
    labs(subtitle = " ")
  
  p12 <- plot_grid(p1,p2,  nrow = 1)
  p123 <- plot_grid(p12,p3,  nrow = 2)

  
  
  return(p123)
}

plotcorrrs(corrrDG, "DG")
plotcorrrs(corrrCA3, "CA3")
plotcorrrs(corrrCA1, "CA1")
```

```{r corrr2}

plotcorrrs2 <- function(df, whichsubfield){
  
  
  favgenes <- c("PRKCZ", "WWC1",
                "GRIA1","GRIN2A", "GRIN1", "CAMK2A" , 
                "DRD2",  "NPAS4", "ARC", 
                "CPEB4", "EIF5", "BDNF", 
                "GABRA5", "SNAP25", "HTR2A", "TH",
                "MAPK1", "SYN1")
  
  df <- df %>% focus(PC1, PC2, favgenes,  mirror = TRUE) 

  p1 <- df %>% 
    focus(PC1, PC2) %>%
    mutate(rowname = reorder(rowname, PC1)) %>%
    ggplot(aes(rowname, PC1, fill = PC1)) +
     geom_col() + coord_flip() +
    scale_fill_gradient2(low = "#67a9cf",  high = "#ef8a62", midpoint = 0) +
    theme_ms() +
    theme(legend.position = "none") +
    #ylim(-1,1) +
    labs(x = NULL, y = "Correlation to PC1") +
    labs(subtitle = whichsubfield)
  
  p2 <- df %>% 
    focus(PC1, PC2) %>%
    mutate(rowname = reorder(rowname, PC1)) %>%
    ggplot(aes(rowname, PC2, fill = PC2)) +
    geom_col() + coord_flip() +
    scale_fill_gradient2(low = "#67a9cf",  high = "#ef8a62", midpoint = 0) +
    theme_ms() +
    theme(legend.position = "none",
          axis.text.y = element_blank()) +
    #ylim(-1,1) +
    labs(x = NULL, y = "Correlation to PC2") +
    labs(subtitle = " ") 

  p3 <- df %>% 
    network_plot.cor_df(colors = c("#67a9cf", "white", "#ef8a62"),
               min_cor = .7, curved = F, legend = T,
               repel = TRUE) + 
    theme(legend.position = "right") +
    labs(subtitle = " ")
  
  p4 <- df %>% 
    rplot(print_cor = TRUE, shape = "square")
  
  p12 <- plot_grid(p1,p2,  nrow = 1, rel_widths = c(1.1,1))
  p123 <- plot_grid(p12,p3,  nrow = 2)

  
  
  return(p123)
}


plotcorrrs2(corrrDG, "DG")
plotcorrrs2(corrrCA3, "CA3")
plotcorrrs2(corrrCA1, "CA1")
```

