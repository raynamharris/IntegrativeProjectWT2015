---
title: "Search favorite gene Analysis"
output: md_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.path = '../figures/06_favegenes/', cache = T, cache.lazy = F)
```

```{r packages}
suppressMessages(library(tidyverse))
suppressMessages(library(cowplot))
suppressMessages(library(corrr)) # for easy correlations
suppressMessages(library(Hmisc)) # for correlations with pvalue

source("./figureoptions.R")
source("./functions_RNAseq.R")
```

## Sample information and PC1

```{r vsds}
# meta data
colData <- read_csv("../data/00_colData.csv")

geneids <- read_csv("../data/00_geneids.csv") %>% distinct(gene) %>% mutate(gene = toupper(gene))

# pca data
pca.Rn <- read_csv("../data/01_pca.all.csv") %>% 
  filter(trialNum == 9) %>%  
  select(ID:PC2) %>%
  left_join(colData) %>% drop_na() %>% select(ID, treatment, training, trialNum, Day, RNAseqID, subfield, PC1, PC2)
head(pca.Rn)

prepvsdforjoin <- function(pathtovsd, mysubfield){
  #read all count data
  vsd <- read_csv(pathtovsd) 
  vsd$gene <- vsd$X1
  vsd$gene <- toupper(vsd$gene)
  vsd <- vsd %>% arrange(gene) %>%  select(gene,everything())
  vsd <- as.data.frame(vsd)
  vsd$X1 <- NULL
  row.names(vsd) <- vsd$gene
  vsd$gene <- NULL
  vsd <- as.data.frame(t(vsd))

  vsd$RNAseqID <- row.names(vsd)
  vsd <- vsd %>%  select(RNAseqID, everything())
  vsd <- left_join(pca.Rn, vsd)  %>% drop_na()

  vsd$subfield <- factor(vsd$subfield, levels = levelssubfield)
  vsd$treatment <- factor(vsd$treatment, levels = levelstreatment)
  vsd$training <- factor(vsd$training, levels = levelstraining)
  return(vsd)
}

vsdDG <- prepvsdforjoin("../data/03_DG_vsdtraining.csv")
```

## different sets of candidatea genes

```{r candidategenes}
classicmemgenes <- c("PRKCZ", "WWC1", "PRKCI", "PRKCB",
                "NSF", "GRIA2", "PIN1", "IGF2", "CAMK2A",
                "PICK1")

stabilizationgenes  <- c("IGF2BP2",  "LAMA1", "LAMB1", "LAMC1", "TNC", "TNXB",
                          "TNR", "GABRA1", "PTPRS", "PNN", "EGFR")

ACTINngenes <- c("LIMK1","CFL1", "ROCK2")

astrocyticgenes <- c("ALDH1A1", "ALDH1L1", "ALDH1L2", 
                     "SLC1A2", "GFAP", "GJB6", "FGFR3", "AQP4", "ALDOC")

allcandidates <- c(classicmemgenes, ACTINngenes, stabilizationgenes, astrocyticgenes)
```

## correlations with ARC

```{r scatterplots}
printcortests <- function(mysubfield, df){
  print(mysubfield)
  print(cor.test(df$PC1, df$ARC, method = c("pearson")))
  print(cor.test(df$FOSL2, df$ARC, method = c("pearson")))
  print(cor.test(df$PC1, df$PRKCZ, method = c("pearson")))
  print(cor.test(df$PC1, df$CAMK2A, method = c("pearson")))
}

printcortests("DG", vsdDG)

plotcorrelation <- function(df, myx, myy){
  p <- ggplot(df, aes(x = myx, y = myy)) +
   geom_point(aes(color = training)) + 
   geom_smooth(method = "lm", color = "grey") +
   scale_color_manual(values = volcano1) +
  theme_ms() +
   theme(legend.position = "none") +
    labs(y = NULL, x = NULL)
  return(p)
}

p1 <- plotcorrelation(vsdDG, vsdDG$ARC, vsdDG$PC1) + labs(y = "PC1", subtitle = "R2 = 0.81, p = 1.64 × 10-4")
p2 <- plotcorrelation(vsdDG, vsdDG$ARC, vsdDG$FOSL2)  + labs(y = "FOSL", x = "ARC", subtitle = "R2 = 0.89, p = 4.97 × 10-6") + 
  theme(axis.title = element_text(face = "italic"))


cd <- plot_grid(p1,p2, nrow = 2, rel_heights = c(0.45,0.55), labels = c("c", NULL), label_size = 8)
cd

p3 <- plotcorrelation(vsdDG, vsdDG$PC1, vsdDG$PRKCZ) + labs( y = "PRKCZ",   subtitle = "R2 = -0.73, p = 0.166") + 
  theme(axis.title.y = element_text(face = "italic"))
p4 <- plotcorrelation(vsdDG, vsdDG$PC1, vsdDG$CAMK2A)  + labs(x = "PC1", y = "CAMK2A", subtitle = "R2 = 0.29, p = 0.279") + 
  theme(axis.title.y = element_text(face = "italic"), 
        legend.position = "bottom", legend.title = element_blank(),
        legend.margin=margin(0,0,0,0),
        legend.box.margin=margin(-8,-8,-8,-8)) 


gh <- plot_grid(p3,p4, nrow = 2, rel_heights = c(0.45,0.55), labels = c("f", NULL), label_size = 8)
gh
```

## Correlate ALL genes with PC1 and PC2

```{r makecorrrmat}
# Use `tail(names(vsd),10)` to see that last genes is "ZZZ3"
tail(names(vsdDG),10)

makecorrrmatrix <- function(df){
  forcorall <-  df %>% select(PC1:ZZZ3)
  corrrmat <- correlate(forcorall) 
  return(corrrmat)
}
```

```{r makecorrrmat1}
corrrDG <- makecorrrmatrix(vsdDG) 
```

```{r makecorrrmat2}
corrrCA3 <- makecorrrmatrix(vsdCA3) 
```

```{r makecorrrmat3}
corrrCA1 <- makecorrrmatrix(vsdCA1) 
```


## Top correlations with PC1 and their relationship with PC2

```{r corrr, fig.height=6}
corrsTop <- corrrDG %>% 
  focus(PC1)  %>% 
  arrange(desc(PC1)) %>% 
  top_n(20)
  
topcorrrs <- corrsTop$rowname

a <- corrrDG %>% 
    focus(PC1,  topcorrrs,  mirror = TRUE) %>% 
    focus(PC1) %>% 
    mutate(rowname = reorder(rowname, PC1)) %>%
    ggplot(aes(rowname, PC1, fill = PC1)) +
     geom_col() + coord_flip() +
    scale_fill_gradient2(low = "#67a9cf",  high = "#ef8a62", midpoint = 0) +
    theme_ms() +
    theme(legend.position = "none", axis.text.y = element_text(face = "italic")) +
    #ylim(-1,1) +
    labs(x = NULL, y = "Correlation to PC1 (avoidance estimate)") 
  
b <- corrrDG %>% 
    focus(PC1, topcorrrs,  mirror = TRUE) %>% 
    replace(., is.na(.), 1) %>% 
    network_plot.cor_df(colors = c("#67a9cf", "white", "#ef8a62"),
               min_cor = .7, curved = F, legend = T,
               repel = TRUE) + 
    theme(legend.position = "none") 
  
ab <- plot_grid(a,b,  nrow = 1, labels = c("a", "b"), label_size = 8)
 
abcd <- plot_grid(ab, cd, rel_widths = c(0.66, 0.33))
abcd


plotcorrrs2 <- function(df, whichsubfield){
  
  favgenes <- c(classicmemgenes, stabilizationgenes)
  
  df <- df %>% 
    focus(PC1, favgenes,  mirror = TRUE)  %>% 
    arrange(desc(PC1))

  p1 <- df %>% 
    focus(PC1) %>%
    mutate(rowname = reorder(rowname, PC1)) %>%
    ggplot(aes(rowname, PC1, fill = PC1)) +
     geom_col() + coord_flip() +
    scale_fill_gradient2(low = "#67a9cf",  high = "#ef8a62", midpoint = 0) +
    theme_ms() +
    theme(legend.position = "none", axis.text.y = element_text(face = "italic")) +
    #ylim(-1,1) +
    labs(x = NULL, y = "Correlation to PC1 (avoidance estimate)")
  

  p3 <- df %>% 
    replace(., is.na(.), 1) %>% 
    network_plot.cor_df(colors = c("#67a9cf", "white", "#ef8a62"),
               min_cor = 0.0, curved = F, legend = T,
               repel = TRUE) + 
    theme(legend.position = "bottom") 
  
  p13 <- plot_grid(p1,p3,  nrow = 1, labels = c("d", "e"), label_size = 8)
  
  filename <- paste("../data/06_", whichsubfield, "_candidatecorrelations.csv", sep = "")
  
  write.csv(df, filename)

  return(p13)
  
}

ef <- plotcorrrs2(corrrDG, "DG")

efgh <- plot_grid(ef, gh, rel_widths = c(0.66, 0.33))
efgh

plot_grid(abcd,efgh, nrow = 2)
```



## correlations with p-values


```{r Hmisc}
getcandidategenecorrelations <- function(df, candidategenes, whichsubfield){
  
  x <- df %>%
    select(ID, PC1, PC2, candidategenes)
  x <- as.data.frame(x)
  row.names(x) <- x$ID
  x$ID <- NULL
  res <- rcorr(as.matrix(x))
  
  cormat <- res$r
  pmat <- res$P
  
  ut <- upper.tri(cormat)
  
  newdf <- data.frame(
    row = rownames(cormat)[row(cormat)[ut]],
    column = rownames(cormat)[col(cormat)[ut]],
    cor  =(cormat)[ut],
    p = pmat[ut]
    )
  
  newdf <- newdf %>% arrange(p) %>%
    mutate(padj = p.adjust(p, method = "fdr", n = length(p)))
  
  filename <- paste("../data/06_", whichsubfield, "_corrswithpvalue.csv", sep = "")
  write.csv(newdf, filename)
  
  print(head(newdf, 10))
  return(newdf)
  
}

DGcorrswithpvalue <- getcandidategenecorrelations(vsdDG, allcandidates, "DG")
```

