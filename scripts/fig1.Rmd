---
title: "fig1"
output: md_document
---

New approach. Behavior-centric analysis figures first. 


```{r setup}
library(tidyverse) ## for respahing data
library(cowplot) ## for some easy to use themes
library(DESeq2)

library("png")
library("grid")

library(BiocParallel)
register(MulticoreParam(6))

source("functions_RNAseq.R")
source("figureoptions.R")

knitr::opts_chunk$set(echo = TRUE, fig.path = '../figures/fig1/', message = F)
```

```{r behav}
# all behavior data
behav <- read.csv("../data/01a_behavior.csv") 

# make mouse name
behav$mouse <- sapply(strsplit(as.character(behav$ID),"15"), "[", 2)

behav <-  behav %>% 
  select(mouse,APA2, TrainSessionCombo, TrainSessionComboNum, Time1stEntr, Path1stEntr, pTimeTarget, NumEntrances)

# subset to standard or conflict paradigm only
standard <- behav %>% filter(APA2 %in% c("standard-yoked", "standard-trained")) 
standard$APA2 <- factor(standard$APA2, levels = c("standard-yoked", "standard-trained"))

conflict <- behav %>% filter(APA2 %in% c("conflict-yoked", "conflict-trained")) 
conflict$APA2 <- factor(conflict$APA2, levels = c("conflict-yoked", "conflict-trained"))


# gather and summarize

calculatemeandev <- function(mydf){
  
  mydf <- mydf %>% gather(behavior, measure, Time1stEntr:NumEntrances)
  mydf$behavior <- factor(mydf$behavior, levels = c("Path1stEntr", "Time1stEntr", "pTimeTarget", "NumEntrances"))

  meandev <- mydf %>%
    dplyr::group_by(APA2, TrainSessionComboNum, behavior) %>%
    dplyr::summarise(m = mean(measure), 
                   se = sd(measure)/sqrt(length(measure)))
  return(meandev)
}

standard.meandev <- calculatemeandev(standard)
conflict.meandev <- calculatemeandev(conflict)

  
# Time1stEntr, Path1stEntr, pTimeTarget, NumEntrances
a <- plotmeansd(standard.meandev, "Time1stEntr", "Time 1st entr. (s)" , trainedcolors)
b <- plotmeansd(standard.meandev, "Path1stEntr", "Path 1st entr. (m)" , trainedcolors)
c <- plotmeansd(standard.meandev, "pTimeTarget", "Prop. time in zone" , trainedcolors)
d <- plotmeansd(standard.meandev, "NumEntrances", "Num. of entr." , trainedcolors)

h <- plotmeansd(conflict.meandev, "Time1stEntr", "Time 1st entr. (s)" , conflictcolors)
i <- plotmeansd(conflict.meandev, "Path1stEntr", "Path 1st entr. (m)" , conflictcolors)
j <- plotmeansd(conflict.meandev, "pTimeTarget", "Prop. time in zone" , conflictcolors)
k <- plotmeansd(conflict.meandev, "NumEntrances", "Num. of entr." , conflictcolors)

A <- plot_grid(a + labs(subtitle = "std. yoked v trained"),
               h + labs(y = NULL, subtitle = "conf. yoked v trained"),
               b,i + labs(y = NULL),
               c,j + labs(y = NULL),
              d,k + labs(y = NULL), ncol = 2)
A
```



```{r DESeq2}
a.colData <- read.csv("../data/02a_colData.csv", header = T)
a.countData <- read.csv("../data/02a_countData.csv", header = T, check.names = F, row.names = 1)

standard <- c("standard.yoked", "standard.trained")
conflict <- c("conflict.yoked", "conflict.trained")
trained <- c("standard.trained", "conflict.trained")
yoked <- c("standard.yoked", "conflict.yoked")


# standard
DGstandard <- returndds("DG", standard) 
CA3standard <- returndds("CA3", standard) 
CA1standard <- returndds("CA1", standard) 


a <- plot.volcano(DGstandard, "standard.trained", "standard.yoked", volcano1)
b <- plot.volcano(CA3standard, "standard.trained", "standard.yoked", volcano1)
c <- plot.volcano(CA1standard, "standard.trained", "standard.yoked", volcano1)


# conflict
DGconflict <- returndds("DG", conflict) 
CA3conflict <- returndds("CA3", conflict) 
CA1conflict <- returndds("CA1", conflict) 

d <- plot.volcano(DGconflict, "conflict.trained", "conflict.yoked", volcano5)
e <- plot.volcano(CA3conflict, "conflict.trained", "conflict.yoked", volcano5)
f <- plot.volcano(CA1conflict, "conflict.trained", "conflict.yoked", volcano5)


# trained
DGtrained <- returndds("DG", trained) 
CA3trained <- returndds("CA3", trained) 
CA1trained <- returndds("CA1", trained) 

h <- plot.volcano(DGtrained, "conflict.trained", "standard.trained", volcano2)
i <- plot.volcano(CA3trained, "conflict.trained", "standard.trained", volcano2)
j <- plot.volcano(CA1trained, "conflict.trained", "standard.trained", volcano2)


# yoked
DGyoked <- returndds("DG", yoked) 
CA3yoked <- returndds("CA3", yoked) 
CA1yoked <- returndds("CA1", yoked) 

k <- plot.volcano(DGyoked, "conflict.yoked", "standard.yoked", volcano6)
l <- plot.volcano(CA3yoked, "conflict.yoked", "standard.yoked", volcano6)
m <- plot.volcano(CA1yoked, "conflict.yoked", "standard.yoked", volcano6)


B <- plot_grid(a + labs(y = "DG: -log10(p)", subtitle = "std. yoked v trained"),
               d + labs(subtitle = "conf. yoked v trained"),
               h + labs(subtitle = "trained v trained"),
               k + labs(subtitle = "yoked v yoked"),
          b + labs(y = "CA3: -log10(p)"),e,i,l,
          c + labs(y = "CA1: -log10(p)", x = "lfc"),
          f  + labs( x = "lfc"),
          j + labs( x = "lfc"),
          m + labs( x = "lfc"), nrow = 3, align = "hv")
B
```

```{r fig1}
C <- plot_grid(A,B,rel_widths = c(0.3,0.6))
C
```

# supplementary fig 1

```{r schematic}
schematicTrained <- ggdraw() +  draw_image("../figures/figure_fig1a.png")
schematicConflict <- ggdraw() +  draw_image("../figures/figure_fig2a.png")

plot_grid(schematicTrained, schematicConflict, nrow = 2)
```

