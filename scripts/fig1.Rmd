---
title: "fig1"
output: md_document
---

New approach. Behavior-centric analysis figures first. 


```{r setup}
library(tidyverse) ## for respahing data
library(cowplot) ## for some easy to use themes
library(DESeq2)

library("png")
library("grid")

library(BiocParallel)
register(MulticoreParam(6))

source("functions_RNAseq.R")
source("figureoptions.R")

knitr::opts_chunk$set(echo = TRUE, fig.path = '../figures/fig1/')
```

```{r behav}
# all behavior data
behav <- read.csv("../data/01a_behavior.csv") 

# make mouse name
behav$mouse <- sapply(strsplit(as.character(behav$ID),"15"), "[", 2)

behav <-  behav %>% 
  select(mouse,APA2, TrainSessionCombo, TrainSessionComboNum, Time1stEntr, Path1stEntr, pTimeTarget, NumEntrances)

# subset to standard paradigm only
standard <- behav %>% filter(APA2 %in% c("standard-yoked", "standard-trained")) 
standard$APA2 <- factor(standard$APA2, levels = c("standard-yoked", "standard-trained"))

# gather
standard <- standard %>% gather(behavior, measure, Time1stEntr:NumEntrances)

standard$behavior <- factor(standard$behavior, levels = c("Path1stEntr", "Time1stEntr", "pTimeTarget", "NumEntrances"))

standard %>%
  filter(TrainSessionCombo == "Retention") %>%
    ggplot( aes(x = APA2, y = measure, color = APA2)) + 
  geom_boxplot() +
    geom_jitter()  + 
  facet_wrap(~behavior, scales = "free_y", nrow  = 1) + 
  theme_minimal() + 
  theme(legend.position = "none",
        axis.text.x = element_blank()) + 
  scale_color_manual(values = trainedcolors) +
  labs(x = NULL) 


meandev <- standard %>%
  dplyr::group_by(APA2, TrainSessionComboNum, behavior) %>%
  dplyr::summarise(m = mean(measure), 
                   se = sd(measure)/sqrt(length(measure)))

plotmeansd <- function(mybehavior, myylab){
  
  meandev %>% 
    filter(behavior == mybehavior) %>% 
    ggplot(aes(x=, TrainSessionComboNum, y=m, color=APA2)) + 
      geom_errorbar(aes(ymin=m-se, ymax=m+se, color=APA2), width=.1) +
      geom_point(size = 1.5) +
      geom_line() +
    theme_minimal(base_size = 8) + 
    theme(legend.position = "none") + 
    scale_color_manual(values = trainedcolors) +
    scale_x_continuous( breaks = c(1, 2, 3, 4, 5, 6, 7, 8, 9),
                       labels = c( "P", "T1", "T2", "T3",
                                   "Rt", "T4", "T5", "T6", "Rn")) +
    labs(x = NULL, y = myylab) 
  }
  
# Time1stEntr, Path1stEntr, pTimeTarget, NumEntrances
a <- plotmeansd("Time1stEntr", "Time 1st entr. (s)" )
b <- plotmeansd("Path1stEntr", "Path 1st entr. (m)" )
c <- plotmeansd("pTimeTarget", "Prop. time in zone" )
d <- plotmeansd("NumEntrances", "Num. of entr." )

top <- plot_grid(a,c,b,d, ncol = 1)
top

```



```{r DESeq2}
a.colData <- read.csv("../data/02a_colData.csv", header = T)
a.countData <- read.csv("../data/02a_countData.csv", header = T, check.names = F, row.names = 1)

trained <- c("standard.yoked", "standard.trained")

DGdds <- returndds("DG", trained) 
CA1dds <- returndds("CA1", trained) 
CA3dds <- returndds("CA3", trained) 

DGvsd <- returnvsds(DGdds, "../data/fig1.DG.vsd.trained.csv")
returnvsds(CA1dds, "../data/fig1.CA1.vsd.trained.csv")
returnvsds(CA3dds, "../data/fig1.CA3.vsd.trained.csv")

res_summary_subfield(DGdds, c("APA2", "standard.trained", "standard.yoked"))
res_summary_subfield(CA1dds, c("APA2", "standard.trained", "standard.yoked"))
res_summary_subfield(CA3dds, c("APA2", "standard.trained", "standard.yoked"))

e <-  plot.cons.yokcons(DGdds, "DG", "DG") 
f <-  plot.cons.yokcons(CA3dds, "CA3", "CA3") 
g <-  plot.cons.yokcons(CA1dds, "CA1", "CA1") 

efg <- plot_grid(e + theme(axis.text.x = element_blank(), axis.title.x = element_blank()),
                 f + theme(axis.text.x = element_blank(), axis.title.x = element_blank()),
                 g, nrow = 3)
efg
```


```{r fig1}
schematic <- ggdraw() +  draw_image("../figures/figure_fig1a.png")
left <- plot_grid(schematic,a,b,c, ncol = 1)
right <- plot_grid(e,f,g, ncol = 1)
plot_grid(left,right, ncol = 2)
```