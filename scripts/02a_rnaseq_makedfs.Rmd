---
title: "DESeq2 Data Analysis"
author: "Rayna M Harris"
date: "Last updated December 20, 2018"
output: md_document
---

## RNAseq gene expression analysis with DESeq2 

This workflow was modified from the DESeq2 tutorial found at: https://www.bioconductor.org/packages/release/bioc/vignettes/DESeq2/inst/doc/DESeq2.pdf

First I load a handful of packages for data wrangling, gene expression analysis, data visualization, and statistics.

```{r setup, message=F, warning=F}
library(tidyverse) ## for filtering and selecting rows
library(forcats)  # for renaming factors
library(DESeq2) ## for gene expression analysis
library(edgeR)  ## for basic read counts status
library(magrittr) ## to use the weird pipe
library(genefilter)  ## for PCA fuction
library(ggplot2)

## Functions
source("functions_RNAseq.R")

## set output file for figures 
knitr::opts_chunk$set(fig.path = '../figures/02a_makedfs/')
```

Now, I create data frames from three csv files
- count: Contains counts for all transcripts generated from the program Kallisto. This data can be reproducibed from the file kallisto.Rmd
- geneids: Contains the ensemble ids and gene names for all the transcripts in the counts data frame. This file will be used to convert transcipt counts to gene counts. This file was also created via kallisto.Rmd file
- colData: This file contains all the information I collected for each sample that was sequenced. Not all columns will be needed, so some are removed later. 

I also tidy the trait data for each sample so that I can calculate differential gene expression for the colData of interest. I also remove some samples for reasons described within the code blocks.

```{r colData}
# clean col Data
colData <- read_csv("../data/IntegrativeWT2015ColData.csv")
colData$APA_Conflict <- factor(colData$APA_Conflict)
colData <- colData %>%
  mutate(ID = gsub("[[:punct:]]", "", colData$Mouse)) %>%
  filter(APA_Conflict != "NA_NA") %>%
  mutate(subfield = Region) %>%
  mutate(treatment = fct_recode(APA_Conflict,
                                "standard.yoked" = "Yoked_NoConflict",
                                "standard.trained" = "Trained_NoConflict",
                                "conflict.yoked" = "Yoked_Conflict",
                                "conflict.trained" = "Trained_Conflict")) %>%
  mutate(training = fct_collapse(treatment,
                                      trained = c("standard.trained", "conflict.trained"),
                                      yoked = c("standard.yoked", "conflict.yoked"))) %>%
  select(RNAseqID,ID,subfield, treatment, training) %>%
  arrange(RNAseqID) %>%
  droplevels() 

# set factors
colData$subfield <- factor(colData$subfield, levels = c("DG", "CA3", "CA1"))
colData$treatment <- factor(colData$treatment, levels = c("standard.yoked", "standard.trained",
                                                          "conflict.yoked", "conflict.trained"))
colData$training <- factor(colData$training, levels = c("yoked", "trained"))

#view
head(colData)

colData %>% select(subfield,treatment)  %>%  summary()
```

Now, we are ready to calculate differential gene expression using the DESeq package. For simplicity, I will use the standard nameing of "countData" and "colData" for the gene counts and gene information, respectively.

```{r prepforDESeq2}
countData <- read.csv("../data/00_CountData.csv", row.names=1, check.names=FALSE )
head(countData[1:5])

## colData and countData must contain the exact same samples. 
savecols <- as.character(colData$RNAseqID) #select the rowsname 
savecols <- as.vector(savecols) # make it a vector
countData <- countData %>% dplyr::select(one_of(savecols)) # select just the columns 
```

## Total Gene Counts Per Sample 
this could say something about data before normalization

```{r totalRNAseqcounts}
totalCounts <- colSums(countData)
totalCounts

### on average 1 million gene counts per sample 
summary((colSums(countData)/1000000))

## stats
counts <- countData
dim( counts )
colSums( counts ) / 1e06  # in millions of reads
table( rowSums( counts ) )[ 1:30 ] # Number of genes with low counts

rowsum <- as.data.frame(colSums( counts ) / 1e06 )
names(rowsum)[1] <- "millioncounts"
rowsum$sample <- row.names(rowsum)

ggplot(rowsum, aes(x=millioncounts)) + 
  geom_histogram(binwidth = 1, colour = "black", fill = "darkgrey") +
  theme_classic() +
  scale_x_continuous(name = "Millions of Gene Counts per Sample") +
  scale_y_continuous(name = "Number of Samples")
```

## Write the two files

```{r writecsv}
write.csv(colData, file = "../data/02a_colData.csv", row.names = F)
write.csv(countData, file = "../data/02a_countData.csv", row.names = T)
```

