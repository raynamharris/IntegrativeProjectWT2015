---
title: "02c_rnaseqSubfield"
output: md_document
---

## Subfield analysis

This script is used to identify treatement differences within each subfield, generate volcano plots, venn diagrams, and tables for subsequent GO analyses. The final mutlipanel figures for the manuscript have been inserted just below the subheadings. 

```{r setup, message=F, warning=F}
library(tidyverse)
library(cowplot) ## for some easy to use themes
library(DESeq2) ## for gene expression analysis
library(UpSetR)
#devtools::install_github("clauswilke/ggtextures")
library(ggtextures)
library(magick)

library(BiocParallel)
register(MulticoreParam(6))

## load functions 
source("figureoptions.R")
source("functions_RNAseq.R")

## set output file for figures 
knitr::opts_chunk$set(fig.path = '../figures/02c_rnaseqSubfield/', cache = T)
```

## Get varience stabilized gene expression for each tissue

```{r DGdeseq}
a.colData <- read.csv("../data/02a_colData.csv", header = T)
a.countData <- read.csv("../data/02a_countData.csv", header = T, check.names = F, row.names = 1)

returndds <- function(mytissue){
  print(mytissue)
  colData <- a.colData %>% 
    filter(Punch %in% c(mytissue))  %>% 
  droplevels()
  
  savecols <- as.character(colData$RNAseqID) 
  savecols <- as.vector(savecols) 
  countData <- a.countData %>% dplyr::select(one_of(savecols)) 

  ## create DESeq object using the factors Punch and APA
  dds <- DESeqDataSetFromMatrix(countData = countData,
                              colData = colData,
                              design = ~ APA2)

  dds <- dds[ rowSums(counts(dds)) > 1, ]  # Pre-filtering genes with 0 counts
  dds <- DESeq(dds, parallel = TRUE)
  return(dds)
}

DGdds <- returndds("DG") 
CA1dds <- returndds("CA1") 
CA3dds <- returndds("CA3") 

returnvsds <- function(mydds, vsdfilename){
  dds <- mydds
  vsd <- vst(dds, blind=FALSE) ## variance stabilized
  print(head(assay(vsd),3))
  return(write.csv(assay(vsd), file = vsdfilename, row.names = T))
}

returnvsds(DGdds, "../data/02c_DGvsd.csv")
returnvsds(CA1dds, "../data/02c_CA1vsd.csv")
returnvsds(CA3dds, "../data/02c_CA3vsd.csv")
```

## Consistent versus yoked-consistent

```{r consyokcons}
plot.cons.yokcons <- function(mydds, mytissue, mytitle){
  print(mytissue)
  
  res <- results(mydds, contrast =c("APA2", "standard.trained", "standard.yoked"),
                 independentFiltering = T, alpha = 0.1)
  print(summary(res))

  data <- data.frame(gene = row.names(res),
                   padj = res$padj, 
                   logpadj = -log10(res$padj),
                   lfc = res$log2FoldChange)
  data <- na.omit(data)
  data <- data %>%
    dplyr::mutate(direction = ifelse(data$lfc > 0 & data$padj < 0.1, 
                        yes = "standard.trained", 
                        no = ifelse(data$lfc < 0 & data$padj < 0.1, 
                                    yes = "standard.yoked", 
                                    no = "NS")))


  write.csv(data, file = paste0("../data/02c_", mytissue, "_std.train.yoked.csv", sep = ""), row.names = F)
  
  volcano <- data %>%
    #filter(direction != "NS") %>%
    ggplot(aes(x = lfc, y = logpadj)) + 
    geom_point(aes(color = factor(direction)), size = 0.5, alpha = 0.75, na.rm = T) + 
    theme_cowplot(font_size = 7, line_size = 0.25) +
    geom_hline(yintercept = 1,  size = 0.25, linetype = 2) + 
    scale_color_manual(values = volcano1,
                      name = "higher in",
                      breaks = c("standard.yoked", "NS", "standard.trained"))  + 
    scale_x_continuous(limits=c(-10, 10),
                        name="Log fold difference")+
    ylim(c(0,7)) +
    ylab(paste0("-log10 p-value")) +  
    labs(subtitle = mytitle) +
    theme(legend.position = "bottom",
          legend.spacing.x = unit(0.1, 'cm'),
          #legend.text=element_text(size=4),
          legend.title = element_text(size=6),
          legend.key.size = unit(0.2, "cm"),
          legend.margin=margin(t=-0.1, r=0, b=0, l=-0.1, unit="cm")) 
  plot(volcano)
}


DGconsyokcons <-  plot.cons.yokcons(DGdds, "DG", "DG: standard yoked v. trained") 
CA3consyokcons <-  plot.cons.yokcons(CA3dds, "CA3", "CA3: standard yoked v. trained")  
CA1consyokcons <-  plot.cons.yokcons(CA1dds, "CA1", "CA1: standard yoked v. trained")  

plot_grid(DGconsyokcons,CA1consyokcons, nrow = 1)
```

## Confict versus Consistent

```{r confcons}
plot.conf.cons <- function(mydds, mytissue){
  
  print(mytissue)
  
  res <- results(mydds, contrast =c("APA2", "conflict.trained", "standard.trained"),
                 independentFiltering = T, alpha = 0.1)
  print(summary(res))

  data <- data.frame(gene = row.names(res),
                   padj = res$padj, 
                   logpadj = -log10(res$padj),
                   lfc = res$log2FoldChange)
  data <- na.omit(data)
  
  data <- data %>%
    dplyr::mutate(direction = ifelse(data$lfc > 0 & data$padj < 0.1, 
                        yes = "conflict.trained", 
                        no = ifelse(data$lfc < 0 & data$padj < 0.1, 
                                    yes = "standard.trained", 
                                    no = "NS")))
  
  write.csv(data, file = paste0("../data/02c_", mytissue, "_confcons.csv", sep = ""), row.names = F)
  
  volcano <- ggplot(data, aes(x = lfc, y = logpadj)) + 
    geom_point(aes(color = factor(direction)), size = 0.5, alpha = 0.75, na.rm = T) + 
    theme_cowplot(font_size = 7, line_size = 0.25) +
    geom_hline(yintercept = 1,  size = 0.25, linetype = 2) + 
    #scale_color_manual(values = volcano2,
    #                   breaks = c("standard.trained", "NS", "conflict.trained"),
    #                  name = "higher in")  + 
    scale_x_continuous(limits=c(-10, 10),
                        name="Log fold difference")+
    ylab(paste0("-log10 p-value")) +  
    labs(subtitle = mytissue) +
    theme(panel.grid.minor=element_blank(),
          legend.position = "bottom",
          legend.spacing.x = unit(-0.1, 'cm'),
          panel.grid.major=element_blank(),
          legend.margin=margin(t=-0.25, r=0, b=0, l=0, unit="cm")) 
  plot(volcano)
}


DGconflict <-  plot.conf.cons(DGdds, "DG: standard v. conflict trained")
CA3conflict <-  plot.conf.cons(CA3dds, "CA3: standard v. conflict trained")
CA1conflict <-  plot.conf.cons(CA1dds, "CA1: standard v. conflict trained")

plot_grid(DGconflict, CA3conflict, CA1conflict, nrow = 3)
```


## Yoked confict versus yoked consistent

```{r yokeconfyokcons}
plot.yokconf.yokcons <- function(mydds, mytissue, mytitle){
  
  print(mytissue)
  
  res <- results(mydds, contrast =c("APA2", "conflict.yoked", "standard.yoked"),
                 independentFiltering = T, alpha = 0.1)
  print(summary(res))

  data <- data.frame(gene = row.names(res),
                   padj = res$padj, 
                   logpadj = -log10(res$padj),
                   lfc = res$log2FoldChange)
  data <- na.omit(data)
  data <- data %>%
    dplyr::mutate(direction = ifelse(data$lfc > 0 & data$padj < 0.1, 
                        yes = "conflict.yoked", 
                        no = ifelse(data$lfc < 0 & data$padj < 0.1, 
                                    yes = "standard.yoked", 
                                    no = "NS")))
  
  data$direction <- factor(data$direction, levels = c("standard.yoked", "NS", "conflict.yoked"))
  
  write.csv(data, file = paste0("../data/02c_", mytissue, "_yokeconfyokcons.csv", sep = ""), row.names = F)
  
  volcano <- data %>%
    #filter(direction != "NS") %>%
    ggplot(aes(x = lfc, y = logpadj, color = direction)) + 
    geom_point(size = 0.5, alpha = 0.75, na.rm = T) + 
    theme_cowplot(font_size = 7, line_size = 0.25) +
    geom_hline(yintercept = 1,  size = 0.25, linetype = 2) + 
    scale_color_manual(values = volcano6,
                       name = "higher in")  + 
    #scale_y_continuous(limits=c(0, 12.5)) +
    scale_x_continuous(limits=c(-10, 10),
                        name="Log fold difference")+
    ylab(paste0("-log10 p-value")) + 
    ylim(c(0,7)) +
    labs(subtitle = mytitle) +
    theme(legend.position = "bottom",
          legend.spacing.x = unit(0.1, 'cm'),
          #legend.text=element_text(size=4),
          legend.key.size = unit(0.2, "cm"),
          legend.margin=margin(t=-0.1, r=0, b=0, l=-0.1, unit="cm")) 
  plot(volcano)  
}

DGyoked <-  plot.yokconf.yokcons(DGdds, "DG", "DG: standard v. conflict yoked")
CA3yoked <-  plot.yokconf.yokcons(CA3dds, "CA3", "CA3: standard v. conflict yoked")
CA1yoked <-  plot.yokconf.yokcons(CA1dds, "CA1", "CA1: standard v. conflict yoked")  

plot_grid(DGyoked, CA3yoked, CA1yoked, nrow = 1)
```


```{r fig5volcanos}
volcanos <- plot_grid(DGconsyokcons  ,CA1consyokcons  , CA1yoked , nrow = 1) 
volcanos

pdf(file="../figures/02c_rnaseqSubfield/volcanos.pdf", width=6.65, height=2)
plot(volcanos)    
dev.off()
```

# pkmz

```{r pkmz}
plotCounts(DGdds, "Prkcz", intgroup = "APA2", normalized = TRUE, main="Prkcz in DG")
plotCounts(CA3dds, "Prkcz", intgroup = "APA2", normalized = TRUE, main="Prkcz in CA3")
plotCounts(CA1dds, "Prkcz", intgroup = "APA2", normalized = TRUE, main="Prkcz in CA1")

```

## genes that are correlated with number of entrances 

Requires anlaysis of `04_integration.Rmd` first.

```{r DGcorrelations}
plotCounts(DGdds, "Acan", intgroup = "APA2", normalized = TRUE, main="Acan in DG")
plotCounts(DGdds, "Amigo2", intgroup = "APA2", normalized = TRUE, main="Amigo2 in DG")
plotCounts(DGdds, "Armcx5", intgroup = "APA2", normalized = TRUE, main="Armcx5 in DG")
plotCounts(DGdds, "Ptgs2", intgroup = "APA2", normalized = TRUE, main="Ptgs2 in DG")
plotCounts(DGdds, "Rgs2", intgroup = "APA2", normalized = TRUE, main="Rgs2 in DG")
plotCounts(DGdds, "Syt4", intgroup = "APA2", normalized = TRUE, main="Syt4 in DG")
```


## Upset plots

What genes overlap within cetain comparisons?

```{r upsetplotprep}
a.colData <- read.csv("../data/02a_colData.csv", header = T)
a.countData <- read.csv("../data/02a_countData.csv", header = T, check.names = F, row.names = 1)

eachsubfield <- levels(a.colData$Punch)

listofDEGs <- function(group1, group2){
  res <- results(dds, contrast = c("APA2", group1, group2), independentFiltering = T)
  data <- data.frame(gene = row.names(res),
                     lfc = res$log2FoldChange,
                     padj = res$padj,
                     tissue = i,
                     comparison = paste(group1, group2, sep = "-"))
  data <- data %>% dplyr::filter(padj < 0.1) %>% droplevels()
  return(data)
}

for(i in eachsubfield){
  
  colData <- a.colData %>% 
    dplyr::filter(Punch == i)  %>%
    droplevels()
  print(i)
  
  savecols <- as.character(colData$RNAseqID) 
  savecols <- as.vector(savecols) 
  countData <- a.countData %>% dplyr::select(one_of(savecols)) 

## create DESeq object using the factors Punch and APA
dds <- DESeqDataSetFromMatrix(countData = countData,
                              colData = colData,
                              design = ~ APA2)

dds # view the DESeq object - note numnber of genes
dds <- dds[ rowSums(counts(dds)) > 1, ]  # Pre-filtering genes with 0 counts
dds <- DESeq(dds) # Differential expression analysis

A <- listofDEGs("standard.trained","standard.yoked")
B <- listofDEGs("conflict.trained","standard.trained")
C <- listofDEGs("conflict.trained","conflict.yoked")
D <- listofDEGs("conflict.yoked","standard.yoked")


all <- rbind(A,B,C,D)

write.csv(all, file = paste("../data/02c_",i,"forupset.csv", sep = ""), row.names = F)
}

```




