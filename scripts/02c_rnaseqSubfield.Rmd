---
title: "02c_rnaseqSubfield"
output: md_document
---

## Subfield analysis

This script is used to identify treatement differences within each subfield, generate volcano plots, venn diagrams, and tables for subsequent GO analyses. The final mutlipanel figures for the manuscript have been inserted just below the subheadings. 

```{r setup, message=F, warning=F}
library(tidyverse)
library(cowplot) ## for some easy to use themes
library(DESeq2) ## for gene expression analysis
library(UpSetR)
library(ggtext) # for markdown in plots

library(BiocParallel)
register(MulticoreParam(6))

## load functions 
source("figureoptions.R")
source("functions_RNAseq.R")

## set output file for figures 
knitr::opts_chunk$set(fig.path = '../figures/02c_rnaseqSubfield/', cache = T)
```

## Get varience stabilized gene expression for each tissue

```{r DGdeseq}
a.colData <- read.csv("../data/02a_colData.csv", header = T)
a.countData <- read.csv("../data/02a_countData.csv", header = T, check.names = F, row.names = 1)

a.colData$training <- factor(a.colData$training, levels = c("yoked", "trained"))
a.colData$treatment <- factor(a.colData$treatment, levels = c("standard.yoked","standard.trained",
                                                  "conflict.yoked", "conflict.trained"))

DGdds <- returnddstreatment("DG") 
CA1dds <- returnddstreatment("CA1") 
CA3dds <- returnddstreatment("CA3") 

DGdds2 <- returndds2("DG") 
CA1dds2 <- returndds2("CA1") 
CA3dds2 <- returndds2("CA3") 

returnvsds(DGdds2, "../data/02c_DGvsd.csv")
returnvsds(CA1dds2, "../data/02c_CA1vsd.csv")
returnvsds(CA3dds2, "../data/02c_CA3vsd.csv")
```

## Results to compare with volcano plots

```{r twowaycontrasts}
print("DG")
res_summary_subfield(DGdds2, c("training", "trained", "yoked"))
res_summary_subfield(DGdds, c("treatment", "conflict.trained", "standard.trained"))
res_summary_subfield(DGdds, c("treatment", "conflict.yoked", "standard.yoked"))

print("CA3")
res_summary_subfield(CA3dds2, c("training", "trained", "yoked"))
res_summary_subfield(CA3dds, c("treatment", "conflict.trained", "standard.trained"))
res_summary_subfield(CA3dds, c("treatment", "conflict.yoked", "standard.yoked"))

print("CA1")
res_summary_subfield(CA1dds2, c("training", "trained", "yoked"))
res_summary_subfield(CA1dds, c("treatment", "conflict.trained", "standard.trained"))
res_summary_subfield(CA1dds, c("treatment", "conflict.yoked", "standard.yoked"))
```

## Volcano plots

```{r volcanos, fig.width=6.65, fig.height=4}
plot.volcano <- function(mydds, whichfactor, up, down, mycolors){
  res <- results(mydds, contrast =c(whichfactor, up, down),
                 independentFiltering = T, alpha = 0.1)
   data <- data.frame(gene = row.names(res),
                     padj = res$padj, 
                     logpadj = -log10(res$padj),
                     lfc = res$log2FoldChange)
  data <- na.omit(data)
  data <- data %>%
    dplyr::mutate(direction = ifelse(data$lfc > 0 & data$padj < 0.1, 
                                     yes = up, no = ifelse(data$lfc < 0 & data$padj < 0.1, 
                                                 yes = down, no = "NS")))
  data$direction <- factor(data$direction, levels = c(down, "NS", up))
  volcano <- data %>%
    ggplot(aes(x = lfc, y = logpadj)) + 
    geom_point(aes(color = direction), size = 1, alpha = 0.75, na.rm = T) + 
     theme_ms() +
    scale_color_manual(values = mycolors,
                       name = " ",
                       drop = FALSE) +
    ylim(c(0,12.5)) +  
    xlim(c(-8,8)) +
    labs(y = "-log10(p)", x = "log fold change")  +
    theme(legend.position = "top",
          legend.spacing.x = unit(-0.1, 'cm'),
          legend.margin=margin(t=-0.25, r=0, b=0, l=0, unit="cm"),
          panel.grid = element_blank()) 
  return(volcano)
}

# usage: mydds, whichfactor, up, down, mycolors, mysubfield
DG1 <- plot.volcano(DGdds2, "training", "trained", "yoked", volcano7) 
DG2 <-  plot.volcano(DGdds, "treatment", "conflict.trained", "standard.trained",  volcano2) 
DG3 <-  plot.volcano(DGdds, "treatment", "conflict.yoked", "standard.yoked",  volcano6) 

CA31 <- plot.volcano(CA3dds2, "training", "trained", "yoked", volcano7) 
CA32 <-  plot.volcano(CA3dds, "treatment", "conflict.trained", "standard.trained", volcano2) 
CA33 <-  plot.volcano(CA3dds, "treatment", "conflict.yoked", "standard.yoked", volcano6) 

CA11 <- plot.volcano(CA1dds2, "training", "trained", "yoked", volcano7) 
CA12 <-  plot.volcano(CA1dds, "treatment", "conflict.trained", "standard.trained", volcano2) 
CA13 <-  plot.volcano(CA1dds, "treatment", "conflict.yoked", "standard.yoked", volcano6) 



volcanos <- plot_grid(DG1 +  labs(x= NULL) + annotate("text", x = -7, y = 12, label = "DG"),
                      DG2  +  labs(x= NULL, y = " "), 
                      DG3 +  labs(x= NULL, y = " "),
                      
                      CA31 + theme(legend.position = "none") + labs(x= NULL) + 
                              annotate("text", x = -7, y = 12, label = "CA3"),
                      CA32 + theme(legend.position = "none") +  labs(x= NULL, y = " " ), 
                      CA33 + theme(legend.position = "none") +  labs(x= NULL, y = " "), 
                      
                      CA11 + theme(legend.position = "none") + 
                              annotate("text", x = -7, y = 12, label = "CA1"), 
                      CA12 + theme(legend.position = "none") +  labs(y= " " ), 
                      CA13 + theme(legend.position = "none") +  labs(y= " "), 
                      nrow = 3, rel_heights =  c(0.35,0.3,0.35) ,
                      labels =  c("a1", "b1", "c1",
                                  "a2", "b2", "c2",
                                  "a3", "b3", "c3"),
                      label_size = 7) 
volcanos

pdf(file="../figures/02c_rnaseqSubfield/volcanos.pdf", width=6.65, height=4)
plot(volcanos)    
dev.off()
```

# candidate genes

```{r DG_boxplots}
betterPlotCounts <- function(mygene, mydds, mysubfield){
  df <- plotCounts(mydds, mygene, intgroup = "treatment",  transform = F, replaced = F, returnData = T)
  names(df) <- c("count", "treatment")
  df$treatment <- factor(df$treatment, levels = c("standard.yoked","standard.trained",
                                                  "conflict.yoked", "conflict.trained"))
  
  #df <- df %>% filter(treatment %in% c("home.cage","standard.trained"))
  
  ggplot(df, aes(x = treatment, y = count)) +
    geom_boxplot(aes(fill = treatment)) + 
    geom_point() +
    labs(subtitle = paste(mysubfield, " *", mygene, "*",  sep = "")) +
    theme_classic() +
    theme(plot.subtitle  = element_markdown(),
          legend.position = "none", 
          panel.grid.major  = element_blank(),  # remove major gridlines
          panel.grid.minor  = element_blank()) + # remove minor gridlines) +
    scale_fill_manual(values = fourgroups) 

}

betterPlotCounts("Prkcz", DGdds, "DG")
betterPlotCounts("Dusp16", DGdds, "DG")
betterPlotCounts("Thbs1", DGdds, "DG")
betterPlotCounts("Slc16a1", DGdds, "DG")
betterPlotCounts("Hes5", DGdds, "DG")
betterPlotCounts("Rtl1", DGdds, "DG")

betterPlotCounts("Nlrp3", DGdds, "DG")
betterPlotCounts("Kcnc2", DGdds, "DG")
betterPlotCounts("1110008F13Rik", DGdds, "DG")

a <- betterPlotCounts("Irs1", DGdds, "DG") + labs(title = "wald = -6, p = 1.577782e-06")
b <- betterPlotCounts("Dab2ip", DGdds, "DG")  + labs(title = "wald =  5, p = 3.227358e-05")
plot_grid(a,b)

```

```{r CA1_boxplots}
betterPlotCounts("Prkcz", CA1dds, "CA1")
betterPlotCounts("Grm1", CA1dds, "CA1")
betterPlotCounts("Grin2b", CA1dds, "CA1")
betterPlotCounts("Foxj3", CA1dds, "CA1")
betterPlotCounts("Grik3", CA1dds, "CA1")
betterPlotCounts("0610010K14Rik", CA1dds, "CA1")
```

```{r pkrcs}
a <- betterPlotCounts("Prkcz", CA1dds, "CA1")
b <- betterPlotCounts("Prkcz", CA3dds, "CA3")
c <- betterPlotCounts("Prkcz", DGdds, "DG")

d <- betterPlotCounts("Prkci", CA1dds, "CA1")
e <- betterPlotCounts("Prkci", CA3dds, "CA3")
f <- betterPlotCounts("Prkci", DGdds, "DG")

plot_grid(a,b,c,d,e,f)
```

## genes that are correlated with number of entrances 

Requires anlaysis of `04_integration.Rmd` first.

```{r DGcorrelations}
plotCounts(DGdds, "Acan", intgroup = "treatment", normalized = TRUE, main="Acan in DG")
plotCounts(DGdds, "Amigo2", intgroup = "treatment", normalized = TRUE, main="Amigo2 in DG")
plotCounts(DGdds, "Armcx5", intgroup = "treatment", normalized = TRUE, main="Armcx5 in DG")
plotCounts(DGdds, "Ptgs2", intgroup = "treatment", normalized = TRUE, main="Ptgs2 in DG")
plotCounts(DGdds, "Rgs2", intgroup = "treatment", normalized = TRUE, main="Rgs2 in DG")
plotCounts(DGdds, "Syt4", intgroup = "treatment", normalized = TRUE, main="Syt4 in DG")
```

## Upset plots

What genes overlap within cetain comparisons?

```{r upsetplotprep}
a.colData <- read.csv("../data/02a_colData.csv", header = T)
a.countData <- read.csv("../data/02a_countData.csv", header = T, check.names = F, row.names = 1)

eachsubfield <- levels(a.colData$Punch)

listofDEGs <- function(group1, group2){
  res <- results(dds, contrast = c("treatment", group1, group2), independentFiltering = T)
  
  print(paste(group1,group2, sep = " vs "))
  print(summary(res))
  
  data <- data.frame(gene = row.names(res),
                     lfc = res$log2FoldChange,
                     padj = res$padj,
                     tissue = i,
                     comparison = paste(group1, group2, sep = "-"))
  data <- data %>% dplyr::filter(padj < 0.1) %>% droplevels()
  return(data)
}

for(i in eachsubfield){
  
  colData <- a.colData %>% 
    dplyr::filter(Punch == i)  %>%
    droplevels()
  print(i)
  
  savecols <- as.character(colData$RNAseqID) 
  savecols <- as.vector(savecols) 
  countData <- a.countData %>% dplyr::select(one_of(savecols)) 

## create DESeq object using the factors Punch and APA
dds <- DESeqDataSetFromMatrix(countData = countData,
                              colData = colData,
                              design = ~ treatment)

dds # view the DESeq object - note numnber of genes
dds <- dds[ rowSums(counts(dds)) > 1, ]  # Pre-filtering genes with 0 counts
dds <- DESeq(dds, parallel = TRUE) # Differential expression analysis

A <- listofDEGs("standard.trained","standard.yoked")
B <- listofDEGs("conflict.trained","standard.trained")
C <- listofDEGs("conflict.trained","conflict.yoked")
D <- listofDEGs("conflict.yoked","standard.yoked")

all <- rbind(A,B,C,D)

write.csv(all, file = paste("../data/02c_",i,"forupset.csv", sep = ""), row.names = F)
}
```

