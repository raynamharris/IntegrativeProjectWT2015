---
title: "02e_correlations"
output: md_document
---

```{r setup}
library(tidyverse) 
library(corrplot)
library(cowplot)
library(corrr)
#devtools::install_github("clauswilke/ggtext")
library(ggtext)

source("figureoptions.R")

theme_ms <- function () { 
  theme_classic(base_size = 8) +
    theme(
      panel.grid.major  = element_blank(),  # remove major gridlines
      panel.grid.minor  = element_blank(),  # remove minor gridlines
      plot.title = element_text(hjust = 0.5, face = "bold") # center & bold 
    )
}

theme2 <- function () { 
  theme_minimal(base_size = 7) +
    theme(
      panel.grid.major  = element_blank(),  # remove major gridlines
      panel.grid.minor  = element_blank() # remove minor gridlines
    )
}

knitr::opts_chunk$set(fig.path = '../figures/02e_correlations/', cache = F)
```    
For this analysis, I want to explor correlations between a behavioral measure and gene expression.

```{r behavior}
# import behavior data, create mouse id, select relvant samples
behav <- read.csv("../data/01a_behavior.csv") 
behav$mouse <- sapply(strsplit(as.character(behav$ID),"15"), "[", 2)
behav <- behav %>% filter( #treatment %in% c("conflict.trained", "standard.trained"),
                                  TrainSessionCombo == "Retention") %>% 
                           select(mouse,Entr.Dist.1.m.,MaxTimeAvoid) 
head(behav)
```
```{r pca}
pcadata <- read_csv("../data/01a_pcadf.csv") %>%
  filter(#treatment %in% c("conflict.trained", "standard.trained"),
         TrainSessionComboNum == 9) %>%
  select(ID,PC1,PC2) 
pcadata$mouse <- sapply(strsplit(as.character(pcadata$ID),"15"), "[", 2)
pcadata$ID <- NULL
head(pcadata)
```

```{r DEGs}
DG_DEGs <- read.csv("../data/02f_DG_DEGs_vsd.csv", row.names = 1, check.names = F)
DG_DEGs <- as.data.frame(t(DG_DEGs))
DG_DEGs$sample <- row.names(DG_DEGs)
DG_DEGs$mouse <- sapply(strsplit(as.character(DG_DEGs$sample),"\\-"), "[", 1)
DG_DEGs <- DG_DEGs %>% select(mouse,`1190002N15RIK`:ZFP869)
head(DG_DEGs)[1:5]
```

```{r joining}
DEGsPCA <- left_join(DG_DEGs, pcadata)
DEGsPCAbeahv <- left_join(DEGsPCA, behav)
DEGsPCAbeahv <- as.data.frame(DEGsPCAbeahv)
row.names(DEGsPCAbeahv) <- DEGsPCAbeahv$mouse
DEGsPCAbeahv$mouse <- NULL
DEGsPCAbeahv <- as.matrix(DEGsPCAbeahv)
```

```{r corrr}
DGcor <- DEGsPCAbeahv %>% correlate() %>% rearrange() %>%  shave()
DGcor

DGcorSlim <- correlate(DEGsPCAbeahv) %>%  
  focus(PC1)   %>%  
  arrange(PC1)
DGcorSlim

DGcorarranged <- fashion(DGcorSlim) %>% arrange(desc(PC1))
head(DGcorarranged)
```

```{r DEGvPCA}
mousetreatment <- read_csv("../data/01a_behavior.csv")  %>%
  filter(TrainSessionCombo == "Retention") %>%
  mutate(mouse = sapply(strsplit(as.character(ID),"15"), "[", 2)) %>%
  select(mouse, treatment)


DEGsPCAbeahvDf <- as.data.frame(DEGsPCAbeahv)
DEGsPCAbeahvDf$mouse <- row.names(DEGsPCAbeahvDf)
DEGsPCAbeahvDf <- left_join(mousetreatment, DEGsPCAbeahvDf)

summary(lm(ARC ~ PC1, data = DEGsPCAbeahvDf))
summary(lm(FOSL2 ~ PC1, data = DEGsPCAbeahvDf))


a <- ggplot(DEGsPCAbeahvDf, aes(x = PC1, y = ARC)) +
  geom_point(aes(color = treatment)) + geom_smooth(method='lm', colour = "darkgrey")  +
  labs(y = "ARC expression in DG \n (variance stabilized)", 
       x = "behavior PC1 \n increasing avoidance behavior -->",
       subtitle = "R2 = 0.6235, p = 0.00016693") +
  theme_ms() +
  scale_color_manual(values = treatmentcolors) + theme(legend.position = "none")
  
b <- ggplot(DEGsPCAbeahvDf, aes(x = PC1, y = FOSL2)) +
  geom_point(aes(color = treatment)) + geom_smooth(method='lm', colour = "darkgrey") +
  labs(y = "FOSL2 expression in DG \n (variance stabilized)", 
       x = "behavior PC1 \n increasing avoidance behavior -->",
       subtitle = "R2 = 0.5433, p = 0.0006778") +
    theme_ms() +
  scale_color_manual(values = treatmentcolors) + theme(legend.position = "none")

plot_grid(a,b)
```
```{r DEGnCandidatesvPCA}

allDGvsd <- read.csv("../data/02c_DGvsd.csv", check.names = F, stringsAsFactors = F, row.names = 1)
allDGvsd <- as.data.frame(t(allDGvsd))

allDGvsd$ID <- row.names(allDGvsd)
allDGvsd$mouse <- sapply(strsplit(as.character(allDGvsd$ID),"-"), "[", 1)
allDGvsd <- left_join(mousetreatment, allDGvsd)
allDGvsd <- left_join(pcadata, allDGvsd)

summary(lm(Prkcz ~ PC1, data = allDGvsd))
summary(lm(Camk2a ~ PC1, data = allDGvsd))

c <- ggplot(allDGvsd, aes(x = PC1, y = Prkcz)) +
  geom_point(aes(color = treatment)) + geom_smooth(method='lm', colour = "darkgrey") +
  labs(y = "PRKCZ expression in DG \n (variance stabilized)", 
       x = "behavior PC1 \n increasing avoidance behavior -->",
       subtitle = "R2 = 0.06323 , p = 0.1779") +
    theme_ms() +
  scale_color_manual(values = treatmentcolors) + theme(legend.position = "none")

summary(lm(Camk2a ~ PC1, data = allDGvsd))

d <- ggplot(allDGvsd, aes(x = PC1, y = Camk2a)) +
  geom_point(aes(color = treatment)) + geom_smooth(method='lm', colour = "darkgrey") +
  labs(y = "CAMK2A expression in DG \n (variance stabilized)", 
       x = "behavior PC1 \n increasing avoidance behavior -->",
       subtitle = "R2 = 0.01841, p = 0.2767") +
    theme_ms() +
  scale_color_manual(values = treatmentcolors) + theme(legend.position = "none")

plot_grid(a + theme(axis.title.x = element_blank()),
          b + theme(axis.title.x = element_blank()),
          c,d, rel_heights = c(0.45, 0.55))
```


```{r CandidatesvPCA}

plotPCAvcandidates <- function(filename){
  allvsd <- read.csv(filename, check.names = F, stringsAsFactors = F, row.names = 1)
  allvsd <- as.data.frame(t(allvsd))

  allvsd$ID <- row.names(allvsd)
  allvsd$mouse <- sapply(strsplit(as.character(allvsd$ID),"-"), "[", 1)
  allvsd <- left_join(mousetreatment, allvsd)
  allvsd <- left_join(pcadata, allvsd)
  
  print(summary(lm(Arc ~ PC1, data = allvsd)))
  print(summary(lm(Camk2a ~ PC1, data = allvsd)))
  print(summary(lm(Gria1 ~ PC1, data = allvsd)))
  print(summary(lm(Grin1 ~ PC1, data = allvsd)))
  print(summary(lm(Prkci ~ PC1, data = allvsd)))
  print(summary(lm(Prkcz ~ PC1, data = allvsd)))

  candidatevsdPCA <- allvsd %>% select(mouse, treatment, PC1, PC2, mouse,
                                       Arc, Camk2a, Gria1, Grin1, Prkci, Prkcz)
  candidatevsdPCA <- gather(candidatevsdPCA, gene, expression, Arc:Prkcz, factor_key=TRUE) %>% drop_na()

  p <- ggplot(candidatevsdPCA, aes(x = PC1, y = expression)) +
    geom_point(aes(color = treatment)) + geom_smooth(method='lm', colour = "darkgrey") +
    labs(y = "gene expression", 
        x = "PC1 (estimate of increasing avoidance behavior)") +
      theme_ms() +
    scale_color_manual(values = treatmentcolors) + theme(legend.position = "none") +
    facet_wrap(~gene, scales = "free_y", nrow = 1) +
    theme(axis.text.x = element_blank()) +
    scale_y_continuous(labels = scales::number_format(accuracy = 0.1))
  return(p)
}

p1 <- plotPCAvcandidates("../data/02c_DGvsd.csv")
p1
p2 <- plotPCAvcandidates("../data/02c_CA3vsd.csv")
p2
p3 <- plotPCAvcandidates("../data/02c_CA1vsd.csv")
p3

plot_grid(p1 + theme(axis.title.x = element_blank()),
          p2 + theme(axis.title.x = element_blank(),
                     strip.background = element_blank(), strip.text = element_blank()),
          p3 + theme(strip.background = element_blank(), strip.text = element_blank()), 
          nrow = 3, labels = c("DG", "CA3", "CA1"), label_size =  6,
          rel_heights = c(0.35,0.3,0.35))

```