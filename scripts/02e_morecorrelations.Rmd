---
title: "02e_morecorrelations"
output: md_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

knitr::opts_chunk$set(fig.path = '../figures/02e_correlations/', cache = T, cache.lazy = FALSE)
```


```{r packages}
library(tidyverse)
library(corrr)
library(cowplot)

source("./figureoptions.R")

```


```{r DGDEGs}

# lists of genes that are correlated with particular genes
ARC_associated <- read_csv("../data/02h_ARC_associated.csv")  %>% mutate_each(funs=toupper)  %>% dplyr::pull(gene) 
Neurod6_associated <- read_csv("../data/02h_Neurod6_associated.csv") %>% mutate_each(funs=toupper)  %>% dplyr::pull(gene) 
Prkcz_associated <- read_csv("../data/02h_Prkcz_associated.csv") %>% mutate_each(funs=toupper)  %>% dplyr::pull(gene) 

# differentially expressed gens in the DG
DG_DEGs <- read.csv("../data/02f_DG_DEGs_vsd.csv", row.names = 1, check.names = F)
DG_DEGs <- as.data.frame(t(DG_DEGs))
DG_DEGs$sample <- row.names(DG_DEGs)
DG_DEGs <- DG_DEGs %>% select(`1190002N15RIK`:ZFP869)
DG_DEGs <- as.data.frame(t(DG_DEGs))
DG_DEGs$gene <- row.names(DG_DEGs)

# only look at Differentially expressed genes in the ARC module
DG_ARC <- DG_DEGs %>% filter(gene %in% ARC_associated) %>% select(gene, everything())
row.names(DG_ARC) <- DG_ARC$gene
DG_ARC$gene <- NULL
DG_ARC <- as.data.frame(t(DG_ARC))
DG_ARC$sample  <- row.names(DG_ARC)
DG_ARC$mouse <- sapply(strsplit(as.character(DG_ARC$sample),"\\-"), "[", 1)
DG_ARC$ID <- paste(15, DG_ARC$mouse, sep = "")

# read the sample data, set levels, join iwth behvior PCA data
colData <- read.csv("../data/02a_colData.csv", row.names = 1, stringsAsFactors = T)
colData <- colData %>% filter(subfield == "DG")
pca.Rn <- read_csv("../data/01a_pca.all.csv") %>% filter(trialNum == 9)
pca.Rn <- pca.Rn %>% select(ID:PC2)
colData <- left_join(colData, pca.Rn)
head(colData)

# joing with counts and sample data, prep for correlations
alldata <- left_join(colData, DG_ARC)
forcorplots <- alldata %>% select(PC1:UBC)
forcorplots

# correlation matrix
x <- correlate(forcorplots)

x %>% filter(PC1 > 0.755) %>% arrange(desc(PC1))  %>% select(rowname, PC1, PC2)
```

```{r correlations}
cor.test(alldata$ARC, alldata$PC1, method = "pearson")
cor.test(alldata$ARC, alldata$PC2, method = "pearson")


a <- ggplot(alldata, aes(x = PC1, y = ARC)) +
   geom_point(aes( color = treatment)) + 
   geom_smooth(method = "lm", color = "grey") +
   scale_color_manual(values = treatmentcolors) +
   theme_ms() +
   theme(legend.position = "none") +
  labs(subtitle = "R2 = 0.81, p = 0.0002")
  

b <- ggplot(alldata, aes(x = PC2, y = ARC)) +
   geom_point(aes( color = treatment)) + 
   geom_smooth(method = "lm", color = "grey") +
   scale_color_manual(values = treatmentcolors) +
   theme_ms() +
   theme(legend.position = "none") +
  labs(subtitle = "R2 = -0.63, p = 0.009")

plot_grid(a,b)

```


```{r DGvsd}
# read all count data
vsd <- read.csv("../data/02c_DGvsd.csv", row.names = 1, check.names = F)

# prep to join with sample colData
vsd <- as.data.frame(t(vsd))
vsd$sample <- row.names(vsd)
vsd$mouse <- sapply(strsplit(as.character(vsd$sample),"\\-"), "[", 1)
vsd$ID <- paste(15, vsd$mouse, sep = "")

vsd <- left_join(colData, vsd)
head(vsd)[17015:17020]

forcorall <-  vsd %>% select(PC1:Zzz3)
head(forcorall)

corrrmat <- correlate(forcorall, diagonal = 1) 
head(corrrmat)
```

```{r corrrplots}
summary(lm( PC1 ~ Arc, data = vsd))
summary(lm( PC2 ~ Arc, data = vsd))


cor.test(vsd$PC1, vsd$Arc, method = c("pearson"))
cor.test(vsd$PC2, vsd$Arc, method = c("pearson"))
cor.test(vsd$Jun, vsd$Arc, method = c("pearson"))



a <- ggplot(vsd, aes(x = PC1, y = Arc)) +
   geom_point(aes( color = treatment)) + 
   geom_smooth(method = "lm", color = "grey") +
   scale_color_manual(values = treatmentcolors) +
   theme(legend.position = "none", axis.text.x = element_blank())  +
   annotate("text", x = 0, y = 11.5, label = "R2 = 0.81, p = 0.0002")
b <- ggplot(vsd, aes(x = PC2, y = Arc)) +
   geom_point(aes( color = treatment)) + 
   geom_smooth(method = "lm", color = "grey") +
   scale_color_manual(values = treatmentcolors) +
   theme(legend.position = "none", axis.text.x = element_blank(),
         axis.text.y = element_blank(), axis.title.y = element_blank())  +
   annotate("text", x = 2, y = 11.5, label = "R2 = -0.63, p = 0.009")

c <- ggplot(vsd, aes(x = Jun, y = Arc)) +
   geom_point(aes( color = treatment)) + 
   geom_smooth(method = "lm", color = "grey") +
   scale_color_manual(values = treatmentcolors) +
   theme(legend.position = "none", 
         axis.text.x = element_blank(),
         axis.text.y = element_blank(), 
         axis.title.y = element_blank())  +
   annotate("text", x = 9.5, y = 11.5, label = "R2 = 85, p = 2.801e-05")
c

top <- plot_grid(a,b, c, rel_widths = c(0.4,0.3, 0.3), nrow = 1)
top

slim <- corrrmat %>% 
  focus(PC1, PC2)  %>% 
  arrange(desc(PC1)) %>% 
  filter(PC1 > 0.801 | PC2 > 0.69) 
slim

topcorrrs <- slim$rowname
topcorrrs


p1 <- corrrmat %>% 
  focus(PC1, PC2, topcorrrs,  mirror = TRUE) %>% 
  rearrange() %>% 
  network_plot(colors = c("#67a9cf", "#ef8a62"),
               min_cor = .6, curved = F, legend = F,
               repel = TRUE) 
p1 


library(ggcorrplot)

corrrmat2 <- corrrmat %>% 
  focus(PC1, PC2, topcorrrs,  mirror = TRUE) 


corrrmat2 <- as.data.frame(corrrmat2)
row.names(corrrmat2) <- corrrmat2$rowname
corrrmat2$rowname <- NULL
corrrmat2 <- as.matrix(corrrmat2)
head(corrrmat2)

ggcorrplot(corrrmat2)

ggcorrplot(corrrmat2, hc.order = TRUE, type = "lower",
     outline.col = "white")

ggcorrplot(corrrmat2, hc.order = TRUE,
   outline.col = "white",
   ggtheme = ggplot2::theme_gray,
   colors = c("#67a9cf", "white",   "#ef8a62"),
  method = "circle")

library(pheatmap)
library(colorRampPalette)
pheatmap(corrrmat2)


mypheatmap <- pheatmap(corrrmat2, 
           treeheight_row = 0, treeheight_col = 50,
         labels_col = F,
           fontsize = 7, 
         colors = c("#67a9cf","white","#ef8a62"))  
mypheatmap

comparisons <- ggdraw() +  draw_image(mypheatmap)
comparisons
```







```{r}

p2 <- corrrmat %>% 
  focus(PC1, PC2, topcorrrs,  mirror = TRUE) %>% 
   focus(PC1, PC2) %>%
  mutate(rowname = reorder(rowname, PC1)) %>%
  ggplot(aes(rowname, PC1, fill = PC1)) +
    geom_col() + coord_flip() +
  scale_fill_gradient2(low = "#67a9cf",  high = "#ef8a62", midpoint = 0) +
  #theme_ms() +
  theme(legend.position = "none") +
  ylim(-1,1) +
  labs(x = NULL, y = "Correlation to PC1")
p2 

p3 <- corrrmat %>% 
  focus(PC1, PC2,topcorrrs,  mirror = TRUE) %>% 
   focus(PC1, PC2) %>%
  mutate(rowname = reorder(rowname, PC1)) %>%
  ggplot(aes(rowname, PC2, fill = PC2)) +
    geom_col() + coord_flip() +
  scale_fill_gradient2(low = "#67a9cf",  high = "#ef8a62", midpoint = 0) +
  #theme_ms() +
  theme(legend.position = "none", axis.text.y = element_blank()) +
  ylim(-1,1) +
  labs(x = NULL, y = "Correlation to PC2")
p3


bottom <- plot_grid(p2,p3,p1,  nrow = 1, rel_widths = c(0.4,0.3,0.4))
bottom


plot_grid(top, bottom, nrow = 2, rel_heights = c(0.45,0.55))

```

```{r citation}
citation("corrr")
```

