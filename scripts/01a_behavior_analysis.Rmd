---
title: "Behavior Data Analysis"
output: md_document
---

This markdown file is used for behavioral data wrangling, statistical analysis, and data visualization. Figures from this analysis were assembled into this multi-panel plot using Adobe Illustrator. Files used to create the individual figures are saved in the data subdirectory with the prefix 01a.

<img src="../figures/figure_2.png" width="1370" />

## Setup

```{r setup, message=F}
## load libraries 
library(tidyverse) ## for respahing data
library(plyr) ## for renmaing factors
library(reshape2) ## for melting dataframe
library(cowplot) ## for some easy to use themes
library(factoextra)  ##pca with vectors
library(car) ## stats
library(pheatmap)  # for pretty heatmap
library(viridis) # for awesome color pallette
library(kableExtra) # for better markdown tables

## load user-written functions 
source("functions_behavior.R")
source("figureoptions.R")

## set output file for figures 
knitr::opts_chunk$set(fig.path = '../figures/01_behavior/')
```

## Sample sizes

The 'APA2' column describes the four behavioral treatment groups.  
The 'TrainSessionCombo' column describes the behvioral training sessions. Here I filter by a single session to calculte the number of mice. 

```{r wrangledata, message=F}
## import output from video tracker program 
behavior <- read.csv("../data/01_behaviordata.csv", header = T)

## set level for APA2 then renmae
behavior$APA2 <- factor(behavior$APA2, levels = c("YokedSame", "Same", "YokedConflict","Conflict"))
levels(behavior$APA2) <-  c("yoked-consistent" ,"consistent", "yoked-conflict", "conflict")

# sample sizes
behavior %>% 
  filter(TrainSessionCombo == "Retention") %>%
  select(APA2)  %>%  summary()

# keep subset of columns for downstream vizuals
behavior_slim <- behavior[,c(15,16,14,20:58)] 
```


# Vizualizing Mean and Standard error for num entrace and time 1st entrance

To make the point and line graphs, I must create and join some data frames, then I have a function that makes four plots with specific titles, y labels and limits.

```{r fourmeasures}
a <- behavior %>%
  dplyr::group_by(APA2, TrainSessionComboNum) %>%
  dplyr::summarise(m = mean(NumEntrances), 
                   se = sd(NumEntrances)/sqrt(length(NumEntrances))) %>%
  dplyr::mutate(measure = "Number of target zone entrances")

b <- behavior %>%
  dplyr::group_by(APA2, TrainSessionComboNum) %>%
  dplyr::summarise(m = mean(pTimeTarget), 
                   se = sd(pTimeTarget)/sqrt(length(pTimeTarget))) %>%
  dplyr::mutate(measure = "Proportion of time in target zone")

c <- behavior %>%
  dplyr::group_by(APA2, TrainSessionComboNum) %>%
  dplyr::mutate(minutes = Time1stEntr/60) %>%
  dplyr::summarise(m = mean(minutes), 
                   se = sd(minutes)/sqrt(length(minutes))) %>%
  dplyr::mutate(measure = "Time to 1st target zone entrance (min)")

d <- behavior %>%
  dplyr::group_by(APA2, TrainSessionComboNum) %>%
  dplyr::summarise(m = mean(pTimeOPP), 
                   se = sd(pTimeOPP)/sqrt(length(pTimeOPP))) %>%
  dplyr::mutate(measure = "Proportion of time opposite the target zone")

fourmeasures <- rbind(a,b,c,d)
head(fourmeasures)


fourmeasures$APA2 <- factor(fourmeasures$APA2, levels = c("yoked-consistent" ,"consistent", "yoked-conflict", "conflict"))

# see https://cran.r-project.org/web/packages/cowplot/vignettes/shared_legends.html for share legends

meansdplots <- function(df, mytitle, myylab, ybreaks, ylims){
  myplot <- ggplot(df, 
                  aes(x=, TrainSessionComboNum, y=m, color=APA2)) + 
    geom_errorbar(aes(ymin=m-se, ymax=m+se, color=APA2), width=.1) +
    geom_point(size = 1.5) +
    geom_line() +
    labs(subtitle = mytitle) +
    scale_y_continuous(name= myylab,
                       breaks = ybreaks,
                       limits = ylims) +
    scale_x_continuous(name= "Training session", 
                       breaks = c(1, 2, 3, 4, 5, 6, 7, 8, 9),
                       labels = c( "P", "T1", "T2", "T3",
                                   "Rt", "T4", "T5", "T6", "Rn")) +
    theme_cowplot(font_size = 7, line_size = 0.25) +
    background_grid(major = "y", minor = "y") +
    scale_color_manual(values = colorvalAPA00,
                       name  = NULL)  +
    theme(legend.position = "bottom",
          legend.justification=c(0,0),
        legend.text=element_text(size=5))
  return(myplot)
}  

A <- meansdplots(a, "Number of target zone entrances" , "Counts", c(0,10,20,30), c(0, 35))
B <- meansdplots(b, "Proportion of time in target zone", "Proportion", c(0,.12,.25,.37), c(0, .37 ))
C <- meansdplots(c, "Time to 1st target zone entrance", "Time (min)", c(0,2,4,6,8), c(0, 8))
D <- meansdplots(d, "Proportion of time opposite the target zone", "Proportion", c(0.25, .5, .75), c(0.1, .75))


plotnolegend <- plot_grid(A + theme(legend.position="none"),
           B + theme(legend.position="none"),
           C + theme(legend.position="none"),
           D + theme(legend.position="none"),
           #align = 'vh',
           labels = "AUTO",
           nrow = 2,
           label_size = 8
           )
legend <- get_legend(A)

fourplots <- plot_grid(plotnolegend, legend, ncol = 1, rel_heights = c(1, .1))
fourplots

pdf(file="../figures/01_behavior/fourmeasures.pdf", width=5.1, height=4.1)
plot(fourplots)
dev.off()


plotone <- plot_grid(A + theme(legend.position="none"),
           C + theme(legend.position="none"),
           labels = c("A","C"),
           nrow = 2,
           label_size = 7
           )

plottwo <- plot_grid(B + theme(legend.position="none"),
           D + theme(legend.position="none"),
           labels = c("B","D"),
           nrow = 2,
           label_size = 7
           )

pdf(file="../figures/01_behavior/twomeasuresAC.pdf", width=2.3, height=3)
plot(plotone)
dev.off()

pdf(file="../figures/01_behavior/twomeasuresBD.pdf", width=2.3, height=3)
plot(plottwo)
dev.off()


```



## Hierarchical clusering of time series behavioral data

Here I use heirarhical cluster to identify patterns in the behavioral data. On the y axis see three distinct clusters of behaviors that are 1) higher in trained animals, 2) higher in yoked animals, and 3) measures of speed. 

```{r pheatmap2,  message=FALSE}
## create scaled data frame
behavior_slim_heat <- behavior_slim %>%
  filter(TrainSessionCombo != "Hab")

behavior_slim_heat$RayleigAngle <- NULL
behavior_slim_heat$PolarMinBin <- NULL
scaledaveragedata <- as.data.frame(makescaledaveragedata(behavior_slim_heat))

## make annotation df and ann_colors for pheatmap
ann_cols <- as.data.frame(makecolumnannotations(scaledaveragedata))
ann_colors = ann_colors_APA2

# set color breaks
paletteLength <- 30
myBreaks <- c(seq(min(scaledaveragedata), 0, length.out=ceiling(paletteLength/2) + 1), 
              seq(max(scaledaveragedata)/paletteLength, max(scaledaveragedata), length.out=floor(paletteLength/2)))

## pheatmap for markdown
pheatmap(scaledaveragedata, show_colnames=T, show_rownames = T,
         annotation_col=ann_cols, 
         annotation_colors = ann_colors,
         treeheight_row = 0, treeheight_col = 50,
         border_color = "grey60" ,
         color = viridis(30),
         clustering_method="average",
         breaks=myBreaks,
         clustering_distance_cols="correlation" ,
         clustering_distance_rows = "correlation"
         )

# pheatmapfor adobe
pheatmap(scaledaveragedata, show_colnames=F, show_rownames = F,
         annotation_col=ann_cols, annotation_colors = ann_colors,
         annotation_names_col = F,
         treeheight_row = 0, treeheight_col = 15,
         fontsize = 6, 
         border_color = "grey60" ,
         color = viridis(30),
          width = 3, height = 2,
         clustering_method="average",
         breaks=myBreaks,
         clustering_distance_cols="correlation",
         filename = "../figures/01_behavior/pheatmap2.pdf",
         legend = TRUE,
         annotation_legend = FALSE
         )

```


### Principle component analysis 

Next, I next reduced the dimentionality of the data with a PCA anlaysis. 

```{r PCA}
dataforpca <- behavior %>%
  filter(TrainSessionCombo != "Hab")

longdata <- makelongdata(dataforpca)

Z <- longdata[,3:322]
Z <- Z[,apply(Z, 2, var, na.rm=TRUE) != 0]
pc = prcomp(Z, scale.=TRUE)
loadings <- pc$rotation
scores <- pc$x

scoresdf <- makepcadf(dataforpca) #create the df of pcas
rotationdf <- mkrotationdf(dataforpca) #loadings for specific factors

behaviormatrix <- behavior[c(20:58)]  # for 2nd pca analysis
scoresdf$PC1 <- scoresdf$PC1 * -1
scoresdf$APA2 <- factor(scoresdf$APA2, levels = c("yoked-consistent" ,"consistent", "yoked-conflict", "conflict"))


## data wraningly for pca anlysis
behaviormatrix %>% 
  scale() %>%                 # scale to 0 mean and unit variance
  prcomp() ->                 # do PCA
  pca                         # store result as `pca`
percent <- round(100*pca$sdev^2/sum(pca$sdev^2),2)
perc_data <- data.frame(percent=percent, PC=1:length(percent))
res.pca <- prcomp(behaviormatrix,  scale = TRUE)

# plot of percent contribution
ggplot(perc_data, aes(x=PC, y=percent)) + 
  geom_bar(stat="identity") + 
  geom_text(aes(label=round(percent, 2)), size=4, vjust=-.5) + 
  xlim(0, 10)


## print anova and TukeyHSD stats for first 6 PCs
j <- 0
for (i in (scoresdf[,c(1:6)])){
  j <- j+1
  print(paste("PC", j, sep = " "))
  myaov <- aov(i ~ APA2, data=scoresdf)
  print(summary(myaov))
  print(TukeyHSD(myaov, which = "APA2"))
}

pca12elipse <- ggplot(scoresdf, aes(PC1,PC2, color=APA2)) +
    geom_point(size=2.5, alpha = 0.7) +
    xlab(paste0("PC 1: ", percent[1],"% variance")) +
    ylab(paste0("PC 2: ", percent[2],"% variance")) +
    stat_ellipse(level = 0.95, (aes(color=APA2)),size=0.25) + 
    scale_colour_manual(values=c(colorvalAPA00)) + 
    theme_cowplot(font_size = 7, line_size = 0.25) +
    theme(legend.position="none") 
pca12elipse

pdf(file="../figures/01_behavior/pca12elipse.pdf",  width=2, height=2)
plot(pca12elipse)
dev.off()

pcalegend <- ggplot(scoresdf, aes(PC1,PC2, color=APA2)) +
    geom_point(size=2.5, alpha = 0.7) +
    xlab(paste0("PC 1: ", percent[1],"% variance")) +
    ylab(paste0("PC 2: ", percent[2],"% variance")) +
    stat_ellipse(level = 0.95, (aes(color=APA2)),size=0.25) + 
    scale_colour_manual(values=c(colorvalAPA00)) + 
    theme_cowplot(font_size = 7, line_size = 0.25) +
    theme(legend.position="bottom",
          legend.title=element_blank()) 
pcalegend

pdf(file="../figures/01_behavior/pcalegend.pdf",  width=4, height=2)
plot(pcalegend)
dev.off()

# PCA with contributions
res.pca <- prcomp(behaviormatrix, scale = TRUE)
fviz_pca_var(res.pca,
             col.var = "contrib", # Color by contributions to the PC
             gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
             repel = TRUE,     # Avoid text overlapping
             select.var = list(contrib = 8))
```

### Comparing Consistent and Conflict behaviors during the T4/C1 training session

```{r T4consistentconflict}
filtered <- behavior_slim %>% filter(TrainSessionCombo == "T4_C1", APA != "control") 
exp_factors <- as.data.frame(filtered[,1])
exp_nums <- filtered[,c(4:42)]
exp_factors$APA2 <- factor(filtered$APA2, levels = c("consistent", "conflict"))

# Levene's test for normality
#for(y in names(exp_nums)){
#  ymod <- leveneTest(exp_nums[[y]] ~ exp_factors$APA2)
#  cat(paste('\nDependent var:', y, '\n'))
#  print(ymod)
#}

# Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1
# *** Speed1, Path2ndEntr, Time2ndEntr, Path2ndEntr, Time2ndEntr
# ** Path1stEntr, Time1stEntr
# *  Max50.RngHiBin ,  PolarMaxBin  , PolarMinVal, RayleigAngle, pTimeCW, pTimeOPP,
# .  Speed2, Min50.RngLoBin , TimeTarget, NumShock, NumEntrances
#    AnnularKurtosis, AnnularSkewnes, AnnularSd, AnnularMaxBin, AnnularMaxVal, AnnularMinBin, AnnularMinVal, Max50.RngLoBin, RayleigLength PolarMaxVal, Min50.RngHiBin , PolarMinBin, PolarSdVal, PolarAvgVal, RayleigLength, pTimeTarget, Speed2ndEntr, MaxTimeAvoid, Dist1stEntr.m, Speed1stEntr.cm.s, Linearity.Arena, SdevSpeedArena

for(y in names(exp_nums)){
  ymod <- wilcox.test(exp_nums[[y]] ~ exp_factors$APA2 )
  cat(paste('\nDependent var:', y, '\n'))
  print(ymod)
}

# *** Path2ndEntr 
# **  Speed2, PolarMinVal, pTimeOPP, pTimeTarget, TimeTarget, Time2ndEntr, NumShock
# **  Dist1stEntr.m., Path1stEntr , Time1stEntr, NumEntrances
# *   PolarSdVal, PolarAvgVal 
# .    
#     Speed1, AnnularKurtosis, AnnularSkewnes, AnnularSd, AnnularAvg, AnnularMaxBin,
#     AnnularMaxVal, AnnularMinBin, AnnularMinVal, Max50.RngHiBin , PolarMaxBin, 
#     PolarMaxVal, Min50.RngHiBin, Min50.RngLoBin, PolarMinBin, RayleigAngle
#     RayleigLength, pTimeCW, pTimeCCW, Speed2ndEntr, MaxTimeAvoid, Speed1stEntr.cm.s., #     Linearity.Arena., SdevSpeedArena 
 
par(mfrow=c(3,3))
for(y in names(exp_nums)){
  ymod <- boxplot(exp_nums[[y]] ~ exp_factors$APA2,
               main = y,
               xlab = "T4/C1")
}
```

### Comparing Consistent and Conflict behaviors during the T6/C3 training session

```{r T6consistentconflict}
filtered <- behavior_slim %>% filter(TrainSessionCombo == "T6_C3", APA != "control") 
exp_factors <- as.data.frame(filtered[,1])
exp_nums <- filtered[,c(4:42)]
exp_factors$APA2 <- factor(filtered$APA2, levels = c("consistent", "conflict"))

for(y in names(exp_nums)){
  ymod<- wilcox.test(exp_nums[[y]] ~ exp_factors$APA2 )
  cat(paste('\nDependent var:', y, '\n'))
  print(ymod)
}

# Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1
# ***  
# **  PolarAvgVal,
# *   Speed1stEntr.cm.s. 
# .   PolarSdVal,   
#     Speed2, Speed1, AnnularKurtosis, AnnularSkewnes, AnnularSd,
#     AnnularAvg, AnnularMaxBin, AnnularMaxVal, AnnularMinBin, AnnularMinVal
#     Max50.RngHiBin, Max50.RngLoBin, PolarMaxBin, PolarMaxVal, Min50.RngHiBin   
#     Min50.RngLoBin, PolarMinBin, PolarMinVal, RayleigAngle, RayleigLength,
#     pTimeCW, pTimeOPP, pTimeCCW, pTimeTarget, TimeTarget, Speed2ndEntr, 
#     Path2ndEntr, Time2ndEntr, MaxTimeAvoid, NumShock, Dist1stEntr.m. 
#     Path1stEntr, Time1stEntr, NumEntrances, Linearity.Arena., SdevSpeedArena

par(mfrow=c(3,3))
for(y in names(exp_nums)){
  ymod <- boxplot(exp_nums[[y]] ~ exp_factors$APA2,
               main = y,
               xlab = "T6/C3")
}
```
## Number of shocks

The values in the column "NumShock" are actually measures of the number of entraces into the shock zone. Because, that's what the software records. For consistent and conflict animals, the number of shocks equals equals the number of entraces. However, for yoked individuals, the number of entrances does not equal the number of shocks. For them, the number of shocks is equal to their consistent or conflict trained partner. 

```{r ShocksEntrances}
# supset beahvior to keep only factors and num shocks
numshocks <- behavior %>%
  select(ID, TrainSessionCombo, APA2, NumShock) 

# widen datafram, and sum total
numshocks <- spread(numshocks, key=TrainSessionCombo, value= NumShock)
numshocks$sums <- rowSums(numshocks[sapply(numshocks, is.numeric)])

# copy datafram, add identifer
numentrances <- numshocks

# delete values for yoked animals
numshocks <- numshocks %>%
  filter(APA2 %in% c("consistent", "conflict")) %>%
  droplevels()

# create a tempdataframe with dupclicate values for yoked
numshockstemp <- numshocks
levels(numshockstemp$APA2) 
levels(numshockstemp$APA2) <- c("yoked\nconsistent","yoked\nconflict")
levels(numshockstemp$APA2) 

# combine the two and plot

realnumshocks <- rbind(numshocks, numshockstemp)
realnumshocks

realnumshocks$APA2 <- factor(realnumshocks$APA2, levels = c("yoked\nconsistent", "consistent", "yoked\nconflict", "conflict"))

a <- ggplot(realnumshocks, aes(x = APA2, y = sums, fill = APA2)) +
  geom_boxplot(outlier.size = 0.5) +
  theme_cowplot(font_size = 7, line_size = 0.25) +
  scale_fill_manual(values = colorvalAPA00,
                    name = NULL) +
  labs(x = NULL, subtitle = "Total shocks", y = "Counts") +
    theme(axis.text.x=element_text(angle=60, vjust = 1, hjust = 1),
          legend.position = "none")


numentrances$APA2 <- factor(numentrances$APA2, levels = c("yoked-consistent", "consistent", "yoked-conflict", "conflict"))
levels(numentrances$APA2) <- c("yoked\nconsistent", "consistent", "yoked\nconflict", "conflict")


b <- ggplot(numentrances, aes(x = APA2, y = sums, fill = APA2)) +
  geom_boxplot(outlier.size = 0.5) +
  theme_cowplot(font_size = 7, line_size = 0.25) +
  scale_fill_manual(values = colorvalAPA00,
                    name = NULL) +
  labs(x = NULL, subtitle = "Total entrances", y = "Counts") +
    theme(axis.text.x=element_text(angle=60, vjust = 1, hjust = 1),
          legend.position = "none")

shockentrplot <- plot_grid(a,b, labels = c("B", "C"), label_size = 7)

pdf(file="../figures/01_behavior/shockentrplot.pdf", width=3, height=2.1)
plot(shockentrplot)
dev.off()


summary(aov(numentrances$sums ~ numentrances$APA2))
summary(aov(realnumshocks$sums ~ realnumshocks$APA2))
```


```{r writefiles}
write.csv(behavior, file = "../data/01a_behavior.csv", row.names = FALSE)
write.csv(fourmeasures, file = "../data/01a_fourmeasures.csv", row.names = FALSE)
write.csv(scoresdf, file = "../data/01a_scoresdf.csv", row.names = FALSE)
write.csv(rotationdf, file = "../data/01a_rotationdf.csv", row.names = TRUE)
write.csv(behaviormatrix, file = "../data/01a_behaviormatrix.csv", row.names = TRUE)
```
