---
title: "Behavior Data Analysis"
output: md_document
---

This markdown file is used for behavioral data wrangling, statistical analysis, and data visualization. Figures from this analysis were assembled into this multi-panel plot using Adobe Illustrator. Files used to create the individual figures are saved in the data subdirectory with the prefix 01a.


## Setup

```{r setup, message=F}
## load libraries 
library(tidyverse) ## for respahing data
library(plyr) ## for renmaing factors
library(reshape2) ## for melting dataframe
library(cowplot) ## for some easy to use themes
library(ggfortify) # pca
library(factoextra)  ## pca with vectors
library(FactoMineR) # more pca
library(car) ## stats
library(pheatmap)  # for pretty heatmap
library(viridis) # for awesome color pallette
library(kableExtra) # for better markdown tables
library(ggpubr) # for stats on figures

## load user-written functions 
source("functions_behavior.R")
source("figureoptions.R")

## set output file for figures 
knitr::opts_chunk$set(fig.path = '../figures/01_behavior/')
```

## Sample sizes

The 'treatment' column describes the four behavioral treatment groups.  
The 'TrainSessionCombo' column describes the behvioral training sessions. Here I filter by a single session to calculte the number of mice. 

```{r wrangledata, message=F}
## import output from video tracker program 
behavior <- read.csv("../data/01_behaviordata.csv", header = T)

# rename to match RNAseq data, select useful variables
behavior <- behavior %>%
  mutate(treatment = fct_recode(APA2,
                                "standard.yoked" = "YokedSame",
                                "standard.trained" = "Same",
                                "conflict.yoked" = "YokedConflict",
                                "conflict.trained" = "Conflict")) %>%
  mutate(training = fct_collapse(treatment,
                                      trained = c("standard.trained", "conflict.trained"),
                                      yoked = c("standard.yoked", "conflict.yoked"))) %>%
  select(ID,Day,treatment, training,TrainSessionCombo,TrainSessionComboNum, ShockOnOff, PairedPartner,
         SdevSpeedArena:Speed2) %>%
  arrange(ID) 

## rename columns 
colnames(behavior)[colnames(behavior)=="pTimeTarget"] <- "pTimeShockZone"
colnames(behavior)[colnames(behavior)=="TimeTarget"] <- "TimeShockZone"


# set levels
behavior$treatment <- factor(behavior$treatment, levels = c("standard.yoked", "standard.trained",
                                                          "conflict.yoked", "conflict.trained"))
behavior$training <- factor(behavior$training, levels = c("yoked", "trained"))

# sample sizes
behavior %>% 
  filter(TrainSessionCombo == "Hab") %>%
  select(treatment)  %>%  summary()

head(behavior)
```

## Number of shocks

The values in the column "NumShock" are actually measures of the number of entraces into the shock zone. Because, that's what the software records. For standard.trained and conflict.trained animals, the number of shocks equals equals the number of entraces. However, for yoked individuals, the number of entrances does not equal the number of shocks. For them, the number of shocks is equal to their standard.trained or conflict.trained trained partner. 

```{r shockentrplot, width=3.5, height=2.45}
# supset beahvior to keep only factors and num shocks
numshocks <- behavior %>%
  select(ID, TrainSessionCombo, treatment, NumShock) 

# widen datafram, and sum total
numshocks <- spread(numshocks, key=TrainSessionCombo, value= NumShock)
numshocks$sums <- rowSums(numshocks[sapply(numshocks, is.numeric)])
head(numshocks)

# delete values for yoked animals
numshocks <- numshocks %>%
  filter(treatment %in% c("standard.trained", "conflict.trained")) %>%
  droplevels()

# create a tempdataframe with dupclicate values for yoked
numshockstemp <- numshocks
levels(numshockstemp$treatment) 
levels(numshockstemp$treatment) <- c("standard.yoked","conflict.yoked")
levels(numshockstemp$treatment) 

# combine the two and plot

realnumshocks <- rbind(numshocks, numshockstemp)
levels(realnumshocks$treatment) 

realnumshocks$treatment <- factor(realnumshocks$treatment, levels = c("standard.yoked", "standard.trained", "conflict.yoked", "conflict.trained"))
levels(realnumshocks$treatment) <- c("standard\nyoked", "standard\ntrained", "conflict\nyoked", "conflict\ntrained")

realnumshocks %>%
  dplyr::group_by(treatment) %>%
  dplyr::summarise(meanshocks = mean(sums, na.rm = TRUE))

# define what levels to compare for stats

a <- ggplot(realnumshocks, aes(x = treatment, y = sums, fill = treatment)) +
  geom_boxplot(outlier.size = 0.5) +
  theme_ms() +
  scale_fill_manual(values = colorvalAPA00,
                    name = NULL) +
  labs(x = "treatment", subtitle = " ", y = "Total Shocks") +
    theme(axis.text.x=element_text(angle=60, vjust = 1, hjust = 1),
          legend.position = "none") 
a
```

# Vizualizing Mean and Standard error for num entrace and time 1st entrance

To make the point and line graphs, I must create and join some data frames, then I have a function that makes four plots with specific titles, y labels and limits.

```{r fourmeasures, fig.width= 6.65, fig.height=2}
dfb <- behavior %>%
  dplyr::group_by(treatment, TrainSessionComboNum) %>%
  dplyr::summarise(m = mean(NumEntrances), 
                   se = sd(NumEntrances)/sqrt(length(NumEntrances))) %>%
  dplyr::mutate(measure = "Number of target zone entrances")

dfc <- behavior %>%
  dplyr::group_by(treatment, TrainSessionComboNum) %>%
  dplyr::mutate(minutes = Time1stEntr/60) %>%
  dplyr::summarise(m = mean(minutes), 
                   se = sd(minutes)/sqrt(length(minutes))) %>%
  dplyr::mutate(measure = "Time to 1st target zone entrance (min)")

dfd <- behavior %>%
  dplyr::group_by(treatment, TrainSessionComboNum) %>%
  dplyr::summarise(m = mean(pTimeShockZone), 
                   se = sd(pTimeShockZone)/sqrt(length(pTimeShockZone))) %>%
  dplyr::mutate(measure = "Proportion of time in target zone")

fourmeasures <- rbind(dfb,dfc,dfd)
head(fourmeasures)

# see https://cran.r-project.org/web/packages/cowplot/vignettes/shared_legends.html for share legends


b <- meansdplots(dfb, "NumEntrances" ,  c(0,10,20,30), c(0, 35)) + theme(legend.justification = "center")
c <- meansdplots(dfc, "Time1stEntr.m (min)",  c(0,2,4,6,8), c(0, 8))
d <- meansdplots(dfd, "pTimeShockZone", c(0,.12,.25,.37), c(0, .37 ))

fourplots <- plot_grid(a + theme(legend.position="none"),
           b + theme(legend.position="none"),
           c + theme(legend.position="none"),
           d + theme(legend.position="none"),
           #align = 'vh',
           labels = c("(a)", "(b)", "(c)", "(d)"),
           nrow = 1,
           label_size = 8
           )
fourplots
```



### Principle component analysis 

Next, I next reduced the dimentionality of the data with a PCA anlaysis. 

```{r PCA}
retention <- behavior %>% filter(TrainSessionCombo %in% c("Retention") ) %>% droplevels()

pcadf <- makepcadf(behavior)

pcadfretention <- pcadf %>% filter(TrainSessionComboNum == 9) %>% 
  group_by(treatment) %>% 
  dplyr::summarize(avePC1 = mean(PC1),
                   avePC2 = mean(PC2),
                   sePC1 = sd(PC1)/sqrt(length(PC1)),
                   sePC2 = sd(PC2)/sqrt(length(PC2)))
pcadfretention


e <- ggplot(pcadf, aes(x = PC1, y = PC2, color = treatment, fill = treatment)) +

  geom_point(data = pcadf, aes(alpha = TrainSessionComboNum)) + 
  geom_point(data = pcadfretention, aes(x = avePC1, y = avePC2), size = 4) +
  theme_ms() +
    scale_fill_manual(guide = 'none',values = colorvalAPA00) +
  scale_color_manual(guide = 'none',values = colorvalAPA00) +
  scale_alpha_continuous( breaks = c(1, 2, 3, 4, 5, 6, 7, 8, 9),
                       labels = c( "P", "T1", "T2", "T3",
                                   "Rt", "T4", "T5", "T6", "Rn")) +
  theme(legend.position = "none") +
  labs(y = "PC2: 9.7% variance explained", x = "PC1: 35.7% variance explained",
       subtitle = " ") 
e



# get contributions
df <- behavior %>% select(SdevSpeedArena:Speed2)
res.pca <- PCA(df,  graph = FALSE)
# Visualize eigenvalues/variances
fviz_screeplot(res.pca, addlabels = TRUE, ylim = c(0, 50))


# Contributions of variables to PC1
f <- fviz_contrib_rmh(res.pca, choice = "var", axes = 1, top = 8, 
                 ylab = "PC1 % contributions", xlab = "estimates of memory", subtitle = " ") +
  theme_ms() + theme(axis.text.x = element_text(angle=45, hjust = 1))
# Contributions of variables to PC2
g <- fviz_contrib_rmh(res.pca, choice = "var", axes = 2, top = 8, 
                 ylab = "PC2 % contributions" , xlab = "estimates of activity", subtitle = " ") +
  theme_ms() + theme(axis.text.x = element_text(angle=45, hjust = 1))

threeplots <- plot_grid(e,f,g, labels = c("(e)", "(f)", "(g)"),
           nrow = 1,
           label_size = 8,
          rel_widths = c(0.5,0.25,0.25))

threeplots
```

```{r behaviorfig, fig.width=7,fig.height=3.5}
behaviorfig <- plot_grid(fourplots, threeplots, nrow = 2)
behaviorfig

pdf(file="../figures/01_behavior/behaviorfig.pdf", width=7, height=3.5)
plot(behaviorfig)
dev.off()
```

```{r writefiles}
write.csv(behavior, file = "../data/01a_behavior.csv", row.names = FALSE)
write.csv(retention, file = "../data/01a_retention.csv", row.names = FALSE)
write.csv(fourmeasures, file = "../data/01a_fourmeasures.csv", row.names = FALSE)
write.csv(pcadf, file = "../data/01a_pcadf.csv", row.names = FALSE)
```
