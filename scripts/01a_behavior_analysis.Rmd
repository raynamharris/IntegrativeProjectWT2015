---
title: "Behavior Data Analysis"
output: md_document
---

This markdown file is used for behavioral data wrangling, statistical analysis, and data visualization. Figures from this analysis were assembled into this multi-panel plot using Adobe Illustrator. Files used to create the individual figures are saved in the data subdirectory with the prefix 01a.

<img src="../figures/figure_2.png" width="1370" />

## Setup

```{r setup, message=F}
## load libraries 
library(tidyr) ## for respahing data
library(plyr) ## for renmaing factors
library(dplyr) ## for filtering and selecting rows
library(reshape2) ## for melting dataframe
library(ggplot2) ## for awesome plots!
library(cowplot) ## for some easy to use themes
library(factoextra)  ##pca with vectors
library(car) ## stats
library(pheatmap)  # for pretty heatmap
library(viridis) # for awesome color pallette
library(kableExtra) # for better markdown tables

## load user-written functions 
source("functions_behavior.R")
source("figureoptions.R")

## set output file for figures 
knitr::opts_chunk$set(fig.path = '../figures/01_behavior/')
```

## Sample sizes

The 'APA2' column describes the four behavioral treatment groups.  
The 'TrainSessionCombo' column describes the behvioral training sessions. Here I filter by a single session to calculte the number of mice. 

```{r wrangledata, message=F}
## import output from video tracker program 
behavior <- read.csv("../data/01_behaviordata.csv", header = T)

## set level for APA2 then renmae
behavior$APA2 <- factor(behavior$APA2, levels = c("YokedSame", "Same", "YokedConflict","Conflict"))
levels(behavior$APA2) <-  c("yoked-consistent" ,"consistent", "yoked-conflict", "conflict")

# sample sizes
behavior %>% 
  filter(TrainSessionCombo == "Retention") %>%
  select(APA2)  %>%  summary()

# keep only relevant columns
behavior_slim <- behavior[,c(15,16,14,20:58)] 
```


# Vizualizing Mean and Standard error for num entrace and time 1st entrance

To make the point and line graphs, I must create and merge some data frames

```{r twobehaviors}
## number of entrances
meannumentr <- dplyr::summarise(group_by(behavior, APA2, TrainSessionComboNum), m = mean(NumEntrances), se = sd(NumEntrances)/sqrt(length(NumEntrances)))
meannumentr$APA2 <- factor(meannumentr$APA2, levels = c("yoked-consistent" ,"consistent", "yoked-conflict", "conflict"))

numentr <- ggplot(meannumentr, 
                  aes(x=, TrainSessionComboNum, y=m, color=APA2)) + 
    geom_errorbar(aes(ymin=m-se, ymax=m+se, color=APA2), width=.1) +
    geom_point(size = 2) +
   geom_line() +
  labs(subtitle = "A. Number of target zone entrances") +
   scale_y_continuous(name= "Counts") +
    scale_x_continuous(name= NULL, 
                       breaks = c(1, 2, 3, 4, 5, 6, 7, 8, 9),
                       labels = NULL) +
  theme_cowplot(font_size = 7, line_size = 0.25) +
  background_grid(major = "y", minor = "y") +
  scale_color_manual(values = colorvalAPA00)  +
  theme(legend.title=element_blank(),
        legend.position="none",
        legend.text=element_text(size=7)) 
numentr

pdf(file="../figures/01_behavior/numentr.pdf", width=2.55, height=2)
plot(numentr)
dev.off()

# time spent in target
target <- dplyr::summarise(group_by(behavior, APA2, TrainSessionComboNum), m = mean(pTimeTarget), se = sd(pTimeTarget)/sqrt(length(pTimeTarget)))
target$APA2 <- factor(target$APA2, levels = c("yoked-consistent" ,"consistent", "yoked-conflict", "conflict"))

tagetplot <- ggplot(target, 
                  aes(x=, TrainSessionComboNum, y=m, color=APA2)) + 
    geom_errorbar(aes(ymin=m-se, ymax=m+se, color=APA2), width=.1) +
    geom_point(size = 2) +
   geom_line() +
  labs(subtitle = "B. Time spent in the target zone") +
   scale_y_continuous(name= "Proportion",
                      breaks = c(0, .12, .25, .37)) +
    scale_x_continuous(name= NULL, 
                       breaks = c(1, 2, 3, 4, 5, 6, 7, 8, 9),
                       labels = NULL) +
  theme_cowplot(font_size = 7, line_size = 0.25) +
  background_grid(major = "y", minor = "y") +
  scale_color_manual(values = colorvalAPA00)  +
  theme(legend.title=element_blank(),
        legend.position="none",
        legend.text=element_text(size=7)) 
tagetplot

pdf(file="../figures/01_behavior/tagetplot.pdf", width=2.55, height=2)
plot(tagetplot)
dev.off()


## time first entrance
Time1Entr <- dplyr::summarise(group_by(behavior, APA2, TrainSessionComboNum), m = mean(Time1stEntr), se = sd(Time1stEntr)/sqrt(length(Time1stEntr)))
Time1Entr$APA2 <- factor(Time1Entr$APA2, levels = c("yoked-consistent" ,"consistent", "yoked-conflict", "conflict"))


timeentr <- ggplot(Time1Entr, 
                  aes(x=, TrainSessionComboNum, y=m, color=APA2)) + 
    geom_errorbar(aes(ymin=m-se, ymax=m+se, color=APA2), width=.1) +
    geom_point(size = 2) +
   geom_line() +
  labs(subtitle = "C. Time to first entrance into the target zone") +
   scale_y_continuous(name= "Time (s)") +
    scale_x_continuous(name= "Training session", 
                       breaks = c(1, 2, 3, 4, 5, 6, 7, 8, 9),
                       labels = c( "P", "T1", "T2", "T3",
                                   "Rt", "T4", "T5", "T6", "Rn")) +
  theme_cowplot(font_size = 7, line_size = 0.25) +
  background_grid(major = "y", minor = "y") +
  scale_color_manual(values = colorvalAPA00)  +
  theme(legend.title=element_blank(),
        legend.position="none", 
        legend.text=element_text(size=5)) 

timeentr

pdf(file="../figures/01_behavior/time1entr.pdf", width=2.55, height=2.25)
plot(timeentr)
dev.off()

### Propostion of time in opposite zone
timeopp <- dplyr::summarise(group_by(behavior, APA2, TrainSessionComboNum), m = mean(pTimeOPP), se = sd(pTimeOPP)/sqrt(length(pTimeOPP)))
timeopp$APA2 <- factor(timeopp$APA2, levels = c("yoked-consistent" ,"consistent", "yoked-conflict", "conflict"))


timeoppplot <- ggplot(timeopp, 
                  aes(x=, TrainSessionComboNum, y=m, color=APA2)) + 
    geom_errorbar(aes(ymin=m-se, ymax=m+se, color=APA2), width=.1) +
    geom_point(size = 2) +
   geom_line() +
  labs(subtitle = "D. Time spent opposite the target zone") +
   scale_y_continuous(name= "Proportion",
                     breaks = c(0, .25, .5, .75),
                     limits = c(0,.75)) +
    scale_x_continuous(name= "Training session", 
                       breaks = c(1, 2, 3, 4, 5, 6, 7, 8, 9),
                       labels = c( "P", "T1", "T2", "T3",
                                   "Rt", "T4", "T5", "T6", "Rn")) +
  theme_cowplot(font_size = 7, line_size = 0.25) +
  background_grid(major = "y", minor = "y") +
  scale_color_manual(values = colorvalAPA00)  +
  theme(legend.title=element_blank(),
        legend.position="none", 
        legend.text=element_text(size=5)) 
timeoppplot

pdf(file="../figures/01_behavior/timeoppplot.pdf", width=2.55, height=2.25)
plot(timeoppplot)
dev.off()
```


## Proportion of time spent

Now let's look at how much time they spend in each proportion

```{r proptime}
proptime <- behavior_slim %>%
  dplyr::select(APA2, TrainSessionCombo, pTimeOPP, pTimeTarget, pTimeCCW, pTimeCW) %>%
  tidyr::gather(quadrant, proportion, -APA2, -TrainSessionCombo)

proptime$quadrant <- as.factor(proptime$quadrant)
proptime$quadrant <- factor(proptime$quadrant, levels = c("pTimeTarget", "pTimeCCW", "pTimeOPP", "pTimeCW"))
proptime$TrainSessionCombo <- factor(proptime$TrainSessionCombo, 
                                     levels = c("Hab" ,"T1", "T2", "T3", "Retest", 
                                                "T4_C1", "T5_C2", "T6_C3","Retention"))

timespent1 <- proptime %>%
  ggplot(aes(x = TrainSessionCombo, y = proportion, fill = quadrant)) + 
  geom_bar(position = "fill",stat = "identity")  +
  facet_wrap(~APA2, nrow=2) +
  theme_cowplot(font_size = 7, line_size = 0.25) +  
  theme(legend.title=element_blank(),
        legend.position="bottom",
        legend.text=element_text(size=7),
        strip.background = element_blank(),
        strip.text = element_text(face = "bold")) +
  scale_y_continuous(name= "Proportion",
                     breaks = c(0.25,0.50, 0.75)) +
  scale_x_discrete(name="Training Session", 
                     labels = c( "P", "T1", "T2", "T3",
                                   "Rt", "C1", "C2","C3", 
                                   "Rn")) +
  scale_fill_manual(values = c("#f03b20", "#e5f5e0" ,"#a1d99b", "#31a354"),
                     labels=c("Target zone", "Counter-clockwise zone", "Opposite zone", "Clockwise zone")) + 
  geom_hline(yintercept=c(0.25,0.50, 0.75), color="black" , 
             linetype="dashed",line_size = 0.25) +
  labs(subtitle = "Propotion of time spent in each quadrant") 
timespent1

pdf(file="../figures/01_behavior/timespent1.pdf",  width=4.25, height=4)
plot(timespent1)
dev.off()

meanproplong <- proptime %>%
  filter(TrainSessionCombo != "Hab") %>%
  group_by(APA2, quadrant) %>%
  summarize(mean_prop = mean(proportion)) 
meanproplong$mean_prop <- round(meanproplong$mean_prop,2)
head(meanproplong)

summary(aov(data = meanproplong, mean_prop ~ APA2*quadrant))

meanpropwide <- spread(meanproplong, quadrant, mean_prop)
kable(meanpropwide)
```

## Hierarchical clusering of time series behavioral data

Here I use heirarhical cluster to identify patterns in the behavioral data. On the y axis see three distinct clusters of behaviors that are 1) higher in trained animals, 2) higher in yoked animals, and 3) measures of speed. 

```{r pheatmap2,  message=FALSE}
## create scaled data frame
behavior_slim_heat <- behavior_slim %>%
  filter(TrainSessionCombo != "Hab")

behavior_slim_heat$RayleigAngle <- NULL
behavior_slim_heat$PolarMinBin <- NULL
scaledaveragedata <- as.data.frame(makescaledaveragedata(behavior_slim_heat))

## make annotation df and ann_colors for pheatmap
ann_cols <- as.data.frame(makecolumnannotations(scaledaveragedata))
ann_colors = ann_colors_APA2

# set color breaks
paletteLength <- 30
myBreaks <- c(seq(min(scaledaveragedata), 0, length.out=ceiling(paletteLength/2) + 1), 
              seq(max(scaledaveragedata)/paletteLength, max(scaledaveragedata), length.out=floor(paletteLength/2)))

## pheatmap for markdown
pheatmap(scaledaveragedata, show_colnames=T, show_rownames = T,
         annotation_col=ann_cols, 
         annotation_colors = ann_colors,
         treeheight_row = 0, treeheight_col = 50,
         border_color = "grey60" ,
         color = viridis(30),
         clustering_method="average",
         breaks=myBreaks,
         clustering_distance_cols="correlation" ,
         clustering_distance_rows = "correlation"
         )

# pheatmapfor adobe
pheatmap(scaledaveragedata, show_colnames=F, show_rownames = F,
         annotation_col=ann_cols, annotation_colors = ann_colors,
         annotation_names_col = F,
         treeheight_row = 0, treeheight_col = 15,
         fontsize = 6, 
         border_color = "grey60" ,
         color = viridis(30),
          width = 3, height = 2,
         clustering_method="average",
         breaks=myBreaks,
         clustering_distance_cols="correlation",
         filename = "../figures/01_behavior/pheatmap2.pdf",
         legend = TRUE,
         annotation_legend = FALSE
         )

```


### Principle component analysis 

Next, I next reduced the dimentionality of the data with a PCA anlaysis. 

```{r PCA}
dataforpca <- behavior %>%
  filter(TrainSessionCombo != "Hab")

longdata <- makelongdata(dataforpca)

Z <- longdata[,3:322]
Z <- Z[,apply(Z, 2, var, na.rm=TRUE) != 0]
pc = prcomp(Z, scale.=TRUE)
loadings <- pc$rotation
scores <- pc$x

scoresdf <- makepcadf(dataforpca) #create the df of pcas
rotationdf <- mkrotationdf(dataforpca) #loadings for specific factors

behaviormatrix <- behavior[c(20:58)]  # for 2nd pca analysis
scoresdf$PC1 <- scoresdf$PC1 * -1
scoresdf$APA2 <- factor(scoresdf$APA2, levels = c("yoked-consistent" ,"consistent", "yoked-conflict", "conflict"))


## data wraningly for pca anlysis
behaviormatrix %>% 
  scale() %>%                 # scale to 0 mean and unit variance
  prcomp() ->                 # do PCA
  pca                         # store result as `pca`
percent <- round(100*pca$sdev^2/sum(pca$sdev^2),2)
perc_data <- data.frame(percent=percent, PC=1:length(percent))
res.pca <- prcomp(behaviormatrix,  scale = TRUE)

# plot of percent contribution
ggplot(perc_data, aes(x=PC, y=percent)) + 
  geom_bar(stat="identity") + 
  geom_text(aes(label=round(percent, 2)), size=4, vjust=-.5) + 
  xlim(0, 10)


## print anova and TukeyHSD stats for first 6 PCs
j <- 0
for (i in (scoresdf[,c(1:6)])){
  j <- j+1
  print(paste("PC", j, sep = " "))
  myaov <- aov(i ~ APA2, data=scoresdf)
  print(summary(myaov))
  print(TukeyHSD(myaov, which = "APA2"))
}

pca12elipse <- ggplot(scoresdf, aes(PC1,PC2, color=APA2)) +
    geom_point(size=2.5, alpha = 0.7) +
    xlab(paste0("PC 1: ", percent[1],"% variance")) +
    ylab(paste0("PC 2: ", percent[2],"% variance")) +
    stat_ellipse(level = 0.95, (aes(color=APA2)),size=0.25) + 
    scale_colour_manual(values=c(colorvalAPA00)) + 
    theme_cowplot(font_size = 7, line_size = 0.25) +
    theme(legend.position="none") 
pca12elipse

pdf(file="../figures/01_behavior/pca12elipse.pdf",  width=2, height=2)
plot(pca12elipse)
dev.off()

pcalegend <- ggplot(scoresdf, aes(PC1,PC2, color=APA2)) +
    geom_point(size=2.5, alpha = 0.7) +
    xlab(paste0("PC 1: ", percent[1],"% variance")) +
    ylab(paste0("PC 2: ", percent[2],"% variance")) +
    stat_ellipse(level = 0.95, (aes(color=APA2)),size=0.25) + 
    scale_colour_manual(values=c(colorvalAPA00)) + 
    theme_cowplot(font_size = 7, line_size = 0.25) +
    theme(legend.position="bottom",
          legend.title=element_blank()) 
pcalegend

pdf(file="../figures/01_behavior/pcalegend.pdf",  width=4, height=2)
plot(pcalegend)
dev.off()

# PCA with contributions
res.pca <- prcomp(behaviormatrix, scale = TRUE)
fviz_pca_var(res.pca,
             col.var = "contrib", # Color by contributions to the PC
             gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
             repel = TRUE,     # Avoid text overlapping
             select.var = list(contrib = 8))
```

### Comparing Consistent and Conflict behaviors during the T4/C1 training session

```{r T4consistentconflict}
filtered <- behavior_slim %>% filter(TrainSessionCombo == "T4_C1", APA != "control") 
exp_factors <- as.data.frame(filtered[,1])
exp_nums <- filtered[,c(4:42)]
exp_factors$APA2 <- factor(filtered$APA2, levels = c("consistent", "conflict"))

# Levene's test for normality
#for(y in names(exp_nums)){
#  ymod <- leveneTest(exp_nums[[y]] ~ exp_factors$APA2)
#  cat(paste('\nDependent var:', y, '\n'))
#  print(ymod)
#}

# Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1
# *** Speed1, Path2ndEntr, Time2ndEntr, Path2ndEntr, Time2ndEntr
# ** Path1stEntr, Time1stEntr
# *  Max50.RngHiBin ,  PolarMaxBin  , PolarMinVal, RayleigAngle, pTimeCW, pTimeOPP,
# .  Speed2, Min50.RngLoBin , TimeTarget, NumShock, NumEntrances
#    AnnularKurtosis, AnnularSkewnes, AnnularSd, AnnularMaxBin, AnnularMaxVal, AnnularMinBin, AnnularMinVal, Max50.RngLoBin, RayleigLength PolarMaxVal, Min50.RngHiBin , PolarMinBin, PolarSdVal, PolarAvgVal, RayleigLength, pTimeTarget, Speed2ndEntr, MaxTimeAvoid, Dist1stEntr.m, Speed1stEntr.cm.s, Linearity.Arena, SdevSpeedArena

for(y in names(exp_nums)){
  ymod <- wilcox.test(exp_nums[[y]] ~ exp_factors$APA2 )
  cat(paste('\nDependent var:', y, '\n'))
  print(ymod)
}

# *** Path2ndEntr 
# **  Speed2, PolarMinVal, pTimeOPP, pTimeTarget, TimeTarget, Time2ndEntr, NumShock
# **  Dist1stEntr.m., Path1stEntr , Time1stEntr, NumEntrances
# *   PolarSdVal, PolarAvgVal 
# .    
#     Speed1, AnnularKurtosis, AnnularSkewnes, AnnularSd, AnnularAvg, AnnularMaxBin,
#     AnnularMaxVal, AnnularMinBin, AnnularMinVal, Max50.RngHiBin , PolarMaxBin, 
#     PolarMaxVal, Min50.RngHiBin, Min50.RngLoBin, PolarMinBin, RayleigAngle
#     RayleigLength, pTimeCW, pTimeCCW, Speed2ndEntr, MaxTimeAvoid, Speed1stEntr.cm.s., #     Linearity.Arena., SdevSpeedArena 
 
par(mfrow=c(3,3))
for(y in names(exp_nums)){
  ymod <- boxplot(exp_nums[[y]] ~ exp_factors$APA2,
               main = y,
               xlab = "T4/C1")
}
```

### Comparing Consistent and Conflict behaviors during the T6/C3 training session

```{r T6consistentconflict}
filtered <- behavior_slim %>% filter(TrainSessionCombo == "T6_C3", APA != "control") 
exp_factors <- as.data.frame(filtered[,1])
exp_nums <- filtered[,c(4:42)]
exp_factors$APA2 <- factor(filtered$APA2, levels = c("consistent", "conflict"))

for(y in names(exp_nums)){
  ymod<- wilcox.test(exp_nums[[y]] ~ exp_factors$APA2 )
  cat(paste('\nDependent var:', y, '\n'))
  print(ymod)
}

# Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1
# ***  
# **  PolarAvgVal,
# *   Speed1stEntr.cm.s. 
# .   PolarSdVal,   
#     Speed2, Speed1, AnnularKurtosis, AnnularSkewnes, AnnularSd,
#     AnnularAvg, AnnularMaxBin, AnnularMaxVal, AnnularMinBin, AnnularMinVal
#     Max50.RngHiBin, Max50.RngLoBin, PolarMaxBin, PolarMaxVal, Min50.RngHiBin   
#     Min50.RngLoBin, PolarMinBin, PolarMinVal, RayleigAngle, RayleigLength,
#     pTimeCW, pTimeOPP, pTimeCCW, pTimeTarget, TimeTarget, Speed2ndEntr, 
#     Path2ndEntr, Time2ndEntr, MaxTimeAvoid, NumShock, Dist1stEntr.m. 
#     Path1stEntr, Time1stEntr, NumEntrances, Linearity.Arena., SdevSpeedArena

par(mfrow=c(3,3))
for(y in names(exp_nums)){
  ymod <- boxplot(exp_nums[[y]] ~ exp_factors$APA2,
               main = y,
               xlab = "T6/C3")
}
```

```{r writefiles}
write.csv(behavior, file = "../data/01a_behavior.csv", row.names = FALSE)
write.csv(meannumentr, file = "../data/01a_meannumentr.csv", row.names = FALSE)
write.csv(Time1Entr, file = "../data/01a_Time1Entr.csv", row.names = FALSE)
write.csv(scoresdf, file = "../data/01a_scoresdf.csv", row.names = FALSE)
write.csv(rotationdf, file = "../data/01a_rotationdf.csv", row.names = TRUE)
write.csv(behaviormatrix, file = "../data/01a_behaviormatrix.csv", row.names = TRUE)
```
