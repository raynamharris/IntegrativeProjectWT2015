---
title: "Differential Gene Expression Analysis of Subfields"
output: md_document
---

## Subfield analysis

This script is used to identify treatement differences within each subfield, generate volcano plots, venn diagrams, and tables for subsequent GO analyses. The final mutlipanel figures for the manuscript have been inserted just below the subheadings. 

```{r setup, message=F, warning=F}
library(tidyverse)
library(cowplot) ## for some easy to use themes
library(DESeq2) ## for gene expression analysis
library(png)
library(grid)

library(BiocParallel)
register(MulticoreParam(6))

## load functions 
source("figureoptions.R")
source("functions_RNAseq.R")

## set output file for figures 
knitr::opts_chunk$set(fig.path = '../figures/03_rnaseqSubfield/', cache = T)
```

## Get varience stabilized gene expression for each tissue

```{r DGdeseq}
# count data
countData <- read.csv("../data/00_countData.csv", header = T, check.names = F, row.names = 1)

# prep col data
colData <- read.csv("../data/00_colData.csv", header = T)
colData$training <- factor(colData$training, levels = levelstraining)
colData$treatment <- factor(colData$treatment, levels = levelstreatment)

# DEGs with looking at all four treatments individually
DGdds <- returnddstreatment("DG") 
CA3dds <- returnddstreatment("CA3") 
CA1dds <- returnddstreatment("CA1") 

# DEGs with looking at all grouped trained and yoked
DGdds2 <- returnddstraining("DG") 
CA3dds2 <- returnddstraining("CA3") 
CA1dds2 <- returnddstraining("CA1") 

savevsds(DGdds2, "../data/03_DG_vsdtraining.csv")
savevsds(CA3dds2, "../data/03_CA3_vsdtraining.csv")
savevsds(CA1dds2, "../data/03_CA1_vsdtraining.csv")
```

## Results to compare with volcano plots

```{r twowaycontrasts}
print("DG")
res_summary_subfield(DGdds2, c("training", "trained", "yoked"))
res_summary_subfield(DGdds, c("treatment", "conflict.trained", "standard.trained"))
res_summary_subfield(DGdds, c("treatment", "conflict.yoked", "standard.yoked"))

print("CA3")
res_summary_subfield(CA3dds2, c("training", "trained", "yoked"))
res_summary_subfield(CA3dds, c("treatment", "conflict.trained", "standard.trained"))
res_summary_subfield(CA3dds, c("treatment", "conflict.yoked", "standard.yoked"))

print("CA1")
res_summary_subfield(CA1dds2, c("training", "trained", "yoked"))
res_summary_subfield(CA1dds, c("treatment", "conflict.trained", "standard.trained"))
res_summary_subfield(CA1dds, c("treatment", "conflict.yoked", "standard.yoked"))
```

## Volcano plots

```{r DEGs}

# create data frame for making volcanos plots
DGa <- calculateDEGs(DGdds2, "DG", "training", "trained", "yoked") 
DGb <-  calculateDEGs(DGdds, "DG", "treatment", "conflict.trained", "standard.trained") 
DGc <-  calculateDEGs(DGdds, "DG", "treatment", "conflict.yoked", "standard.yoked") 

CA3a <- calculateDEGs(CA3dds2, "CA3", "training", "trained", "yoked") 
CA3b <-  calculateDEGs(CA3dds, "CA3", "treatment", "conflict.trained", "standard.trained") 
CA3c <-  calculateDEGs(CA3dds, "CA3", "treatment", "conflict.yoked", "standard.yoked") 

CA1a <- calculateDEGs(CA1dds2, "CA1", "training", "trained", "yoked") 
CA1b <-  calculateDEGs(CA1dds, "CA1", "treatment", "conflict.trained", "standard.trained") 
CA1c <-  calculateDEGs(CA1dds, "CA1", "treatment", "conflict.yoked", "standard.yoked") 

# save files where there are DEGs

saveDEGs(DGa, "DG", "trained", "yoked") 
saveDEGs(DGb, "DG", "conflict.trained", "standard.trained") 
saveDEGs(DGc, "DG", "conflict.yoked", "standard.yoked") 

saveDEGs(CA3a, "CA3", "trained", "yoked") 
saveDEGs(CA3b, "CA3", "conflict.trained", "standard.trained") 
saveDEGs(CA3c, "CA3", "conflict.yoked", "standard.yoked") 

saveDEGs(CA1a, "CA1", "trained", "yoked") 
saveDEGs(CA1b, "CA1", "conflict.trained", "standard.trained") 
saveDEGs(CA1c, "CA1", "conflict.yoked", "standard.yoked") 
```



```{r volcanos, fig.width=6.69, fig.height=6}
# volcano plots

p1 <- plot.volcano(DGa, volcano1, "214 DEGs") 
p2 <-  plot.volcano(DGb,volcano2, "0 DEGs") 
p3 <-  plot.volcano(DGc, volcano3, "3 DEGs") 

p4 <- plot.volcano(CA3a,  volcano1, "0 DEGs") 
p5 <-  plot.volcano(CA3b, volcano2, "0 DEGs") 
p6 <-  plot.volcano(CA3c, volcano3, "2 DEGs") 

p7 <- plot.volcano(CA1a,  volcano1, "16 DEGs") 
p8 <-  plot.volcano(CA1b, volcano2, "0 DEGs") 
p9 <-  plot.volcano(CA1c, volcano3, "917 DEGs") 


# plot grid
volcanos <- plot_grid(p1 + theme(legend.position = "none") + labs(y = "DG \n -log10(p-value)"),
                      p2 + theme(legend.position = "none"), 
                      p3 + theme(legend.position = "none"),
                      
                      p4 + theme(legend.position = "none") + labs(y = "CA3 \n -log10(p-value)"),
                      p5 + theme(legend.position = "none"), 
                      p6 + theme(legend.position = "none"), 
                      
                      p7  + labs( y = "CA1 \n -log10(p-value)", x = "log fold change"), 
                      p8 + labs(x = "log fold change"), 
                      p9 + labs(x = "log fold change"), 
                      
                      nrow = 3, 
                      rel_heights =  c(1,1,1.25) ,
                      rel_widths = c(1.2,1,1) ,
                      labels =  c("a", "d", "g",
                                  "b", "e", "h",
                                  "c", "f", "i"),
                      label_size = 8) 
volcanos

comparisons <- png::readPNG("../figures/00_schematics/figure_DEGcomparisons.png")

comparisons <- ggdraw() +  draw_image(comparisons, scale = 1)

circuit <- png::readPNG("../figures/00_schematics/figure_hippocircuit.png")
circuit <- ggdraw() +  draw_image(circuit, scale = 1)

volcanoscomparisons <- plot_grid(volcanos, comparisons, nrow = 2, rel_heights = c(1, 0.1))
volcanoscomparisonscircuit <- plot_grid(circuit, volcanoscomparisons, nrow = 1, rel_widths = c(0.1,1))
volcanoscomparisonscircuit

pdf(file="../figures/03_rnaseqSubfield/volcanos.pdf", width=6.69, height=6)
plot(volcanoscomparisonscircuit)    
dev.off()

pdf(file="../figures/figure_3.pdf", width=6.69, height=6)
plot(volcanoscomparisonscircuit)    
dev.off()
```


```{r citations}
citation("DESeq2") ## for gene expression analysis
citation("png")
citation("grid")
citation("BiocParallel")
````