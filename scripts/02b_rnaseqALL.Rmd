---
title: "02c_rnaseq_All"
author: "Rayna M Harris"
date: "2/12/19"
output: md_document
---

The figures made from this script were compiled in Adobe.

<img src="../figures/figures-02.png" width="1370" />

```{r setup, message=F}
library(ggplot2) ## for awesome plots!
library(cowplot) ## for some easy to use themes
library(dplyr) ## for filtering and selecting rows
library(car) ## stats
library(VennDiagram) ## venn diagrams
library(pheatmap) ## awesome heatmaps
library(viridis) # for awesome color pallette
library(reshape2) ## for melting dataframe
library(DESeq2) ## for gene expression analysis
library(edgeR)  ## for basic read counts status
library(magrittr) ## to use the weird pipe
library(genefilter)  ## for PCA fuction
library(ggrepel) ## for labeling volcano plot

## load functions 
source("figureoptions.R")
source("functions_RNAseq.R")

## set output file for figures 
knitr::opts_chunk$set(fig.path = '../figures/02b_RNAseqAll/')
```

## Design

The two two catagorical variables are

* Hippocampal subfield: DG, CA3, CA1
* Treatment: yoked_consistent, consistent, yoked_conflict, conflict


```{r data, message=F, warning=F}
colData <- read.csv("../data/02a_colData.csv", header = T)
countData <- read.csv("../data/02a_countData.csv", header = T, check.names = F, row.names = 1)
colData %>% select(APA2,Punch)  %>%  summary()
head(colData)


totalCounts=colSums(countData)
### on average 1 million gene counts per sample 
summary((colSums(countData)/1000000))

dds <- DESeqDataSetFromMatrix(countData = countData,
                              colData = colData,
                              design = ~ Punch + APA2 + Punch*APA2)

dds$Punch <- factor(dds$Punch, levels=c("DG","CA3", "CA1")) ## specify the factor levels
dds$APA2 <- factor(dds$APA2, levels=c("yoked_consistent", "consistent", "yoked_conflict" , "conflict")) ## specify the factor levels

dds # view the DESeq object - note numnber of genes
dds <- dds[ rowSums(counts(dds)) > 1, ]  # Pre-filtering genes with 0 counts
dds # view number of genes afternormalization and the number of samples
dds <- DESeq(dds) # Differential expression analysis
rld <- rlog(dds, blind=FALSE) ## log transformed data
vsd <- getVarianceStabilizedData(dds)
write.csv(vsd, file = "../data/02b_vsd.csv", row.names = T)
```

## this is for CA1 DG

```{r}
res <- results(dds, contrast =c("Punch", "CA1", "DG"), independentFiltering = T)
summary(res)
head((res[order(res$padj),]), 10)
```


## this is for CA1 CA3

```{r}
res <- results(dds, contrast =c("Punch", "CA1", "CA3"), independentFiltering = T)
summary(res)
head((res[order(res$padj),]), 10)
```

## this is for CA3 DG

```{r}
res <- results(dds, contrast =c("Punch", "CA3", "DG"), independentFiltering = T)
summary(res)
head((res[order(res$padj),]), 10)
```

## this is for consistent yoked-consistent

```{r}
res <- results(dds, contrast =c("APA2", "consistent", "yoked_consistent"), independentFiltering = T)
summary(res)
head((res[order(res$padj),]), 10)
```

## this is for consistent yoked-conflict yoked-consistent DG

```{r}
res <- results(dds, contrast =c("APA2", "yoked_conflict", "yoked_consistent"), independentFiltering = T)
summary(res)
head((res[order(res$padj),]), 10)
```

## this is for consistent-conflict vs yoked-conflict 

```{r}
res <- results(dds, contrast =c("APA2", "conflict", "yoked_conflict"), independentFiltering = T)
summary(res)
head((res[order(res$padj),]), 10)
```

## this is for consistent conflict yoked-conflict

```{r}
res <- results(dds, contrast =c("APA2", "conflict", "consistent"), independentFiltering = T)
summary(res)
head((res[order(res$padj),]), 10)
```

```{r heatmap_prep}
contrast1 <- resvals(contrastvector = c("Punch", "CA1", "DG"), mypval = 0.1) # 2765
contrast2 <- resvals(contrastvector = c("Punch", "CA1", "CA3"), mypval = 0.1) # 2165
contrast3 <- resvals(contrastvector = c("Punch", "CA3", "DG"), mypval = 0.1) # 2948
contrast4 <- resvals(contrastvector = c("APA2", "consistent", "yoked_consistent"), mypval = 0.1) #  114
contrast5 <- resvals(contrastvector = c("APA2", "conflict", "yoked_conflict"), mypval = 0.1) # 61
contrast6 <- resvals(contrastvector = c("APA2", "conflict", "consistent"), mypval = 0.1) # 1 or 0
contrast7 <- resvals(contrastvector = c("APA2", "yoked_conflict", "yoked_consistent"), mypval = 0.1) # 40
```

```{r heatmap}
DEGes <- assay(rld)
DEGes <- cbind(DEGes, contrast1, contrast2, contrast3, contrast4, contrast5, contrast6, contrast7)
DEGes <- as.data.frame(DEGes) # convert matrix to dataframe
DEGes$rownames <- rownames(DEGes)  # add the rownames to the dataframe
DEGes$padjmin <- with(DEGes, pmin(padjPunchCA1DG, padjPunchCA1CA3, padjPunchCA3DG, padjAPA2conflictconsistent, padjAPA2yoked_conflictyoked_consistent,padjAPA2conflictyoked_conflict, padjAPA2consistentyoked_consistent)) 
DEGes <- DEGes %>% filter(padjmin < 0.000000001)
rownames(DEGes) <- DEGes$rownames
drop.cols <-colnames(DEGes[,grep("padj|pval|rownames", colnames(DEGes))])
DEGes <- DEGes %>% dplyr::select(-one_of(drop.cols))
DEGes <- as.matrix(DEGes)
DEGes <- DEGes - rowMeans(DEGes)


df <- as.data.frame(colData(dds)[,c("APA2", "Punch")]) ## matrix to df
rownames(df) <- names(countData)
ann_colors <- ann_colors4 # see color options 
DEGes <- as.matrix(DEGes) 
paletteLength <- 30
myBreaks <- c(seq(min(DEGes), 0, length.out=ceiling(paletteLength/2) + 1), 
              seq(max(DEGes)/paletteLength, max(DEGes), length.out=floor(paletteLength/2)))

pheatmap(DEGes, show_colnames=T, show_rownames = F,
         annotation_col=df, annotation_colors = ann_colors,
         treeheight_row = 0, treeheight_col = 25,
         annotation_row = NA, 
         annotation_legend = FALSE,
         annotation_names_row = FALSE, annotation_names_col = FALSE,
         fontsize = 8, 
         border_color = "grey60" ,
         color = viridis(30),
         cellwidth = 6, 
         clustering_method="average",
         breaks=myBreaks,
         clustering_distance_cols="correlation" 
         )

pheatmap(DEGes, show_colnames=F, show_rownames = F,
         annotation_col=df, annotation_colors = ann_colors, 
         annotation_row = NA, 
         annotation_legend = FALSE,
         annotation_names_row = FALSE, 
         annotation_names_col = FALSE,
         treeheight_row = 0, treeheight_col = 25,
         fontsize = 8, 
         border_color = "grey60" ,
         color = viridis(30),
         height = 3.75, 
         width = 3.5,
         clustering_method="average",
         breaks=myBreaks,
         clustering_distance_cols="correlation", 
         filename = "../figures/02b_RNAseqALL/pheatmap1.pdf"
         )

```

## Principle component analysis

```{r pca, echo=F, message=F}
# create the dataframe using my function pcadataframe
pcadata <- pcadataframe(rld, intgroup=c("Punch","APA2"), returnData=TRUE)
percentVar <- round(100 * attr(pcadata, "percentVar"))
percentVar

pcadata$PunchAPA <- as.factor(paste(pcadata$Punch, pcadata$APA2, sep="_"))

summary(aov(PC1 ~ Punch, data=pcadata)) 
TukeyHSD((aov(PC1 ~ Punch, data=pcadata)), which = "Punch") 

summary(aov(PC2 ~ Punch, data=pcadata)) 
TukeyHSD((aov(PC2 ~ Punch, data=pcadata)), which = "Punch") 

summary(aov(PC3 ~ Punch, data=pcadata)) 
TukeyHSD((aov(PC3 ~ Punch, data=pcadata)), which = "Punch") 


summary(aov(PC3 ~ APA2, data=pcadata)) 
summary(aov(PC4 ~ APA2, data=pcadata)) 
summary(aov(PC5 ~ APA2, data=pcadata)) 
summary(aov(PC6 ~ APA2, data=pcadata)) 

pcadata$Punch <- factor(pcadata$Punch, levels=c("DG","CA3", "CA1"))
pcadata$APA2 <- factor(pcadata$APA2, levels=c("yoked_consistent","consistent",  "yoked_conflict","conflict"))

pcadata$wrap <- "Principal Component Analyses of Hippocampal Samples"


PCA12 <- ggplot(pcadata, aes(pcadata$PC1, pcadata$PC2, color=Punch)) +
    geom_point(size=3, aes(shape=APA2), alpha = 0.8) +
    xlab(paste0("PC1:", percentVar[1],"% variance")) +
    ylab(paste0("PC2:", percentVar[2],"% variance")) +
    #stat_ellipse(level = 0.95, (aes(color=Punch)),size=0.25) + 
    scale_colour_manual(values=c(colorvalPunch))+ 
    theme_cowplot(font_size = 8, line_size = 0.25)  +
    theme(legend.position="none") +
    scale_shape_manual(values=c(16, 1, 15, 0), aes(color=colorvalPunch))
PCA12

pdf(file="../figures/02b_RNAseqAll/PCA12.pdf", width=1.75, height=2.25)
plot(PCA12)
dev.off()

```

# Number of differentially expressed genes per two-way contrast

## venn diagrams

```{r venndiagram_prep}
# uses contrast 1-6 from heat map prep

rldpadjs <- assay(rld)
rldpadjs <- cbind(rldpadjs, contrast1, contrast2, contrast3, contrast4, contrast5, contrast6)
rldpadjs <- as.data.frame(rldpadjs)
rldpadjs <- rldpadjs[ , grepl( "padj" , names( rldpadjs ) ) ]

venn1 <- row.names(rldpadjs[rldpadjs[1] <0.05 & !is.na(rldpadjs[1]),]) 
venn2 <- row.names(rldpadjs[rldpadjs[2] <0.05 & !is.na(rldpadjs[2]),]) 
venn3 <- row.names(rldpadjs[rldpadjs[3] <0.05 & !is.na(rldpadjs[3]),]) 
venn4 <- row.names(rldpadjs[rldpadjs[4] <0.05 & !is.na(rldpadjs[4]),]) 
venn5 <- row.names(rldpadjs[rldpadjs[5] <0.05 & !is.na(rldpadjs[5]),]) 
venn6 <- row.names(rldpadjs[rldpadjs[6] <0.05 & !is.na(rldpadjs[6]),]) 

candidates1 <- list("CA1-DG" = venn1, "CA3-DG" = venn3, "CA1-CA3" = venn2) 
candidates2 <- list("Yoked-Consistent" = venn4, "Yoked-Conflict" = venn5, "Yoked-Yoked" = venn6)

prettyvenn <- venn.diagram(
  scaled=T,
  x = candidates1, filename=NULL, 
  col = "black",
  alpha = 0.5,
  cex = 1, fontfamily = "sans", #fontface = "bold",
  cat.default.pos = "text",
  cat.cex = 1, cat.fontfamily = "sans")
#dev.off()
grid.draw(prettyvenn)

```

```{r venndiagram}
prettyvenn <- venn.diagram(
  scaled=T,
  x = candidates2, filename=NULL, 
  col = "black",
  alpha = 0.5,
  cex = 1, fontfamily = "sans", #fontface = "bold",
  cat.default.pos = "text",
  cat.cex = 1, cat.fontfamily = "sans")
#dev.off()
grid.draw(prettyvenn)
```

## Volcanos plots and and gene lists

### ca3 dg

```{r volcanoCA3GDG}
res <- results(dds, contrast =c("Punch", "CA3", "DG"), independentFiltering = T, alpha = 0.1)
summary(res)
resOrdered <- res[order(res$padj),]
head(resOrdered, 10)
data <- data.frame(gene = row.names(res), pvalue = -log10(res$padj), lfc = res$log2FoldChange)
data <- na.omit(data)
head(data)

summary(log10(data$pvalue +1))

data <- data %>%
  mutate(color = ifelse(data$lfc > 0 & data$pvalue > 1.3, 
                        yes = "CA3", 
                        no = ifelse(data$lfc < 0 & data$pvalue > 1.3, 
                                    yes = "DG", 
                                    no = "none")))
top_n(data, n = 5, wt = lfc)
top_n(data, n = 5, wt = pvalue)
data$logp <- log10(data$pvalue +1 )

colored <- ggplot(data, aes(x = lfc, y = pvalue)) + 
  geom_point(aes(color = factor(color)), size = 0.5, alpha = 0.5, na.rm = T) + 
  theme(legend.position = "none") + # remove legend 
  scale_color_manual(values = c("CA3" = "#1b9e77",
                                "DG" = "#d95f02", 
                                "none" = "#d9d9d9")) + 
  theme_cowplot(font_size = 8, line_size = 0.25) +
  geom_hline(yintercept = 1.3,  size = 0.25, linetype = 2) + 
  scale_y_continuous(limits=c(0, 40)) +
  scale_x_continuous( limits=c(-10, 10)) +
  xlab(paste0("CA3 / DG")) +
  ylab(paste0("log10 p-value")) +       
  theme(panel.grid.minor=element_blank(),
        legend.position = "none", # remove legend 
        panel.grid.major=element_blank())
colored

pdf(file="../figures/02b_RNAseqAll/AllDGCA3.pdf", width=1.75, height=2.25)
plot(colored)
dev.off()
```

### DG CA1

```{r volcanoCA1DG, include=T}

res <- results(dds, contrast =c("Punch", "CA1", "DG"), independentFiltering = T, alpha = 0.1)
summary(res)
resOrdered <- res[order(res$padj),]
head(resOrdered, 10)

data <- data.frame(gene = row.names(res), pvalue = -log10(res$padj), lfc = res$log2FoldChange)
data <- na.omit(data)
head(data)

data <- data.frame(gene = row.names(res), pvalue =  -log10(res$pvalue), lfc = res$log2FoldChange)
data <- na.omit(data)
head(data)

data <- data %>%
  mutate(color = ifelse(data$lfc > 0 & data$pvalue > 1.3, 
                        yes = "CA1", 
                        no = ifelse(data$lfc < 0 & data$pvalue >1.3, 
                                    yes = "DG", 
                                    no = "none")))
top_labelled <- top_n(data, n = 5, wt = lfc)
head(data)

colored <- ggplot(data, aes(x = lfc, y = pvalue)) + 
  geom_point(aes(color = factor(color)), size = 0.25, alpha = 0.5, na.rm = T) + # add gene points
  scale_color_manual(values = c("CA1" = "#7570b3",
                                "DG" = "#d95f02", 
                                "none" = "#d9d9d9")) + 
  theme_cowplot(font_size = 8, line_size = 0.25) +
  geom_hline(yintercept = 1.3,  size = 0.25, linetype = 2) + 
  scale_y_continuous(limits=c(0, 40)) +
  scale_x_continuous( limits=c(-10, 10)) +
  xlab(paste0("CA1 / DG")) +
  ylab(paste0("log10 p-value")) +       
  theme(panel.grid.minor=element_blank(),
        legend.position = "none", # remove legend 
        panel.grid.major=element_blank())
colored

pdf(file="../figures/02b_RNAseqAll/AllCA1DG.pdf", width=1.75, height=2.25)
plot(colored)
dev.off()
```

### ca1 ca3

```{r volcanoca1ca3}
res <- results(dds, contrast =c("Punch", "CA1", "CA3"), independentFiltering = T, alpha = 0.1)
summary(res)
resOrdered <- res[order(res$padj),]
head(resOrdered, 10)
data <- data.frame(gene = row.names(res), pvalue = -log10(res$padj), lfc = res$log2FoldChange)
data <- na.omit(data)
head(data)

data <- data %>%
  mutate(color = ifelse(data$lfc > 0 & data$pvalue > 1.3, 
                        yes = "CA1", 
                        no = ifelse(data$lfc < 0 & data$pvalue > 1.3, 
                                    yes = "CA3", 
                                    no = "none")))
top_n(data, n = 5, wt = lfc)
top_n(data, n = 5, wt = pvalue)

colored <- ggplot(data, aes(x = lfc, y = pvalue)) + 
  geom_point(aes(color = factor(color)), size = 0.25, alpha = 0.5, na.rm = T) + # add gene points
  theme_bw(base_size = 8) + # clean up theme
  theme(legend.position = "none") + # remove legend 
  scale_color_manual(values = c("CA1" = "#7570b3",
                                "CA3" = "#1b9e77", 
                                "none" = "#d9d9d9")) +  
  theme_cowplot(font_size = 8, line_size = 0.25) +
  geom_hline(yintercept = 1.3,  size = 0.25, linetype = 2) + 
  scale_y_continuous(limits=c(0, 40)) +
  scale_x_continuous( limits=c(-10, 10)) +
  xlab(paste0("CA1 / CA3")) +
  ylab(paste0("log10 p-value")) +       
  theme(panel.grid.minor=element_blank(),
        legend.position = "none", # remove legend 
        panel.grid.major=element_blank())
colored

pdf(file="../figures/02b_RNAseqAll/AllCA1CA3.pdf", width=1.75, height=2.25)
plot(colored)
dev.off()

```


## plot single gene counts

```{r Prkcz}
plotCounts(dds, "Prkcz", intgroup = "Punch", normalized = TRUE)
plotCounts(dds, "Prkcz", intgroup = "APA2", normalized = TRUE)
```

## Observed versus expected ration of DEGs

```{r stats}
# chisq.test equal expression of increased versus decreased expression
chisq.test(c(1099,	1427), p = c(0.45, 0.55))$expected
chisq.test(c(1099,	1427), p = c(0.45, 0.55))
prop.table(c(1099,	1427))

chisq.test(c(850,	1172), p = c(0.4, 0.6))$expected
chisq.test(c(850,	1172), p = c(0.4, 0.6))
prop.table(c(850,	1172))

chisq.test(c(1585,	1560), p = c(0.5, 0.5))$expected
chisq.test(c(1585,	1560), p = c(0.5, 0.5))
prop.table(c(1585,	1560))

chisq.test(c(1,	0), p = c(0.5, 0.5))$expected
chisq.test(c(1,	0), p = c(0.5, 0.5))
prop.table(c(1,	0))
```